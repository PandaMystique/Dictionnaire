<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="theme-color" content="#1a1610">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Dictionnaire de Philosophie</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600&family=Source+Serif+4:ital,opsz,wght@0,8..60,300;0,8..60,400;0,8..60,500;0,8..60,600;1,8..60,300;1,8..60,400;1,8..60,500&family=JetBrains+Mono:wght@300;400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400;1,600&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Lora:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #1a1610;
  --paper: #f5f0e8;
  --paper-warm: #efe9dd;
  --accent: #8b2500;
  --accent-light: #c4502a;
  --gold: #b8860b;
  --gold-light: #d4a843;
  --muted: #6b6358;
  --muted-light: #9e9588;
  --border: #d6cfc3;
  --border-light: #e5dfd5;
  --shadow: rgba(26, 22, 16, 0.08);
  --shadow-deep: rgba(26, 22, 16, 0.15);
  --serif: 'Cormorant Garamond', 'Georgia', serif;
  --body: 'Source Serif 4', 'Georgia', serif;
  --mono: 'JetBrains Mono', monospace;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-top: env(safe-area-inset-top, 0px);
  --tab-height: 60px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

/* Dark theme */
[data-theme="dark"] {
  --ink: #e8e2d8;
  --paper: #1a1810;
  --paper-warm: #22201a;
  --accent: #d4734a;
  --accent-light: #e8956a;
  --gold: #d4a843;
  --gold-light: #e8c86a;
  --muted: #9e9588;
  --muted-light: #6b6358;
  --border: #3a3630;
  --border-light: #2e2a24;
  --shadow: rgba(0, 0, 0, 0.3);
  --shadow-deep: rgba(0, 0, 0, 0.5);
}

[data-theme="dark"] body::before { opacity: 0.015; }
[data-theme="dark"] .header { background: #12110c; color: #c8c2b6; }
[data-theme="dark"] .sidebar { background: var(--paper); border-color: var(--border); }
[data-theme="dark"] .article-body blockquote { background: rgba(184, 134, 11, 0.08); }
[data-theme="dark"] .article-body h4 { color: #c8c2b6; border-left-color: var(--gold); }
[data-theme="dark"] .article-refs { background: rgba(139, 37, 0, 0.08); }
[data-theme="dark"] .article-source a { color: var(--accent-light); }
[data-theme="dark"] .article-body p,
[data-theme="dark"] .article-body li { color: #c8c2b6; }
[data-theme="dark"] .editor-preview .article-body p { color: #c8c2b6; }
[data-theme="dark"] .welcome { background: var(--paper-warm); }
[data-theme="dark"] .back-to-top { background: var(--accent); color: #1a1810; }
[data-theme="dark"] .back-to-top:hover { background: var(--accent-light); }
[data-theme="dark"] .immersive-exit { background: #22201a; border-color: #3a3630; color: #c8c2b6; }
[data-theme="dark"] .immersive-exit:hover { color: var(--accent); border-color: var(--accent); }
[data-theme="dark"] .progress-map { background: #2e2a24; }
[data-theme="dark"] .article-back-link:hover { background: rgba(212, 168, 67, 0.08); }
[data-theme="dark"] .mobile-tab-bar { background: #12110c; border-color: #2e2a24; }
[data-theme="dark"] .mobile-article-bar { background: #12110c; color: #c8c2b6; }
[data-theme="dark"] .mobile-back-btn { color: #c8c2b6; }
[data-theme="dark"] .mobile-back-btn:active { background: rgba(200,194,182,0.1); }
[data-theme="dark"] .mobile-bookmark-btn { color: #c8c2b6; }
[data-theme="dark"] .mobile-article-title { color: #c8c2b6; }
[data-theme="dark"] .drawer-panel { background: var(--paper); }
[data-theme="dark"] .drawer-panel-header { background: #12110c; color: #c8c2b6; }
[data-theme="dark"] .drawer-filter-chip { background: rgba(255,255,255,0.04); border-color: var(--border); color: var(--muted); }
[data-theme="dark"] .drawer-filter-chip.active { background: var(--accent); border-color: var(--accent); color: #1a1810; }
[data-theme="dark"] .mobile-quick-btn { background: rgba(255,255,255,0.04); border-color: var(--border); color: var(--muted); }
[data-theme="dark"] .mobile-fab { background: var(--accent); color: #1a1810; box-shadow: 0 4px 16px rgba(0,0,0,0.5); }
[data-theme="dark"] .import-panel { background: linear-gradient(135deg, rgba(212, 115, 74, 0.06), rgba(212, 168, 67, 0.06)); }
[data-theme="dark"] .import-btn { background: var(--accent); color: #1a1810; border-color: var(--accent); }
[data-theme="dark"] .import-btn:hover { background: var(--accent-light); }
[data-theme="dark"] .editor-help { background: rgba(212, 115, 74, 0.06); border-color: rgba(212, 115, 74, 0.12); }

html {
  font-size: 17px;
  scroll-behavior: smooth;
  -webkit-font-smoothing: antialiased;
}

body {
  font-family: var(--body);
  background: var(--paper);
  color: var(--ink);
  min-height: 100vh;
  line-height: 1.7;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  opacity: 0.03;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
}

/* ===== DESKTOP HEADER ===== */
.header {
  background: var(--ink);
  color: var(--paper);
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 20px var(--shadow-deep);
}

.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 2rem;
  border-bottom: 1px solid rgba(245, 240, 232, 0.1);
}

.logo {
  display: flex;
  align-items: baseline;
  gap: 0.75rem;
  cursor: pointer;
}

.logo-icon { font-size: 1.6rem; opacity: 0.7; }

.logo h1 {
  font-family: var(--serif);
  font-size: 1.5rem;
  font-weight: 300;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.logo h1 span { font-weight: 600; color: var(--gold-light); }

.header-stats {
  font-family: var(--mono);
  font-size: 0.65rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  opacity: 0.5;
}

.search-bar {
  padding: 0.6rem 2rem 0.8rem;
  display: flex;
  gap: 0.75rem;
  align-items: center;
}

.search-input-wrap {
  flex: 1;
  position: relative;
}

.search-input-wrap svg {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  opacity: 0.4;
  width: 16px; height: 16px;
  stroke: var(--paper);
}

#searchInput {
  width: 100%;
  padding: 0.6rem 1rem 0.6rem 2.75rem;
  background: rgba(245, 240, 232, 0.08);
  border: 1px solid rgba(245, 240, 232, 0.12);
  border-radius: 6px;
  color: var(--paper);
  font-family: var(--body);
  font-size: 0.9rem;
  outline: none;
  transition: all 0.3s ease;
}

#searchInput::placeholder { color: rgba(245, 240, 232, 0.35); font-style: italic; }
#searchInput:focus { background: rgba(245, 240, 232, 0.12); border-color: var(--gold-light); box-shadow: 0 0 0 3px rgba(212, 168, 67, 0.15); }

.filter-btn {
  padding: 0.5rem 1rem;
  background: rgba(245, 240, 232, 0.06);
  border: 1px solid rgba(245, 240, 232, 0.12);
  border-radius: 6px;
  color: var(--paper);
  font-family: var(--mono);
  font-size: 0.65rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.filter-btn:hover, .filter-btn.active {
  background: rgba(212, 168, 67, 0.15);
  border-color: var(--gold-light);
  color: var(--gold-light);
}

/* ===== ALPHABET NAV ===== */
.alpha-nav {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  padding: 0 2rem;
  background: rgba(245, 240, 232, 0.03);
  border-top: 1px solid rgba(245, 240, 232, 0.06);
}

.alpha-btn {
  padding: 0.5rem 0.55rem;
  background: none;
  border: none;
  color: rgba(245, 240, 232, 0.4);
  font-family: var(--serif);
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.alpha-btn:hover { color: var(--paper); }
.alpha-btn.has-entries { color: rgba(245, 240, 232, 0.7); }
.alpha-btn.active { color: var(--gold-light); }
.alpha-btn.active::after {
  content: '';
  position: absolute;
  bottom: 0; left: 25%; right: 25%;
  height: 2px;
  background: var(--gold-light);
  border-radius: 1px;
}

/* ===== MAIN LAYOUT ===== */
.main { display: flex; min-height: calc(100vh - 140px); }

.sidebar {
  width: 320px;
  min-width: 320px;
  background: var(--paper-warm);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  height: calc(100vh - 140px);
  position: sticky;
  top: 140px;
}

.sidebar-section {
  padding: 1.5rem;
  border-bottom: 1px solid var(--border-light);
}

.sidebar-section-title {
  font-family: var(--mono);
  font-size: 0.6rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--muted-light);
  margin-bottom: 0.75rem;
}

.entry-list { list-style: none; }

.entry-item {
  padding: 0.55rem 0.75rem;
  margin: 0 -0.75rem;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: baseline;
  gap: 0.75rem;
}

.entry-item:hover { background: rgba(139, 37, 0, 0.05); }
.entry-item.active { background: rgba(139, 37, 0, 0.08); }

.entry-letter {
  font-family: var(--serif);
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--accent);
  min-width: 1.5rem;
  opacity: 0.6;
}

.entry-name {
  font-family: var(--serif);
  font-size: 1rem;
  font-weight: 500;
  color: var(--ink);
  line-height: 1.3;
}

.entry-item.active .entry-name { color: var(--accent); font-weight: 600; }

.entry-category {
  font-family: var(--mono);
  font-size: 0.55rem;
  letter-spacing: 0.05em;
  color: var(--muted-light);
  text-transform: uppercase;
  display: block;
  margin-top: 0.15rem;
}

.letter-group-header {
  font-family: var(--serif);
  font-size: 2rem;
  font-weight: 300;
  color: var(--accent);
  padding: 1rem 0 0.25rem;
  border-bottom: 1px solid var(--border-light);
  margin-bottom: 0.5rem;
  opacity: 0.5;
}

/* ===== CONTENT AREA ===== */
.content {
  flex: 1;
  padding: 3rem 4rem;
  max-width: 800px;
  overflow-y: auto;
  height: calc(100vh - 140px);
}

.welcome {
  text-align: center;
  padding: 3rem 1.5rem 2rem;
  animation: fadeIn 0.6s ease;
  position: relative;
}

.welcome-ornament { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.25; }

.welcome h2 {
  font-family: var(--serif);
  font-size: 2.2rem;
  font-weight: 300;
  color: var(--ink);
  margin-bottom: 0.5rem;
}

.welcome h2 em { font-style: italic; font-weight: 500; color: var(--accent); }

.welcome p {
  font-size: 1rem;
  color: var(--muted);
  max-width: 440px;
  margin: 0 auto;
  line-height: 1.75;
}

/* welcome-stat classes removed - replaced by inline stats line */

/* Article */
.article { animation: slideIn 0.5s ease; }

@keyframes slideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.article-header {
  margin-bottom: 2.5rem;
  padding-bottom: 2rem;
  border-bottom: 1px solid var(--border);
}

.article-category {
  font-family: var(--mono);
  font-size: 0.6rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--accent);
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.article-category::before { content: ''; display: inline-block; width: 18px; height: 1px; background: var(--accent); }

.article-title {
  font-family: var(--serif);
  font-size: 3.2rem;
  font-weight: 300;
  line-height: 1.15;
  color: var(--ink);
  margin-bottom: 0.75rem;
}

.article-etymology { font-size: 0.95rem; font-style: italic; color: var(--muted); margin-bottom: 1rem; }

.article-definition {
  font-size: 1.15rem;
  line-height: 1.8;
  color: var(--ink);
  border-left: 3px solid var(--accent);
  padding-left: 1.5rem;
  margin-top: 1.5rem;
}

.article-body h3 {
  font-family: var(--serif);
  font-size: 1.6rem;
  font-weight: 500;
  margin: 2.5rem 0 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--border-light);
}

.article-body h4 {
  font-family: var(--serif);
  font-size: 1.2rem;
  font-weight: 600;
  margin: 1.8rem 0 0.75rem;
  padding-left: 0.75rem;
  border-left: 3px solid var(--gold-light);
  color: var(--ink);
}

.article-body p {
  margin-bottom: 1.25rem;
  line-height: 1.85;
  font-size: 1rem;
  color: #2a261e;
  text-align: justify;
  hyphens: auto;
  -webkit-hyphens: auto;
  hyphenate-limit-chars: 6 3 2;
  -webkit-hyphenate-limit-chars: 6 3 2;
  overflow-wrap: break-word;
  word-break: break-word;
  text-indent: 1.5em;
}

.article-body h3 + p,
.article-body h4 + p,
.article-body blockquote + p,
.article-body .toc-mobile-toggle + p,
.article-body > p:first-of-type {
  text-indent: 0;
}

/* Lettrine */
.lettrine {
  font-family: var(--serif);
  float: left;
  font-size: 3.4em;
  line-height: 0.78;
  padding-right: 0.08em;
  padding-top: 0.04em;
  margin-top: 0.02em;
  color: var(--accent);
  font-weight: 600;
}

.article-body blockquote {
  margin: 1.5rem 0;
  padding: 1.25rem 1.5rem;
  background: var(--paper-warm);
  border-left: 3px solid var(--gold);
  border-radius: 0 6px 6px 0;
  font-style: italic;
  color: var(--muted);
  font-size: 0.95rem;
  line-height: 1.8;
}

.article-body blockquote cite {
  display: block;
  margin-top: 0.5rem;
  font-style: normal;
  font-family: var(--mono);
  font-size: 0.65rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--muted-light);
}

.article-tags {
  margin-top: 2.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border);
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.article-tag {
  padding: 0.3rem 0.75rem;
  background: rgba(139, 37, 0, 0.06);
  border: 1px solid rgba(139, 37, 0, 0.12);
  border-radius: 20px;
  font-family: var(--mono);
  font-size: 0.6rem;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  color: var(--accent);
  cursor: pointer;
  transition: all 0.2s;
}

.article-tag:hover { background: rgba(139, 37, 0, 0.12); border-color: var(--accent); }

.article-refs {
  margin-top: 2rem;
  padding: 1.5rem;
  background: var(--paper-warm);
  border-radius: 8px;
  border: 1px solid var(--border-light);
}

.article-refs h4 {
  font-family: var(--mono);
  font-size: 0.6rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--muted-light);
  margin-bottom: 0.75rem;
}

.article-refs p { font-size: 0.85rem; color: var(--muted); line-height: 1.7; margin-bottom: 0.4rem; }

.article-source { margin-top: 2rem; text-align: right; }

.article-source a {
  font-family: var(--mono);
  font-size: 0.6rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--accent);
  text-decoration: none;
  border-bottom: 1px solid rgba(139, 37, 0, 0.3);
  padding-bottom: 0.1rem;
}

/* ===== ARTICLE PREV/NEXT NAV ===== */

/* Breadcrumb */
.article-edit-top {
  position: absolute; top: 0; right: 0;
  width: 32px; height: 32px; border-radius: 6px;
  border: 1px solid var(--border-light); background: transparent;
  color: var(--muted-light); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; opacity: 0.5;
}
.article-edit-top:hover { opacity: 1; border-color: var(--accent); color: var(--accent); }
[data-theme="dark"] .article-edit-top:hover { border-color: var(--accent); color: var(--accent); }

.article-breadcrumb {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-family: var(--mono);
  font-size: 0.6rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--muted-light);
  margin-bottom: 1.25rem;
}

.article-breadcrumb a {
  color: var(--muted-light);
  text-decoration: none;
  transition: color 0.15s;
  cursor: pointer;
}

.article-breadcrumb a:hover { color: var(--accent); }

.article-breadcrumb .bc-sep {
  opacity: 0.4;
  font-size: 0.5rem;
}

.article-breadcrumb .bc-current {
  color: var(--muted);
  font-weight: 500;
}

/* Back to top */
.back-to-top {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--accent);
  color: #fff;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transform: translateY(10px);
  transition: opacity 0.3s, transform 0.3s;
  pointer-events: none;
  z-index: 90;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.back-to-top.visible {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.back-to-top:hover {
  background: var(--ink);
}

/* Desktop back link in content area */
.article-back-link {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  font-family: var(--mono);
  font-size: 0.6rem;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--muted-light);
  text-decoration: none;
  cursor: pointer;
  padding: 0.3rem 0.6rem;
  border-radius: 4px;
  transition: color 0.15s, background 0.15s;
  margin-bottom: 0.5rem;
}

.article-back-link:hover {
  color: var(--accent);
  background: rgba(139, 37, 0, 0.04);
}

.article-back-link svg { opacity: 0.5; }
.article-back-link:hover svg { opacity: 1; }

/* Keyboard hints */
.nav-key-hint {
  display: inline-block;
  font-family: var(--mono);
  font-size: 0.5rem;
  padding: 0.1rem 0.35rem;
  border: 1px solid var(--border);
  border-radius: 3px;
  color: var(--muted-light);
  margin-left: 0.4rem;
  vertical-align: middle;
  opacity: 0.6;
}

/* Improved article nav */
.article-nav {
  display: flex;
  justify-content: center;
  align-items: stretch;
  margin-top: 2.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border-light);
  gap: 0.6rem;
}

.article-nav-btn {
  flex: 0 1 220px;
  padding: 0.75rem 0.9rem;
  background: var(--paper);
  border: 1px solid var(--border);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: left;
  font-family: inherit;
  color: inherit;
  display: flex;
  flex-direction: column;
  gap: 0.15rem;
}
.article-nav-btn:hover { border-color: var(--accent); background: var(--paper-warm); }
.article-nav-btn:active { transform: scale(0.97); }
.article-nav-btn.next { text-align: right; }
.article-nav-btn .nav-label { font-family: var(--mono); font-size: 0.45rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted-light); }
.article-nav-btn .nav-title { font-family: var(--serif); font-size: 0.88rem; font-weight: 500; color: var(--accent); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.article-nav-center {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.article-nav-home {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--paper);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--muted-light);
  transition: all 0.2s;
  flex-shrink: 0;
}

.article-nav-home:hover {
  color: var(--accent);
  border-color: var(--accent);
}

.bookmark-btn {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  width: 48px; height: 48px;
  background: var(--ink);
  color: var(--paper);
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 16px var(--shadow-deep);
  transition: all 0.3s;
  z-index: 50;
}

.bookmark-btn:hover { transform: scale(1.1); background: var(--accent); }
.bookmark-btn.bookmarked { background: var(--gold); }

.no-results { text-align: center; padding: 4rem 2rem; animation: fadeIn 0.5s ease; }
.no-results-icon { font-size: 3rem; opacity: 0.2; margin-bottom: 1rem; }
.no-results h3 { font-family: var(--serif); font-size: 1.5rem; font-weight: 400; color: var(--muted); margin-bottom: 0.5rem; }
.no-results p { font-size: 0.9rem; color: var(--muted-light); }

/* ===== MOBILE BOTTOM TAB BAR ===== */
.mobile-tab-bar {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--ink);
  z-index: 200;
  padding-bottom: var(--safe-bottom);
  box-shadow: 0 -2px 20px var(--shadow-deep);
  transition: transform 0.3s ease;
}

.mobile-tab-bar.reading {
  transform: translateY(100%);
}

.mobile-tab-bar-inner {
  display: flex;
  height: var(--tab-height);
}

.tab-btn {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  background: none;
  border: none;
  color: rgba(245, 240, 232, 0.4);
  font-family: var(--mono);
  font-size: 0.5rem;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  cursor: pointer;
  transition: color 0.2s;
  -webkit-tap-highlight-color: transparent;
  position: relative;
}

.tab-btn svg { width: 22px; height: 22px; stroke-width: 1.8; transition: all 0.2s; }
.tab-btn.active { color: var(--gold-light); }
.tab-btn.active svg { stroke-width: 2.2; }
.tab-btn.active::before {
  content: '';
  position: absolute;
  top: 0; left: 30%; right: 30%;
  height: 2px;
  background: var(--gold-light);
  border-radius: 0 0 2px 2px;
}

/* ===== MOBILE DRAWER (Index / Search / Bookmarks) ===== */
.mobile-drawer {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 150;
  pointer-events: none;
}

.mobile-drawer.open {
  pointer-events: auto;
}

.drawer-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(26, 22, 16, 0.5);
  opacity: 0;
  transition: opacity 0.35s ease;
}

.mobile-drawer.open .drawer-backdrop { opacity: 1; }

.drawer-panel {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  background: var(--paper);
  border-radius: 20px 20px 0 0;
  max-height: 88vh;
  transform: translateY(100%);
  transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
  display: flex;
  flex-direction: column;
  padding-bottom: calc(var(--tab-height) + var(--safe-bottom));
  box-shadow: 0 -8px 40px rgba(26, 22, 16, 0.25);
}

.mobile-drawer.open .drawer-panel { transform: translateY(0); }

.drawer-handle {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 12px 0 4px;
  flex-shrink: 0;
}

.drawer-handle-bar {
  width: 36px;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
}

.drawer-header {
  padding: 0.75rem 1.25rem 1rem;
  border-bottom: 1px solid var(--border-light);
  flex-shrink: 0;
}

.drawer-title {
  font-family: var(--serif);
  font-size: 1.4rem;
  font-weight: 500;
  color: var(--ink);
  margin-bottom: 0.75rem;
}

/* Drawer search */
.drawer-search-wrap {
  position: relative;
}

.drawer-search-wrap svg {
  position: absolute;
  left: 0.85rem; top: 50%;
  transform: translateY(-50%);
  opacity: 0.3;
  width: 16px; height: 16px;
  stroke: var(--ink);
}

.drawer-search {
  width: 100%;
  padding: 0.65rem 1rem 0.65rem 2.5rem;
  background: var(--paper-warm);
  border: 1px solid var(--border);
  border-radius: 10px;
  font-family: var(--body);
  font-size: 0.95rem;
  color: var(--ink);
  outline: none;
  transition: border-color 0.2s;
}

.drawer-search::placeholder { color: var(--muted-light); }
.drawer-search:focus { border-color: var(--accent); }

/* Drawer alphabet strip */
.drawer-alpha-strip {
  display: flex;
  overflow-x: auto;
  gap: 2px;
  padding: 0.75rem 1.25rem 0;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  flex-shrink: 0;
}

.drawer-alpha-strip::-webkit-scrollbar { display: none; }

.drawer-alpha-btn {
  min-width: 34px; height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  border: none;
  background: none;
  font-family: var(--serif);
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--muted-light);
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}

.drawer-alpha-btn.has-entries { color: var(--ink); }
.drawer-alpha-btn.active { background: var(--accent); color: var(--paper); }

.drawer-content {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 0.5rem 0;
}

/* Drawer entry cards */
.drawer-entry {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.85rem 1.25rem;
  cursor: pointer;
  transition: background 0.15s;
  -webkit-tap-highlight-color: transparent;
  border-bottom: 1px solid rgba(214, 207, 195, 0.4);
}

.drawer-entry:active { background: rgba(139, 37, 0, 0.06); }

.drawer-entry-letter {
  width: 36px; height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(139, 37, 0, 0.07);
  border-radius: 10px;
  font-family: var(--serif);
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--accent);
  flex-shrink: 0;
}

.drawer-entry-text { flex: 1; min-width: 0; }

.drawer-entry-name {
  font-family: var(--serif);
  font-size: 1.1rem;
  font-weight: 500;
  color: var(--ink);
  line-height: 1.3;
}

.drawer-entry-cat {
  font-family: var(--mono);
  font-size: 0.55rem;
  letter-spacing: 0.05em;
  color: var(--muted-light);
  text-transform: uppercase;
  margin-top: 2px;
}

.drawer-entry-arrow {
  color: var(--border);
  flex-shrink: 0;
  font-size: 1.2rem;
}

.drawer-entry-bookmark {
  flex-shrink: 0;
  color: var(--gold);
  font-size: 0.85rem;
}

.drawer-letter-divider {
  padding: 0.5rem 1.25rem 0.25rem;
  font-family: var(--serif);
  font-size: 1.5rem;
  font-weight: 300;
  color: var(--accent);
  opacity: 0.4;
}

/* ===== MOBILE ARTICLE HEADER BAR ===== */
.mobile-article-bar {
  display: none;
  position: sticky;
  top: 0;
  z-index: 90;
  background: var(--ink);
  color: var(--paper);
  padding: 0.6rem 0.75rem;
  padding-top: calc(0.6rem + var(--safe-top));
  align-items: center;
  gap: 0.5rem;
  box-shadow: 0 2px 12px var(--shadow-deep);
}

.mobile-back-btn {
  width: 36px; height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  color: var(--paper);
  cursor: pointer;
  border-radius: 8px;
  -webkit-tap-highlight-color: transparent;
  flex-shrink: 0;
}

.mobile-back-btn:active { background: rgba(245, 240, 232, 0.1); }

.mobile-article-title {
  flex: 1;
  font-family: var(--serif);
  font-size: 1rem;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  opacity: 0;
  transition: opacity 0.3s;
}

.mobile-article-title.visible { opacity: 1; }

.mobile-bookmark-btn {
  width: 36px; height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  color: var(--paper);
  cursor: pointer;
  border-radius: 8px;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
}

.mobile-bookmark-btn.bookmarked { color: var(--gold-light); }

/* ===== MOBILE FAB ===== */
.mobile-fab {
  display: none;
  position: fixed;
  bottom: calc(var(--tab-height) + var(--safe-bottom) + 16px);
  right: 16px;
  z-index: 90;
  width: 52px; height: 52px;
  border-radius: 16px;
  background: var(--accent);
  color: var(--paper);
  border: none;
  box-shadow: 0 4px 16px rgba(139, 37, 0, 0.35);
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  transition: transform 0.2s, box-shadow 0.2s;
}

.mobile-fab:active { transform: scale(0.92); box-shadow: 0 2px 8px rgba(139, 37, 0, 0.25); }
.mobile-fab svg { width: 24px; height: 24px; }
.mobile-fab.hidden { transform: scale(0); pointer-events: none; }

/* ===== MOBILE READING PROGRESS ===== */
.mobile-reading-progress {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  z-index: 200;
  background: transparent;
}

.mobile-reading-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, var(--accent), var(--gold));
  transition: width 0.1s linear;
  border-radius: 0 2px 2px 0;
}

/* ===== MOBILE QUICK ACTIONS ===== */
.mobile-quick-actions {
  display: flex;
  gap: 0.6rem;
  margin-top: 1.75rem;
  text-align: center;
}

.mobile-quick-btn {
  flex: 1;
  padding: 1rem 0.5rem;
  background: var(--paper-warm);
  border: 1px solid var(--border);
  border-radius: 14px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  transition: all 0.15s;
}

.mobile-quick-btn:active { transform: scale(0.97); background: var(--border-light); }
.mobile-quick-btn svg { display: block; margin: 0 auto 0.4rem; opacity: 0.6; }
.mobile-quick-btn span {
  font-family: var(--mono);
  font-size: 0.5rem;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--muted);
}

/* ===== MOBILE ARTICLE ENHANCEMENTS ===== */
.mobile-reading-time {
  font-family: var(--mono);
  font-size: 0.55rem;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--muted-light);
  margin-top: 0.5rem;
}

.quality-hints {
  display: flex; flex-wrap: wrap; gap: 0.35rem; margin-top: 0.4rem;
}
.quality-hint {
  display: inline-flex; align-items: center; gap: 0.25rem;
  font-family: var(--mono); font-size: 0.42rem; letter-spacing: 0.04em;
  text-transform: uppercase; color: var(--muted-light); opacity: 0.55;
  padding: 0.15rem 0.45rem; border: 1px dashed var(--border-light);
  border-radius: 4px; cursor: help;
}
.quality-hint:hover { opacity: 0.85; border-color: var(--muted-light); }
.quality-hint svg { opacity: 0.6; }

.mobile-article-category-pill {
  display: inline-block;
  padding: 0.3rem 0.75rem;
  background: rgba(139, 37, 0, 0.08);
  border-radius: 20px;
  font-family: var(--mono);
  font-size: 0.55rem;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--accent);
}

/* ===== DRAWER FILTER CHIPS ===== */
.drawer-filter-strip {
  display: flex;
  overflow-x: auto;
  gap: 6px;
  padding: 0.5rem 1.25rem;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  flex-shrink: 0;
}

.drawer-filter-strip::-webkit-scrollbar { display: none; }

.drawer-filter-chip {
  padding: 0.3rem 0.75rem;
  background: var(--paper-warm);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-family: var(--mono);
  font-size: 0.5rem;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: var(--muted);
  cursor: pointer;
  flex-shrink: 0;
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
  transition: all 0.15s;
}

.drawer-filter-chip:active { transform: scale(0.95); }
.drawer-filter-chip.active { background: var(--accent); border-color: var(--accent); color: var(--paper); }

.drawer-results-count {
  padding: 0.25rem 1.25rem 0;
  font-family: var(--mono);
  font-size: 0.55rem;
  letter-spacing: 0.06em;
  color: var(--muted-light);
  flex-shrink: 0;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 1024px) {
  .sidebar { width: 260px; min-width: 260px; }
  .content { padding: 2.5rem 3rem; }
}

@media (max-width: 768px) {
  html { font-size: 16px; }
  
  .header, .sidebar, .bookmark-btn { display: none !important; }
  
  .main {
    flex-direction: column;
    padding-bottom: calc(var(--tab-height) + var(--safe-bottom));
  }
  
  .mobile-tab-bar { display: block; }
  .mobile-drawer { display: block; }
  .mobile-fab { display: flex; align-items: center; justify-content: center; }
  
  .content {
    flex: 1;
    height: auto;
    overflow: visible;
    padding: 0;
    max-width: 100%;
  }
  
  /* Mobile welcome */
  .welcome { padding: 2rem 1.25rem 1.5rem; }
  .welcome-ornament { font-size: 1.8rem; margin-bottom: 0.75rem; }
  .welcome h2 { font-size: 1.55rem; margin-bottom: 0.4rem; }
  .welcome p { font-size: 0.92rem; line-height: 1.65; }
  
  .mass-import-bar { margin-top: 1.25rem; padding: 1rem; }
  .mass-import-bar h3 { font-size: 1rem; }
  .mass-import-bar p { font-size: 0.75rem; }
  
  /* Mobile article reading */
  .mobile-article-bar { display: flex; }
  .mobile-reading-progress { display: block; }
  
  .article { 
    padding: 1.25rem 1.15rem 2rem;
    animation: none;
  }
  
  .article-header { margin-bottom: 1.25rem; padding-bottom: 1rem; }
  .article-title { font-size: 2rem; line-height: 1.15; margin-bottom: 0.5rem; }
  .article-category { margin-bottom: 0.75rem; }
  .article-etymology { font-size: 0.82rem; }
  .article-definition { font-size: 1rem; padding-left: 0.85rem; }
  
  .article-body p {
    text-align: justify;
    hyphens: auto;
    text-indent: 1.2em;
    line-height: 1.75;
    font-size: 0.95rem;
    margin-bottom: 0.9rem;
  }
  
  .article-body h3 {
    font-size: 1.25rem;
    margin: 1.75rem 0 0.65rem;
  }
  
  .article-body h4 {
    font-size: 1.05rem;
    margin: 1.25rem 0 0.5rem;
    padding-left: 0.6rem;
  }
  
  .article-body blockquote { padding: 0.85rem; margin: 0.85rem 0; font-size: 0.88rem; }
  
  .article-tag {
    padding: 0.35rem 0.75rem;
    font-size: 0.55rem;
  }
  
  .article-refs { padding: 0.85rem; }
  .article-refs h4 { font-size: 0.55rem; }
  .article-refs p { font-size: 0.82rem; }
  
  .article-nav { gap: 0.4rem; flex-wrap: wrap; }
  .article-nav-btn { flex: 1 1 140px; padding: 0.55rem 0.65rem; border-radius: 8px; }
  .article-nav-btn .nav-title { font-size: 0.8rem; }
  .article-nav-btn .nav-label { font-size: 0.4rem; }
  .article-nav-center { display: none; }
  .article-edit-top {
  position: absolute; top: 0; right: 0;
  width: 32px; height: 32px; border-radius: 6px;
  border: 1px solid var(--border-light); background: transparent;
  color: var(--muted-light); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; opacity: 0.5;
}
.article-edit-top:hover { opacity: 1; border-color: var(--accent); color: var(--accent); }
[data-theme="dark"] .article-edit-top:hover { border-color: var(--accent); color: var(--accent); }

.article-breadcrumb { display: none; }
  .article-back-link { display: none; }
  .back-to-top { bottom: 5rem; right: 1rem; width: 36px; height: 36px; }
  .nav-key-hint { display: none; }
  
  .article-edit-actions { flex-wrap: wrap; }
  
  /* Auto-link on mobile */
  .auto-link { border-bottom-width: 1.5px; }
  
  /* User badge mobile */
  .user-entry-badge { font-size: 0.45rem; padding: 0.12rem 0.4rem; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

@media print {
  .header, .sidebar, .bookmark-btn, .mobile-tab-bar, .mobile-drawer, .mobile-article-bar, .article-nav { display: none !important; }
  .content { max-width: 100%; padding: 0; height: auto; }
}
/* ===== THEME TOGGLE ===== */
.theme-toggle {
  padding: 0.4rem;
  background: rgba(245, 240, 232, 0.08);
  border: 1px solid rgba(245, 240, 232, 0.1);
  border-radius: 6px;
  color: var(--paper);
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.theme-toggle:hover { background: rgba(245, 240, 232, 0.15); }
[data-theme="dark"] .theme-toggle { color: var(--gold-light); }
.theme-toggle svg { width: 18px; height: 18px; }

/* ===== AUTO-LINKS ===== */
.auto-link {
  color: var(--accent);
  cursor: pointer;
  text-decoration: none;
  border-bottom: 1px dotted var(--accent);
  transition: all 0.2s;
}
.auto-link:hover { color: var(--accent-light); border-bottom-style: solid; }

/* ===== SEARCH FILTERS ===== */
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
  padding: 0 2rem 0.65rem;
}

.filter-chip {
  padding: 0.25rem 0.7rem;
  background: rgba(245, 240, 232, 0.06);
  border: 1px solid rgba(245, 240, 232, 0.12);
  border-radius: 20px;
  color: rgba(245, 240, 232, 0.5);
  font-family: var(--mono);
  font-size: 0.55rem;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.filter-chip:hover { border-color: rgba(245, 240, 232, 0.3); color: rgba(245, 240, 232, 0.7); }
.filter-chip.active { background: var(--accent); border-color: var(--accent); color: var(--paper); }

/* ===== MASS IMPORT ===== */
.mass-import-bar {
  margin-top: 1.5rem;
  padding: 1.25rem;
  background: var(--paper-warm);
  border: 1px solid var(--border);
  border-radius: 10px;
}

.mass-import-bar h3 {
  font-family: var(--serif);
  font-size: 1.1rem;
  font-weight: 500;
  margin-bottom: 0.25rem;
}

.mass-import-bar p {
  font-size: 0.8rem;
  color: var(--muted);
  margin-bottom: 1rem;
}

.mass-import-progress {
  margin-top: 0.75rem;
}

.mass-import-progress-bar {
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 0.5rem;
}

.mass-import-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--gold));
  border-radius: 3px;
  transition: width 0.3s ease;
  width: 0%;
}

.mass-import-status {
  font-family: var(--mono);
  font-size: 0.65rem;
  color: var(--muted);
  display: flex;
  justify-content: space-between;
}

/* ===== EDITOR ===== */
.editor-container {
  animation: slideIn 0.4s ease;
  max-width: 800px;
}

.editor-topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--border);
  flex-wrap: wrap;
  gap: 0.75rem;
}

.editor-topbar h2 {
  font-family: var(--serif);
  font-size: 1.8rem;
  font-weight: 400;
  color: var(--ink);
}

.editor-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }

.btn {
  padding: 0.55rem 1.25rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-family: var(--mono);
  font-size: 0.65rem;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--paper-warm);
  color: var(--ink);
}

.btn:hover { border-color: var(--muted); }

.btn-primary {
  background: var(--accent);
  color: var(--paper);
  border-color: var(--accent);
}

.btn-primary:hover { background: var(--accent-light); }

.btn-danger {
  background: none;
  color: #a33;
  border-color: rgba(170, 51, 51, 0.3);
}

.btn-danger:hover { background: rgba(170, 51, 51, 0.08); border-color: #a33; }

.editor-field {
  margin-bottom: 1.25rem;
}

.editor-label {
  display: block;
  font-family: var(--mono);
  font-size: 0.6rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 0.4rem;
}

.editor-input {
  width: 100%;
  padding: 0.6rem 0.85rem;
  background: var(--paper-warm);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-family: var(--body);
  font-size: 0.95rem;
  color: var(--ink);
  outline: none;
  transition: border-color 0.2s;
}

.editor-input:focus { border-color: var(--accent); }

.editor-input-small { font-size: 0.85rem; }

.editor-textarea {
  width: 100%;
  min-height: 400px;
  padding: 1rem;
  background: var(--paper-warm);
  border: 1px solid var(--border);
  border-radius: 0 0 8px 8px;
  font-family: var(--mono);
  font-size: 0.8rem;
  line-height: 1.7;
  color: var(--ink);
  outline: none;
  resize: vertical;
  tab-size: 2;
  transition: border-color 0.2s;
}

.editor-textarea:focus { border-color: var(--accent); }

.editor-tabs {
  display: flex;
  gap: 0;
  margin-bottom: -1px;
  position: relative;
  z-index: 1;
}

.editor-tab {
  padding: 0.5rem 1.25rem;
  background: none;
  border: 1px solid transparent;
  border-bottom: none;
  border-radius: 8px 8px 0 0;
  font-family: var(--mono);
  font-size: 0.6rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--muted);
  cursor: pointer;
  transition: all 0.2s;
}

.editor-tab.active {
  background: var(--paper-warm);
  border-color: var(--border);
  color: var(--accent);
}

.editor-preview {
  min-height: 400px;
  padding: 1.5rem;
  background: var(--paper-warm);
  border: 1px solid var(--border);
  border-radius: 0 8px 8px 8px;
}

.editor-preview .article-body { all: unset; display: block; }
.editor-preview .article-body h3 { font-family: var(--serif); font-size: 1.4rem; font-weight: 500; margin: 1.5rem 0 0.75rem; padding-bottom: 0.4rem; border-bottom: 1px solid var(--border-light); }
.editor-preview .article-body h4 { font-family: var(--serif); font-size: 1.1rem; font-weight: 600; margin: 1.2rem 0 0.5rem; padding-left: 0.75rem; border-left: 3px solid var(--gold-light); }
.editor-preview .article-body p { margin-bottom: 1rem; line-height: 1.8; font-size: 0.95rem; color: #2a261e; }
.editor-preview .article-body blockquote { margin: 1rem 0; padding: 1rem; background: rgba(184, 134, 11, 0.06); border-left: 3px solid var(--gold); border-radius: 0 6px 6px 0; font-style: italic; color: var(--muted); font-size: 0.9rem; }

.editor-help {
  margin-top: 1.5rem;
  padding: 1.25rem;
  background: rgba(139, 37, 0, 0.04);
  border: 1px solid rgba(139, 37, 0, 0.1);
  border-radius: 8px;
}

.editor-help summary {
  font-family: var(--mono);
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--accent);
  cursor: pointer;
  list-style: none;
}

.editor-help summary::before { content: '▸ '; }
.editor-help[open] summary::before { content: '▾ '; }

.editor-help-content {
  margin-top: 0.75rem;
  font-family: var(--mono);
  font-size: 0.7rem;
  line-height: 2;
  color: var(--muted);
}

.editor-help-content code {
  background: rgba(26, 22, 16, 0.06);
  padding: 0.15rem 0.4rem;
  border-radius: 3px;
}

.user-entry-badge {
  display: inline-block;
  padding: 0.15rem 0.5rem;
  background: rgba(139, 37, 0, 0.08);
  border: 1px solid rgba(139, 37, 0, 0.15);
  border-radius: 4px;
  font-family: var(--mono);
  font-size: 0.5rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--accent);
  margin-left: 0.5rem;
  vertical-align: middle;
}

.article-edit-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-light);
}

/* Desktop add button */
.add-entry-btn {
  padding: 0.5rem 1rem;
  background: rgba(245, 240, 232, 0.06);
  border: 1px solid rgba(245, 240, 232, 0.12);
  border-radius: 6px;
  color: var(--paper);
  font-family: var(--mono);
  font-size: 0.65rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.add-entry-btn:hover { background: rgba(139, 37, 0, 0.3); border-color: var(--accent-light); }

/* Import panel */
.import-panel {
  margin-bottom: 1.75rem;
  padding: 1.25rem;
  background: linear-gradient(135deg, rgba(139, 37, 0, 0.04), rgba(184, 134, 11, 0.04));
  border: 1px solid rgba(139, 37, 0, 0.12);
  border-radius: 10px;
}

.import-panel-title {
  font-family: var(--serif);
  font-size: 1.15rem;
  font-weight: 500;
  color: var(--ink);
  margin-bottom: 0.15rem;
}

.import-panel-desc {
  font-size: 0.8rem;
  color: var(--muted);
  margin-bottom: 1rem;
  line-height: 1.5;
}

.import-row {
  display: flex;
  gap: 0.5rem;
  align-items: stretch;
}

.import-input {
  flex: 1;
  padding: 0.6rem 0.85rem;
  background: var(--paper);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-family: var(--mono);
  font-size: 0.75rem;
  color: var(--ink);
  outline: none;
  transition: border-color 0.2s;
  min-width: 0;
}

.import-input:focus { border-color: var(--accent); }
.import-input::placeholder { color: var(--muted-light); font-style: normal; }

.import-btn {
  padding: 0.6rem 1.25rem;
  background: var(--ink);
  color: var(--paper);
  border: none;
  border-radius: 8px;
  font-family: var(--mono);
  font-size: 0.65rem;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.import-btn:hover { background: var(--accent); }
.import-btn:disabled { opacity: 0.5; cursor: wait; }

.import-status {
  margin-top: 0.75rem;
  font-family: var(--mono);
  font-size: 0.7rem;
  line-height: 1.6;
  padding: 0.6rem 0.85rem;
  border-radius: 6px;
  display: none;
}

.import-status.loading {
  display: block;
  background: rgba(184, 134, 11, 0.08);
  color: var(--gold);
  border: 1px solid rgba(184, 134, 11, 0.2);
}

.import-status kbd {
  display: inline-block;
  padding: 0.1rem 0.35rem;
  background: rgba(26, 22, 16, 0.06);
  border: 1px solid rgba(26, 22, 16, 0.12);
  border-radius: 3px;
  font-family: var(--mono);
  font-size: 0.65rem;
}

.import-status.success {
  display: block;
  background: rgba(34, 120, 60, 0.08);
  color: #22783c;
  border: 1px solid rgba(34, 120, 60, 0.2);
}

.import-status.error {
  display: block;
  background: rgba(170, 51, 51, 0.08);
  color: #a33;
  border: 1px solid rgba(170, 51, 51, 0.2);
}

.import-or {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin: 1.25rem 0 0;
  font-family: var(--mono);
  font-size: 0.55rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted-light);
}

.import-or::before, .import-or::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border-light);
}

@media (max-width: 768px) {
  .editor-container { padding: 1.25rem; }
  .editor-topbar h2 { font-size: 1.4rem; }
  .editor-textarea { min-height: 280px; font-size: 0.75rem; }
  .editor-preview { min-height: 280px; padding: 1rem; }
  .btn { padding: 0.5rem 1rem; }
  .import-row { flex-direction: column; }
  .import-input { font-size: 0.7rem; }
}

/* ===== TABLE OF CONTENTS ===== */
.article-body-wrap {
  display: flex;
  gap: 1.5rem;
  align-items: flex-start;
}

.article-body-wrap > .article-body { flex: 1; min-width: 0; }

.toc-float {
  position: sticky;
  top: 20px;
  width: 200px;
  flex-shrink: 0;
  padding: 1rem;
  background: var(--paper-warm);
  border: 1px solid var(--border);
  border-radius: 10px;
  max-height: calc(100vh - 60px);
  overflow-y: auto;
  font-size: 0.78rem;
  line-height: 1.5;
  scrollbar-width: thin;
  order: 2;
}

.toc-float-title {
  font-family: var(--mono);
  font-size: 0.55rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted-light);
  margin-bottom: 0.6rem;
}

.toc-float a {
  display: block;
  padding: 0.2rem 0;
  color: var(--muted);
  text-decoration: none;
  font-family: var(--body);
  transition: color 0.15s;
  border-left: 2px solid transparent;
  padding-left: 0.6rem;
}

.toc-float a:hover { color: var(--accent); border-left-color: var(--accent); }
.toc-float a.active { color: var(--accent); border-left-color: var(--accent); font-weight: 500; }
.toc-float a.toc-sub { padding-left: 1.4rem; font-size: 0.72rem; color: var(--muted-light); }
.toc-float a.toc-sub::before { content: '–'; margin-right: 0.3rem; opacity: 0.4; }
.toc-float a.toc-sub:hover { color: var(--accent); }
.toc-float a.toc-sub.active { color: var(--accent); border-left-color: var(--gold-light); font-weight: 400; }

/* Mobile TOC */
.toc-mobile-toggle {
  display: none;
  padding: 0.6rem 1rem;
  background: var(--paper-warm);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-family: var(--mono);
  font-size: 0.6rem;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--muted);
  cursor: pointer;
  margin-bottom: 1rem;
  width: 100%;
  text-align: left;
  -webkit-tap-highlight-color: transparent;
}

.toc-mobile-toggle svg { vertical-align: -2px; margin-right: 0.4rem; }
.toc-mobile-list { display: none; margin-bottom: 1rem; }
.toc-mobile-list.open { display: block; }
.toc-mobile-list a { display: block; padding: 0.5rem 0.75rem; color: var(--muted); text-decoration: none; font-size: 0.85rem; border-bottom: 1px solid var(--border-light); }
.toc-mobile-list a.toc-sub { padding-left: 1.8rem; font-size: 0.8rem; color: var(--muted-light); }
.toc-mobile-list a.toc-sub::before { content: '–'; margin-right: 0.35rem; opacity: 0.4; }
.toc-mobile-list a:active { background: rgba(139, 37, 0, 0.06); }

@media (max-width: 768px) {
  .toc-float { display: none !important; }
  .article-body-wrap { display: block; }
  .toc-mobile-toggle { display: block; }
}
@media (max-width: 1200px) and (min-width: 769px) {
  .toc-float { width: 170px; font-size: 0.72rem; }
}

/* ===== GRAPH MODAL ===== */
.graph-overlay {
  position: fixed;
  inset: 0;
  z-index: 500;
  background: rgba(26, 22, 16, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.graph-container {
  width: 90vw; height: 80vh;
  max-width: 1000px;
  background: var(--paper);
  border-radius: 16px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
}

.graph-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border);
}

.graph-header h3 { font-family: var(--serif); font-weight: 400; font-size: 1.2rem; }
.graph-close { background: none; border: none; color: var(--muted); cursor: pointer; padding: 0.4rem; border-radius: 6px; }
.graph-close:hover { background: var(--border-light); color: var(--ink); }
.graph-canvas-wrap { flex: 1; position: relative; }
.graph-canvas-wrap canvas { width: 100%; height: 100%; }

/* ===== EDITOR TOOLBAR ===== */
.editor-toolbar {
  display: flex;
  gap: 2px;
  padding: 0.4rem;
  background: var(--paper-warm);
  border: 1px solid var(--border);
  border-bottom: none;
  border-radius: 8px 8px 0 0;
  flex-wrap: wrap;
}

.editor-toolbar button {
  width: 32px; height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  border-radius: 5px;
  color: var(--muted);
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 600;
  transition: all 0.15s;
}

.editor-toolbar button:hover { background: var(--border-light); color: var(--ink); }
.editor-toolbar .sep { width: 1px; background: var(--border); margin: 4px 3px; }

/* ===== FONT SIZE CONTROLS ===== */
.font-size-controls {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  margin-left: auto;
}

.font-size-btn {
  width: 30px; height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--muted);
  cursor: pointer;
  font-family: var(--serif);
  font-weight: 600;
  transition: all 0.15s;
}

.font-size-btn:hover { border-color: var(--accent); color: var(--accent); }

/* ===== FOOTNOTES ===== */
.footnote-ref {
  display: inline-block;
  font-size: 0.7em;
  vertical-align: super;
  line-height: 0;
  color: var(--accent);
  cursor: pointer;
  margin: 0 1px;
  font-weight: 600;
  transition: color 0.15s;
}

.footnote-ref:hover { color: var(--accent-light); text-decoration: underline; }

.footnotes-section {
  margin-top: 2rem;
  padding-top: 1.25rem;
  border-top: 1px solid var(--border);
}

.footnotes-section h4 {
  font-family: var(--mono);
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted-light);
  margin-bottom: 0.75rem;
}

.footnote-item {
  display: flex;
  gap: 0.5rem;
  font-size: 0.82rem;
  color: var(--muted);
  margin-bottom: 0.4rem;
  line-height: 1.5;
  scroll-margin-top: 80px;
}

.footnote-num {
  flex-shrink: 0;
  font-weight: 600;
  color: var(--accent);
  min-width: 1.5em;
  text-align: right;
}

.footnote-back { color: var(--accent); cursor: pointer; text-decoration: none; margin-left: 0.3rem; font-size: 0.75em; }

/* ===== SEARCH SUGGESTIONS ===== */
.search-suggestions {
  position: absolute;
  top: 100%;
  left: 0; right: 0;
  background: var(--paper);
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 10px 10px;
  box-shadow: 0 8px 24px var(--shadow-deep);
  z-index: 50;
  max-height: 320px;
  overflow-y: auto;
  display: none;
}

.search-suggestions.visible { display: block; }

.search-suggestion {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.65rem 1rem;
  cursor: pointer;
  transition: background 0.1s;
  border-bottom: 1px solid var(--border-light);
}

.search-suggestion:hover, .search-suggestion.highlighted { background: rgba(139, 37, 0, 0.05); }
.search-suggestion:last-child { border-bottom: none; }
.search-suggestion-letter {
  width: 28px; height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(139, 37, 0, 0.07);
  border-radius: 7px;
  font-family: var(--serif);
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--accent);
  flex-shrink: 0;
}

.search-suggestion-text { flex: 1; min-width: 0; }
.search-suggestion-title { font-family: var(--serif); font-size: 0.95rem; font-weight: 500; color: var(--ink); }
.search-suggestion-cat { font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.04em; color: var(--muted-light); text-transform: uppercase; }

/* ===== READ INDICATOR ===== */
.read-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--accent);
  flex-shrink: 0;
  opacity: 0.7;
}

.read-dot.read { background: var(--border); opacity: 0.3; }

.entry-item .read-indicator,
.drawer-entry .read-indicator {
  width: 6px; height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.unread-indicator { background: var(--accent); }

/* ===== HISTORY & DATA PANEL ===== */
.data-panel {
  margin-top: 1.5rem;
  padding: 1rem;
  background: var(--paper-warm);
  border: 1px solid var(--border);
  border-radius: 10px;
}

.data-panel h3 {
  font-family: var(--serif);
  font-size: 1rem;
  font-weight: 500;
  margin-bottom: 0.5rem;
}

.data-panel-row {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-top: 0.5rem;
}

.data-panel .btn { font-size: 0.7rem; }

.history-list {
  max-height: 200px;
  overflow-y: auto;
  margin-top: 0.5rem;
}

.history-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.45rem 0;
  cursor: pointer;
  border-bottom: 1px solid var(--border-light);
  font-size: 0.85rem;
  transition: color 0.15s;
}

.history-item:hover { color: var(--accent); }
.history-time { font-family: var(--mono); font-size: 0.55rem; color: var(--muted-light); flex-shrink: 0; }

/* ===== PHILOSOPHER INDEX ===== */
.philosopher-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 0.75rem;
  margin-top: 1rem;
}

.philosopher-card {
  padding: 0.85rem;
  background: var(--paper-warm);
  border: 1px solid var(--border);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.15s;
}

.philosopher-card:hover { border-color: var(--accent); transform: translateY(-1px); }
.philosopher-card-name { font-family: var(--serif); font-size: 1.05rem; font-weight: 500; color: var(--ink); }
.philosopher-card-count { font-family: var(--mono); font-size: 0.55rem; color: var(--muted-light); text-transform: uppercase; letter-spacing: 0.04em; }

/* ===== DUPLICATE WARNING ===== */
.duplicate-warning {
  padding: 0.85rem;
  background: rgba(184, 134, 11, 0.08);
  border: 1px solid rgba(184, 134, 11, 0.2);
  border-radius: 8px;
  margin-bottom: 1rem;
  font-size: 0.85rem;
  color: var(--gold);
}

.duplicate-warning strong { color: var(--ink); }

@media (max-width: 768px) {
  .toc-float { display: none !important; }
  .graph-container { width: 96vw; height: 75vh; border-radius: 12px; }
  .graph-header { padding: 0.75rem 1rem; }
  .search-suggestions { border-radius: 0 0 8px 8px; }
  .philosopher-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
  .font-size-controls { margin: 0; }
  .editor-toolbar button { width: 28px; height: 28px; font-size: 0.7rem; }
  .data-panel { padding: 0.85rem; }
}
/* ===== FEATURE: FOCUS MODE ===== */
.focus-mode .header, .focus-mode .sidebar, .focus-mode .bookmark-btn,
.focus-mode .mobile-tab-bar, .focus-mode .article-breadcrumb,
.focus-mode .article-back-link, .focus-mode .mobile-article-bar,
.focus-mode .mobile-reading-progress { display: none !important; }
.focus-mode .content { max-width: 100%; margin: 0 auto; padding: 2rem 4rem; height: auto; overflow: visible; }
.focus-mode .article-body-wrap { max-width: 680px; margin: 0 auto; }
.focus-mode .toc-float { display: none !important; }

.focus-toggle {
  position: fixed; top: 1rem; right: 1rem; z-index: 200;
  width: 36px; height: 36px; border-radius: 50%;
  background: var(--paper-warm); border: 1px solid var(--border);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  color: var(--muted); transition: all 0.2s; box-shadow: 0 2px 6px var(--shadow);
}
.focus-toggle:hover { color: var(--accent); border-color: var(--accent); }
.focus-mode .focus-toggle { background: var(--accent); color: #fff; border-color: var(--accent); }

/* ===== HIGHLIGHTS ===== */
.user-highlight {
  background: rgba(212, 168, 67, 0.25); border-radius: 2px;
  cursor: pointer; transition: background 0.15s;
  border-bottom: 1px solid rgba(212, 168, 67, 0.4);
}
.user-highlight:hover { background: rgba(212, 168, 67, 0.4); }
[data-theme="dark"] .user-highlight { background: rgba(212, 168, 67, 0.15); border-color: rgba(212, 168, 67, 0.3); }
[data-theme="dark"] .user-highlight:hover { background: rgba(212, 168, 67, 0.3); }

/* ===== MINI PROGRESS MAP ===== */
.progress-map {
  position: fixed; right: 4px; top: 50%; transform: translateY(-50%);
  width: 4px; height: 30vh; max-height: 200px;
  background: var(--border-light); border-radius: 2px;
  z-index: 100; opacity: 0.5; transition: opacity 0.3s;
}
.progress-map:hover { opacity: 1; width: 6px; }
.progress-map-fill {
  width: 100%; border-radius: 2px;
  background: var(--accent); transition: height 0.1s;
  position: absolute; top: 0;
}
.focus-mode .progress-map { display: none; }
@media (max-width: 768px) { .progress-map { right: 2px; width: 3px; height: 25vh; } }

/* ===== IMMERSIVE MODE ===== */
.immersive-mode .header, .immersive-mode .sidebar, .immersive-mode .bookmark-btn,
.immersive-mode .mobile-tab-bar, .immersive-mode .article-breadcrumb,
.immersive-mode .article-back-link, .immersive-mode .mobile-article-bar,
.immersive-mode .mobile-reading-progress, .immersive-mode .article-nav,
.immersive-mode .article-tags, .immersive-mode .article-source,
.immersive-mode .article-edit-actions, .immersive-mode .nav-position,
.immersive-mode .article-notes, .immersive-mode .fiche-express,
.immersive-mode .toc-float, .immersive-mode .reading-toolbar,
.immersive-mode .progress-map, .immersive-mode .focus-toggle { display: none !important; }
.immersive-mode .content { max-width: 100%; margin: 0 auto; padding: 3rem 4rem; height: auto; overflow: visible; }
.immersive-mode .article-body-wrap { max-width: 620px; margin: 0 auto; }
.immersive-mode .article { max-width: 700px; margin: 0 auto; }
.immersive-mode .article-header { margin-bottom: 2.5rem; }
@media (max-width: 768px) { .immersive-mode .content { padding: 2rem 1.25rem; } }
.immersive-exit {
  position: fixed; top: 1rem; right: 1rem; z-index: 300;
  width: 40px; height: 40px; border-radius: 50%;
  background: var(--paper-warm); border: 1px solid var(--border);
  cursor: pointer; display: none; align-items: center; justify-content: center;
  color: var(--muted); transition: all 0.2s; box-shadow: 0 2px 8px var(--shadow);
  font-size: 1.2rem;
}
.immersive-exit:hover { color: var(--accent); border-color: var(--accent); }
.immersive-mode .immersive-exit { display: flex; }

/* ===== DOUBLE-TAP ZOOM ===== */
.para-zoomed {
  transform: scale(1.15); transform-origin: left top;
  background: var(--paper-warm); border-radius: 8px;
  padding: 0.75rem !important; margin-left: -0.75rem !important;
  box-shadow: 0 4px 20px var(--shadow);
  position: relative; z-index: 10;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

/* ===== SCROLL POSITION INDICATOR ===== */
.scroll-resume {
  position: absolute; left: -1.5rem; width: 3px; height: 1.5rem;
  background: var(--gold); border-radius: 2px; opacity: 0;
  animation: resumeFade 3s ease forwards;
}
@keyframes resumeFade { 0%,30% { opacity: 0.8; } 100% { opacity: 0; } }

/* ===== FEATURE: ARTICLE TRANSITION ===== */
/* ===== UPDATE NOTIFICATION BADGE ===== */
.update-badge {
  display: inline-flex; align-items: center; justify-content: center;
  min-width: 18px; height: 18px; padding: 0 5px;
  border-radius: 9px; background: var(--accent); color: var(--paper);
  font-family: var(--mono); font-size: 0.5rem; font-weight: 700;
  margin-left: 0.3rem; vertical-align: middle;
  animation: badgePulse 2s ease-in-out infinite;
}
@keyframes badgePulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(139,37,0,0.3); }
  50% { box-shadow: 0 0 0 4px rgba(139,37,0,0); }
}
.update-banner {
  display: flex; align-items: center; gap: 0.6rem;
  padding: 0.6rem 0.85rem; margin: 1rem auto 0;
  max-width: 420px; border-radius: 10px; cursor: pointer;
  border: 1px solid rgba(139,37,0,0.2); background: rgba(139,37,0,0.04);
  transition: all 0.2s; font-size: 0.82rem; color: var(--ink);
}
.update-banner:hover { border-color: var(--accent); background: rgba(139,37,0,0.07); }
.update-banner-icon {
  width: 32px; height: 32px; border-radius: 8px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  background: rgba(139,37,0,0.08); color: var(--accent); font-size: 1rem;
}
.update-banner-text { flex: 1; }
.update-banner-count { font-weight: 600; color: var(--accent); }
.update-banner-arrow { color: var(--accent); font-size: 1.1rem; }
[data-theme="dark"] .update-banner { border-color: rgba(212,115,74,0.2); background: rgba(212,115,74,0.04); }
[data-theme="dark"] .update-banner:hover { border-color: var(--accent); background: rgba(212,115,74,0.08); }

/* ===== GLOSSARY ===== */
.glossary-search {
  width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border);
  border-radius: 6px; background: var(--paper-warm); color: var(--ink);
  font-family: var(--body); font-size: 0.82rem; margin-bottom: 1rem;
  outline: none; transition: border-color 0.2s;
}
.glossary-search:focus { border-color: var(--accent); }
.glossary-letter {
  font-family: var(--serif); font-size: 1.1rem; font-weight: 600;
  color: var(--accent); margin: 1rem 0 0.3rem; padding-bottom: 0.2rem;
  border-bottom: 1px solid var(--border-light);
}
.glossary-item { padding: 0.4rem 0; border-bottom: 1px solid rgba(0,0,0,0.03); }
.glossary-term {
  font-family: var(--serif); font-size: 0.88rem; font-weight: 600;
  color: var(--ink); display: flex; align-items: center; gap: 0.4rem;
}
.glossary-count {
  font-family: var(--mono); font-size: 0.42rem; color: var(--muted-light);
  background: var(--paper-warm); padding: 0.1rem 0.3rem; border-radius: 3px;
}
.glossary-def {
  font-size: 0.78rem; color: var(--muted); line-height: 1.5; margin-top: 0.1rem;
}

/* ===== TTS BAR ===== */
.tts-bar {
  display: flex; align-items: center; gap: 0.5rem;
  padding: 0.5rem 0.75rem; margin-top: 0.75rem;
  border: 1px solid var(--border-light); border-radius: 8px;
  background: var(--paper-warm);
}
.tts-btn {
  width: 32px; height: 32px; border: none; border-radius: 6px;
  background: transparent; color: var(--ink); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.tts-btn:hover { background: rgba(139,37,0,0.06); color: var(--accent); }
.tts-speed { display: flex; align-items: center; gap: 0.3rem; flex: 1; }
.tts-range {
  flex: 1; height: 3px; -webkit-appearance: none; appearance: none;
  background: var(--border); border-radius: 2px; outline: none;
}
.tts-range::-webkit-slider-thumb {
  -webkit-appearance: none; width: 12px; height: 12px;
  border-radius: 50%; background: var(--accent); cursor: pointer;
}
.tts-rate-label {
  font-family: var(--mono); font-size: 0.5rem; color: var(--muted-light);
  min-width: 2rem; text-align: center;
}
.tts-label {
  font-family: var(--mono); font-size: 0.42rem; letter-spacing: 0.06em;
  text-transform: uppercase; color: var(--muted-light); white-space: nowrap;
}

/* ===== DASHBOARD CARDS ===== */
.dash-streak {
  display: inline-flex; align-items: center; gap: 0.4rem;
  padding: 0.3rem 0.65rem; border-radius: 20px;
  background: rgba(212,168,67,0.1); border: 1px solid rgba(212,168,67,0.2);
  font-family: var(--mono); font-size: 0.55rem; color: var(--gold);
  margin-top: 0.75rem;
}
.dash-streak-fire { font-size: 0.9rem; }
.dash-activity {
  display: flex; gap: 2px; justify-content: center;
  margin-top: 0.75rem; flex-wrap: wrap; max-width: 320px; margin-left: auto; margin-right: auto;
}
.dash-day {
  width: 9px; height: 9px; border-radius: 2px;
  background: var(--border-light); transition: background 0.2s;
}
.dash-day.l1 { background: rgba(139,37,0,0.15); }
.dash-day.l2 { background: rgba(139,37,0,0.35); }
.dash-day.l3 { background: rgba(139,37,0,0.6); }
.dash-day.l4 { background: var(--accent); }
[data-theme="dark"] .dash-day.l1 { background: rgba(212,115,74,0.15); }
[data-theme="dark"] .dash-day.l2 { background: rgba(212,115,74,0.3); }
[data-theme="dark"] .dash-day.l3 { background: rgba(212,115,74,0.5); }
[data-theme="dark"] .dash-day.l4 { background: var(--accent); }
.dash-smart-title {
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.12em;
  text-transform: uppercase; color: var(--muted-light);
  margin-bottom: 0.5rem; text-align: center;
  display: flex; align-items: center; justify-content: center; gap: 0.4rem;
}
.dash-smart-title svg { opacity: 0.5; }

/* ===== MINI CONNECTION GRAPH ===== */
.mini-graph-wrap {
  margin-top: 1.5rem; padding: 1rem 0;
  border-top: 1px solid var(--border-light);
}
.mini-graph-title {
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--muted-light); margin-bottom: 0.6rem;
}
.mini-graph-svg { width: 100%; max-width: 500px; margin: 0 auto; display: block; }
.mini-graph-node { cursor: pointer; }
.mini-graph-node:hover circle { fill: var(--accent); }
.mini-graph-label { font-size: 10px; fill: var(--ink); pointer-events: none; }
.mini-graph-label-center { font-size: 11px; font-weight: 600; fill: var(--accent); pointer-events: none; }
.mini-graph-edge { stroke: var(--border); stroke-width: 1; opacity: 0.4; }
[data-theme="dark"] .mini-graph-edge { opacity: 0.25; }
[data-theme="dark"] .mini-graph-label { fill: var(--muted); }

/* ===== WYSIWYG EDITOR ===== */
.wysiwyg-area {
  min-height: 300px; max-height: 60vh; overflow-y: auto;
  padding: 1.25rem; border: 1px solid var(--border); border-radius: 0 0 8px 8px;
  background: var(--paper); color: var(--ink); font-family: var(--body);
  font-size: 0.95rem; line-height: 1.75; outline: none;
}
.wysiwyg-area:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(139,37,0,0.08); }
.wysiwyg-area h3 { font-family: var(--serif); font-size: 1.3rem; font-weight: 500; color: var(--accent); margin: 1.2rem 0 0.4rem; }
.wysiwyg-area h4 { font-family: var(--serif); font-size: 1.1rem; font-weight: 500; color: var(--ink); margin: 1rem 0 0.3rem; }
.wysiwyg-area blockquote { border-left: 3px solid var(--gold); padding: 0.5rem 1rem; background: var(--paper-warm); margin: 0.75rem 0; font-style: italic; }
.wysiwyg-area p { margin: 0.5rem 0; }
.wysiwyg-area:empty::before { content: 'Commencez à écrire votre article ici…'; color: var(--muted-light); }
[data-theme="dark"] .wysiwyg-area { background: var(--paper-warm); }
.editor-mode-switch {
  display: inline-flex; gap: 0; border: 1px solid var(--border); border-radius: 6px; overflow: hidden;
}
.editor-mode-btn {
  padding: 0.2rem 0.55rem; border: none; background: none;
  font-family: var(--mono); font-size: 0.48rem; letter-spacing: 0.04em;
  color: var(--muted); cursor: pointer; transition: all 0.15s;
}
.editor-mode-btn.active { background: var(--accent); color: var(--paper); }

/* ===== CUSTOM TAGS ===== */
.custom-tags-wrap { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.5rem; align-items: center; }
.custom-tag {
  display: inline-flex; align-items: center; gap: 0.25rem;
  padding: 0.2rem 0.5rem; border-radius: 12px; font-family: var(--mono);
  font-size: 0.5rem; letter-spacing: 0.04em; cursor: pointer;
  border: 1px solid var(--gold); color: var(--gold);
  background: rgba(212,168,67,0.06); transition: all 0.15s;
}
.custom-tag:hover { background: rgba(212,168,67,0.15); }
.custom-tag-remove { font-size: 0.6rem; opacity: 0.5; cursor: pointer; }
.custom-tag-remove:hover { opacity: 1; }
.custom-tag-add {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; border-radius: 50%; border: 1px dashed var(--border);
  background: none; color: var(--muted-light); font-size: 0.75rem; cursor: pointer;
  transition: all 0.15s;
}
.custom-tag-add:hover { border-color: var(--gold); color: var(--gold); }
[data-theme="dark"] .custom-tag { border-color: rgba(212,168,67,0.5); }

/* ===== PARCOURS GUIDÉ ===== */
.parcours-card {
  display: flex; align-items: center; gap: 0.75rem;
  padding: 0.65rem 0.85rem; margin: 0.35rem auto;
  max-width: 420px; border-radius: 10px; cursor: pointer;
  border: 1px solid var(--border-light); background: transparent;
  transition: all 0.2s; text-align: left; width: 100%;
  font-family: inherit; color: inherit;
}
.parcours-card:hover { background: var(--paper-warm); border-color: var(--accent-light); }
.parcours-icon {
  width: 36px; height: 36px; border-radius: 8px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; background: rgba(139,37,0,0.06);
}
.parcours-info { flex: 1; min-width: 0; }
.parcours-title { font-family: var(--serif); font-size: 0.88rem; font-weight: 500; color: var(--ink); }
.parcours-meta { font-family: var(--mono); font-size: 0.45rem; letter-spacing: 0.06em; text-transform: uppercase; color: var(--muted-light); margin-top: 0.1rem; }
.parcours-progress { width: 32px; text-align: right; font-family: var(--mono); font-size: 0.5rem; color: var(--accent); flex-shrink: 0; }
[data-theme="dark"] .parcours-icon { background: rgba(212,115,74,0.1); }

/* ===== PARCOURS BANNER IN ARTICLE ===== */
.parcours-banner {
  display: flex; align-items: center; gap: 0.6rem;
  padding: 0.5rem 0.75rem; margin-bottom: 1rem;
  border-radius: 8px; background: rgba(212,168,67,0.08);
  border: 1px solid rgba(212,168,67,0.2);
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.06em;
  text-transform: uppercase; color: var(--gold);
}
.parcours-banner-dots { display: flex; gap: 3px; }
.parcours-banner-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--border-light);
}
.parcours-banner-dot.done { background: var(--accent); }
.parcours-banner-dot.current { background: var(--gold); box-shadow: 0 0 4px var(--gold); }
.parcours-banner-next {
  margin-left: auto; cursor: pointer; color: var(--accent);
  font-weight: 600; transition: color 0.15s;
}
.parcours-banner-next:hover { color: var(--gold); }

/* ===== NOTES SEARCH ===== */
.notes-search-results {
  max-width: 420px; margin: 0.75rem auto 0;
}
.notes-result {
  padding: 0.6rem 0.75rem; border-radius: 8px; cursor: pointer;
  border: 1px solid var(--border-light); margin-bottom: 0.35rem;
  transition: all 0.15s;
}
.notes-result:hover { background: var(--paper-warm); border-color: var(--accent-light); }
.notes-result-term { font-family: var(--serif); font-size: 0.9rem; font-weight: 500; color: var(--accent); }
.notes-result-excerpt { font-size: 0.78rem; color: var(--muted); margin-top: 0.15rem; line-height: 1.5; }
.notes-result-excerpt mark { background: rgba(212,168,67,0.25); color: inherit; border-radius: 2px; padding: 0 2px; }

/* ===== ONBOARDING ===== */
.onboarding-overlay {
  position: fixed; inset: 0; z-index: 600; background: rgba(26,22,16,0.85);
  display: flex; align-items: center; justify-content: center;
  padding: 1.5rem; box-sizing: border-box;
}
.onboarding-panel {
  background: var(--paper); border-radius: 16px; padding: 2rem 1.75rem;
  width: 100%; max-width: 400px; text-align: center;
  box-shadow: 0 24px 80px rgba(0,0,0,0.4);
  position: relative; overflow: hidden;
}
.onboarding-slide { display: none; }
.onboarding-slide.active { display: block; animation: articleFadeIn 0.3s ease-out; }
.onboarding-icon { font-size: 2.5rem; margin-bottom: 1rem; }
.onboarding-title { font-family: var(--serif); font-size: 1.3rem; font-weight: 500; color: var(--ink); margin-bottom: 0.6rem; }
.onboarding-text { font-size: 0.88rem; color: var(--muted); line-height: 1.65; margin-bottom: 1.5rem; }
.onboarding-dots { display: flex; justify-content: center; gap: 6px; margin-bottom: 1.25rem; }
.onboarding-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border-light); transition: all 0.2s; }
.onboarding-dot.active { background: var(--accent); transform: scale(1.2); }
.onboarding-btn {
  padding: 0.55rem 2rem; border-radius: 8px; border: none;
  background: var(--accent); color: var(--paper); font-family: var(--mono);
  font-size: 0.65rem; letter-spacing: 0.08em; text-transform: uppercase;
  cursor: pointer; transition: all 0.15s;
}
.onboarding-btn:hover { filter: brightness(1.1); }
.onboarding-skip {
  display: block; margin: 0.75rem auto 0; background: none; border: none;
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.06em;
  text-transform: uppercase; color: var(--muted-light); cursor: pointer;
}
.onboarding-skip:hover { color: var(--accent); }

.article-enter { animation: articleFadeIn 0.3s ease-out; }
@keyframes articleFadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.welcome-enter { animation: welcomeFadeIn 0.25s ease-out; }
@keyframes welcomeFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ===== FEATURE: SORT CONTROLS ===== */
.sort-controls {
  display: flex; gap: 0.25rem; padding: 0.5rem 0.75rem;
  border-bottom: 1px solid var(--border-light);
}
.sort-btn {
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.06em;
  text-transform: uppercase; padding: 0.2rem 0.5rem; border-radius: 4px;
  border: 1px solid transparent; background: none; color: var(--muted-light);
  cursor: pointer; transition: all 0.15s;
}
.sort-btn.active { background: rgba(139,37,0,0.08); color: var(--accent); border-color: rgba(139,37,0,0.15); }
.sort-btn:hover { color: var(--accent); }

/* ===== FEATURE: PROGRESS BAR ===== */
.reading-progress-bar {
  width: 100%; height: 6px; background: var(--border-light); border-radius: 3px;
  overflow: hidden; margin-top: 0.5rem;
}
.reading-progress-fill {
  height: 100%; background: linear-gradient(90deg, var(--accent), var(--gold));
  border-radius: 3px; transition: width 0.5s ease;
}
.reading-progress-label {
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.06em;
  text-transform: uppercase; color: var(--muted-light); margin-top: 0.3rem; text-align: right;
}

/* ===== FEATURE: NOTES ===== */
.article-notes {
  margin-top: 1.5rem; padding: 1rem; background: rgba(212,168,67,0.06);
  border: 1px dashed var(--gold-light); border-radius: 8px;
}
.article-notes-title {
  font-family: var(--mono); font-size: 0.55rem; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--gold); margin-bottom: 0.5rem;
  display: flex; align-items: center; gap: 0.4rem;
}
.article-notes textarea {
  width: 100%; min-height: 80px; border: none; background: transparent;
  font-family: var(--body); font-size: 0.9rem; line-height: 1.7;
  color: var(--ink); resize: vertical; outline: none;
}
[data-theme="dark"] .article-notes { background: rgba(212,168,67,0.04); border-color: rgba(212,168,67,0.2); }
[data-theme="dark"] .article-notes textarea { color: #c8c2b6; }

/* ===== FEATURE: FICHE EXPRESS ===== */
.fiche-mode .article-body-wrap { display: none; }
.fiche-mode .footnotes-section { display: none; }
.fiche-express {
  padding: 1.5rem; background: var(--paper-warm); border: 1px solid var(--border);
  border-radius: 10px; margin-top: 1.5rem; display: none;
}
.fiche-mode .fiche-express { display: block; }
.fiche-express h4 { font-family: var(--serif); font-size: 1.1rem; font-weight: 600; color: var(--accent); margin-bottom: 0.75rem; }
.fiche-express ul { padding-left: 1.2rem; }
.fiche-express li { margin-bottom: 0.5rem; line-height: 1.6; font-size: 0.92rem; color: var(--ink); }
.fiche-toggle {
  font-family: var(--mono); font-size: 0.55rem; letter-spacing: 0.08em; text-transform: uppercase;
  padding: 0.3rem 0.7rem; border-radius: 4px; border: 1px solid var(--border);
  background: var(--paper-warm); color: var(--muted); cursor: pointer; transition: all 0.15s;
}
.fiche-toggle:hover, .fiche-toggle.active { background: var(--accent); color: #fff; border-color: var(--accent); }

/* ===== FEATURE: POSITION COUNTER ===== */
.nav-position {
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.06em;
  text-transform: uppercase; color: var(--muted-light); text-align: center;
  margin-bottom: 0.5rem;
}

/* ===== FEATURE: MOBILE ALPHA STRIP ===== */
.mobile-alpha-strip {
  position: fixed; right: 0; top: 50%; transform: translateY(-50%);
  display: none; flex-direction: column; z-index: 100; padding: 0.15rem 0;
  background: rgba(245,240,232,0.85); border-radius: 6px 0 0 6px;
  backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
  touch-action: none; user-select: none; -webkit-user-select: none;
}
.mobile-alpha-strip a {
  font-family: var(--mono); font-size: 0.4rem; font-weight: 600;
  color: var(--muted); text-decoration: none; padding: 0.12rem 0.35rem;
  text-align: center; line-height: 1; transition: color 0.1s;
}
.mobile-alpha-strip a.alpha-active { color: var(--accent); transform: scale(1.3); font-weight: 700; }
.mobile-alpha-strip a:active { color: var(--accent); }
.alpha-tooltip {
  position: fixed; right: 28px; transform: translateY(-50%);
  background: var(--accent); color: var(--paper); font-family: var(--serif);
  font-size: 1.8rem; font-weight: 600; width: 48px; height: 48px;
  border-radius: 50%; display: none; align-items: center; justify-content: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 101;
  pointer-events: none;
}
.alpha-tooltip.visible { display: flex; }
@media (max-width: 768px) {
  .mobile-alpha-strip { display: flex; }
  .focus-mode .content { padding: 1rem; }
  .focus-toggle { top: auto; bottom: 5rem; right: 0.5rem; width: 32px; height: 32px; }
  .sort-controls { padding: 0.3rem 0.5rem; }
  .fiche-express { padding: 1rem; }
}

/* ===== FEATURE: VISITED LINKS ===== */
.auto-link.visited { color: var(--muted); border-bottom-color: var(--muted-light); opacity: 0.75; }
.auto-link.visited:hover { color: var(--accent-light); opacity: 1; }

/* ===== FEATURE: SHARE BUTTON ===== */
.share-btn {
  display: inline-flex; align-items: center; gap: 0.35rem;
  font-family: var(--mono); font-size: 0.6rem; letter-spacing: 0.06em; text-transform: uppercase;
  padding: 0.4rem 0.8rem; border-radius: 6px; border: 1px solid var(--border);
  background: var(--paper-warm); color: var(--muted); cursor: pointer; transition: all 0.15s;
}
.share-btn:hover { color: var(--accent); border-color: var(--accent); }

/* ===== FEATURE: STATS MODAL ===== */
.stats-overlay {
  position: fixed; inset: 0; z-index: 500; background: rgba(26,22,16,0.7);
  display: flex; align-items: center; justify-content: center;
  padding: 1.5rem; box-sizing: border-box;
}
.stats-panel {
  background: var(--paper); border-radius: 14px; padding: 1.5rem;
  width: 100%; max-width: 420px;
  max-height: 85vh; overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
@media (max-width: 480px) {
  .stats-panel { padding: 1.25rem 1rem; max-width: 100%; border-radius: 12px; }
}
.stats-panel h3 {
  font-family: var(--serif); font-size: 1.3rem; font-weight: 500; margin-bottom: 1rem;
  color: var(--ink); text-align: center;
}
.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
@media (max-width: 360px) { .stats-grid { gap: 0.35rem; } }
.stats-card {
  padding: 0.6rem 0.4rem; background: var(--paper-warm); border: 1px solid var(--border-light);
  border-radius: 8px; text-align: center; min-width: 0;
}
.stats-card-num { font-family: var(--serif); font-size: 1.4rem; font-weight: 600; color: var(--accent); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.stats-card-label { font-family: var(--mono); font-size: 0.45rem; letter-spacing: 0.06em; text-transform: uppercase; color: var(--muted-light); margin-top: 0.15rem; }
.stats-bar-row { display: flex; align-items: center; gap: 0.35rem; margin-bottom: 0.35rem; }
.stats-bar-label { font-family: var(--mono); font-size: 0.48rem; width: 70px; text-align: right; color: var(--muted); flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.stats-bar { flex: 1; height: 8px; background: var(--border-light); border-radius: 4px; overflow: hidden; min-width: 0; }
.stats-bar-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--accent), var(--gold)); transition: width 0.5s; }
.stats-bar-val { font-family: var(--mono); font-size: 0.48rem; color: var(--muted-light); width: 28px; text-align: right; flex-shrink: 0; }
.stats-close {
  display: inline-block; margin-top: 1rem; padding: 0.45rem 1.75rem; border-radius: 6px;
  border: 1px solid var(--border); background: var(--paper-warm); font-family: var(--mono);
  font-size: 0.6rem; letter-spacing: 0.06em; text-transform: uppercase; color: var(--muted);
  cursor: pointer; transition: all 0.15s;
}
.stats-close:hover { background: var(--accent); color: var(--paper); border-color: var(--accent); }

/* ===== FEATURE: ARTICLE OF THE DAY ===== */
.article-of-day {
  margin: 1.5rem auto; max-width: 600px; padding: 1.25rem 1.5rem;
  background: linear-gradient(135deg, rgba(139,37,0,0.04), rgba(212,168,67,0.06));
  border: 1px solid rgba(212,168,67,0.25); border-radius: 10px;
  cursor: pointer; transition: all 0.2s;
}
.article-of-day:hover { border-color: var(--gold); box-shadow: 0 4px 12px var(--shadow); }
.article-of-day-badge {
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.12em;
  text-transform: uppercase; color: var(--gold); margin-bottom: 0.5rem;
  display: flex; align-items: center; gap: 0.4rem;
}
.article-of-day-title { font-family: var(--serif); font-size: 1.3rem; font-weight: 500; color: var(--ink); margin-bottom: 0.3rem; }
.article-of-day-excerpt { font-size: 0.88rem; line-height: 1.6; color: var(--muted); display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

/* ===== FEATURE: SIDEBAR RECENT ===== */
.sidebar-recent { padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border-light); }
.sidebar-recent-title {
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--muted-light); margin-bottom: 0.4rem;
  display: flex; justify-content: space-between; align-items: center;
}
.sidebar-recent-item {
  display: flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.25rem;
  border-radius: 4px; cursor: pointer; transition: background 0.15s;
  font-size: 0.78rem; color: var(--ink);
}
.sidebar-recent-item:hover { background: rgba(139,37,0,0.04); }
.sidebar-recent-time { font-family: var(--mono); font-size: 0.45rem; color: var(--muted-light); flex-shrink: 0; }

/* ===== FEATURE: COLLECTIONS (extend bookmarks) ===== */
.collection-pills { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.4rem; }
.collection-pill {
  font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.04em;
  padding: 0.15rem 0.45rem; border-radius: 10px; border: 1px solid var(--border);
  background: var(--paper-warm); color: var(--muted); cursor: pointer; transition: all 0.15s;
}
.collection-pill:hover, .collection-pill.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.collection-add-btn { border-style: dashed; }
.collection-manager { margin-top: 1rem; padding: 1rem; border: 1px solid var(--border-light); border-radius: 8px; background: var(--paper-warm); }
.collection-manager input { width: 70%; padding: 0.3rem 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-family: var(--body); font-size: 0.8rem; background: var(--paper); color: var(--ink); }

[data-theme="dark"] .stats-panel { background: var(--paper); }
[data-theme="dark"] .stats-card { background: var(--paper-warm); border-color: var(--border); }
[data-theme="dark"] .stats-close { background: var(--paper-warm); border-color: var(--border); color: var(--muted); }
[data-theme="dark"] .stats-close:hover { background: var(--accent); color: #1a1810; }
[data-theme="dark"] .stats-bar { background: var(--border); }
[data-theme="dark"] .stats-overlay { background: rgba(0,0,0,0.75); }

[data-theme="dark"] .article-of-day { background: linear-gradient(135deg, rgba(212,115,74,0.06), rgba(212,168,67,0.04)); border-color: var(--border); }
[data-theme="dark"] .fiche-express { background: var(--paper-warm); border-color: var(--border); }
[data-theme="dark"] .mobile-alpha-strip { background: rgba(26,22,16,0.88); }
[data-theme="dark"] .alpha-tooltip { background: var(--accent); }

/* Dark mode: comprehensive polish */
[data-theme="dark"] .reading-progress-bar { background: var(--border); }
[data-theme="dark"] .reading-progress-fill { opacity: 0.85; }
[data-theme="dark"] .sort-btn.active { background: rgba(212,115,74,0.1); }
[data-theme="dark"] .article-notes { background: rgba(212,168,67,0.03); border-color: var(--border); }
[data-theme="dark"] .article-notes textarea { background: transparent; color: #c8c2b6; border-color: var(--border); }
[data-theme="dark"] .article-notes textarea::placeholder { color: var(--muted-light); }
[data-theme="dark"] .collection-pill { background: var(--paper-warm); border-color: var(--border); color: var(--muted); }
[data-theme="dark"] .collection-pill:hover, [data-theme="dark"] .collection-pill.active { background: var(--accent); color: #1a1810; }
[data-theme="dark"] .collection-manager { background: var(--paper-warm); border-color: var(--border); }
[data-theme="dark"] .collection-manager input { background: var(--paper); border-color: var(--border); color: var(--ink); }
[data-theme="dark"] .fiche-toggle { background: var(--paper-warm); border-color: var(--border); color: var(--muted); }
[data-theme="dark"] .fiche-toggle:hover, [data-theme="dark"] .fiche-toggle.active { background: var(--accent); color: #1a1810; }
[data-theme="dark"] .share-btn { border-color: var(--border); color: var(--muted); }
[data-theme="dark"] .share-btn:hover { border-color: var(--accent); color: var(--accent); }
[data-theme="dark"] .article-nav-btn { background: var(--paper-warm); border-color: var(--border); }
[data-theme="dark"] .article-nav-btn:hover { border-color: var(--accent); background: rgba(212,115,74,0.08); }
[data-theme="dark"] .article-nav-home { background: var(--paper-warm); border-color: var(--border); color: var(--muted); }
[data-theme="dark"] .article-nav-home:hover { color: var(--accent); border-color: var(--accent); }
[data-theme="dark"] .article-tag { color: var(--muted); border-color: var(--border); }
[data-theme="dark"] .article-tag:hover { background: rgba(212,115,74,0.08); color: var(--accent); }
[data-theme="dark"] .btn { background: var(--paper-warm); border-color: var(--border); color: var(--muted); }
[data-theme="dark"] .btn:hover { border-color: var(--accent); color: var(--accent); }
[data-theme="dark"] .btn-primary { background: var(--accent); color: #1a1810; border-color: var(--accent); }
[data-theme="dark"] .btn-primary:hover { background: var(--accent-light); }
[data-theme="dark"] .btn-danger { color: #d47474; }
[data-theme="dark"] .import-status.success { background: rgba(93,174,117,0.08); color: #5dae75; border-color: rgba(93,174,117,0.2); }
[data-theme="dark"] .import-status.error { background: rgba(212,116,116,0.08); color: #d47474; border-color: rgba(212,116,116,0.2); }
[data-theme="dark"] .duplicate-warning { background: rgba(212,168,67,0.06); border-color: rgba(212,168,67,0.15); }

/* Dark mode: settings panel */
[data-theme="dark"] .settings-panel { background: var(--paper); }
[data-theme="dark"] .settings-handle { background: var(--border); }
[data-theme="dark"] .settings-chip { background: var(--paper-warm); border-color: var(--border); color: var(--muted); }
[data-theme="dark"] .settings-chip:hover { border-color: var(--accent); color: var(--accent); }
[data-theme="dark"] .settings-chip.active { background: var(--accent); color: #1a1810; border-color: var(--accent); }
[data-theme="dark"] .settings-theme-btn { background: var(--paper-warm); border-color: var(--border); }
[data-theme="dark"] .settings-theme-btn.active { border-color: var(--accent); }
[data-theme="dark"] .settings-slider-row input[type="range"] { background: var(--border); }
[data-theme="dark"] .settings-slider-row input[type="range"]::-webkit-slider-thumb { background: var(--accent); border-color: var(--paper); }
[data-theme="dark"] .settings-toggle { background: var(--border); }
[data-theme="dark"] .settings-toggle.on { background: var(--accent); }
[data-theme="dark"] .settings-toggle::after { background: #c8c2b6; }
[data-theme="dark"] #settingsPreview { background: var(--paper-warm); border-color: var(--border); }
[data-theme="dark"] #settingsAccent .settings-chip[data-accent="crimson"] { color: #d4734a !important; }
[data-theme="dark"] #settingsAccent .settings-chip[data-accent="navy"] { color: #5a9fce !important; }
[data-theme="dark"] #settingsAccent .settings-chip[data-accent="forest"] { color: #5dae54 !important; }
[data-theme="dark"] #settingsAccent .settings-chip[data-accent="plum"] { color: #c06aaa !important; }
[data-theme="dark"] #settingsAccent .settings-chip[data-accent="slate"] { color: #90a4bc !important; }

/* Dark mode: TOC panel */
[data-theme="dark"] .toc-panel { background: var(--paper); }
[data-theme="dark"] .toc-panel-close { background: var(--paper-warm); border-color: var(--border); color: var(--muted); }
[data-theme="dark"] .toc-panel-home { background: var(--paper-warm); border-color: var(--border); color: var(--muted); }
[data-theme="dark"] .toc-panel a { color: var(--muted); }
[data-theme="dark"] .toc-panel a:hover { background: rgba(212,115,74,0.06); }
[data-theme="dark"] .toc-panel a.active { color: var(--accent); background: rgba(212,115,74,0.06); }

/* Dark mode: graph */
[data-theme="dark"] .graph-canvas-wrap { background: var(--paper); }
[data-theme="dark"] .graph-close:hover { background: var(--border); }

/* Dark mode: editor */
[data-theme="dark"] .editor-input { background: var(--paper-warm); border-color: var(--border); color: var(--ink); }
[data-theme="dark"] .editor-textarea { background: var(--paper-warm); border-color: var(--border); color: #c8c2b6; }
[data-theme="dark"] .editor-tab { background: var(--paper-warm); border-color: var(--border); color: var(--muted); }
[data-theme="dark"] .editor-tab.active { background: var(--paper); color: var(--ink); }
[data-theme="dark"] .editor-toolbar-btn { background: var(--paper-warm); border-color: var(--border); color: var(--muted); }
[data-theme="dark"] .editor-toolbar-btn:hover { background: var(--border); color: var(--ink); }
[data-theme="dark"] .editor-help { background: rgba(212,115,74,0.04); border-color: rgba(212,115,74,0.1); }
[data-theme="dark"] .editor-preview { background: var(--paper); }
[data-theme="dark"] .editor-preview .article-body p { color: #c8c2b6; }

/* Dark mode: focus toggle active */
[data-theme="dark"] .focus-mode .focus-toggle { background: var(--accent); color: #1a1810; }
[data-theme="dark"] .back-to-top { background: var(--accent); color: #1a1810; }

/* Dark mode: overlays */
[data-theme="dark"] .graph-overlay { background: rgba(0,0,0,0.7); }
[data-theme="dark"] .toc-panel-overlay { background: rgba(0,0,0,0.6); }
[data-theme="dark"] .settings-overlay { background: rgba(0,0,0,0.7); }

/* Sepia theme */
[data-theme="sepia"] {
  --ink: #3b2f1e; --paper: #f4ead5; --paper-warm: #ede2c8;
  --accent: #8b4513; --accent-light: #a0522d; --gold: #b8860b; --gold-light: #cd950c;
  --muted: #7a6b5a; --muted-light: #a0937f;
  --border: #d4c5a9; --border-light: #e3d8c0;
  --shadow: rgba(59,47,30,0.1); --shadow-deep: rgba(59,47,30,0.18);
}
[data-theme="sepia"] body::before { opacity: 0.02; }
[data-theme="sepia"] .header { background: #3b2f1e; }
[data-theme="sepia"] .sidebar { background: var(--paper); border-color: var(--border); }
[data-theme="sepia"] .article-body p, [data-theme="sepia"] .article-body li { color: #4a3d2a; }
[data-theme="sepia"] .mobile-tab-bar { background: #3b2f1e; border-color: #5a4a35; }
[data-theme="sepia"] .mobile-article-bar { background: #3b2f1e; }
[data-theme="sepia"] .drawer-panel { background: var(--paper); }
[data-theme="sepia"] .welcome { background: var(--paper-warm); }
[data-theme="sepia"] .article-nav-btn { background: var(--paper); }
[data-theme="sepia"] .article-nav-btn:hover { border-color: var(--accent); background: var(--paper-warm); }

/* ===== READING TOOLBAR ===== */
.reading-toolbar {
  position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
  display: none; align-items: center; gap: 0.2rem; z-index: 150;
  background: var(--ink); border-radius: 28px; padding: 0.3rem 0.45rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  transition: opacity 0.3s;
}
.reading-toolbar.visible { display: flex; }

.rtb-btn {
  width: 38px; height: 38px; border-radius: 50%; border: none;
  background: transparent; color: rgba(245,240,232,0.55); cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: all 0.15s;
}
.rtb-btn:hover, .rtb-btn:active { color: #f5f0e8; background: rgba(245,240,232,0.1); }
.rtb-btn.active { color: var(--gold-light); }
.rtb-sep { width: 1px; height: 18px; background: rgba(245,240,232,0.1); margin: 0 0.1rem; }

@media (max-width: 768px) {
  .reading-toolbar { bottom: calc(var(--tab-height) + var(--safe-bottom) + 0.5rem); }
  .rtb-btn { width: 34px; height: 34px; }
}
body.has-toolbar .back-to-top { display: none !important; }
body.has-toolbar .focus-toggle { display: none !important; }
.focus-mode .reading-toolbar { bottom: 1.5rem !important; }
[data-theme="dark"] .reading-toolbar { background: #2e2a24; }
[data-theme="sepia"] .reading-toolbar { background: #3b2f1e; }

/* ===== TOC SLIDE PANEL ===== */
.toc-panel-overlay {
  position: fixed; inset: 0; z-index: 300; background: rgba(26,22,16,0.5);
  opacity: 0; transition: opacity 0.25s; pointer-events: none;
}
.toc-panel-overlay.open { opacity: 1; pointer-events: auto; }

.toc-panel {
  position: fixed; right: -320px; top: 0; bottom: 0; width: 300px; max-width: 85vw;
  background: var(--paper); z-index: 301; padding: 1.25rem 1rem;
  overflow-y: auto; transition: right 0.3s ease; box-shadow: -4px 0 20px rgba(0,0,0,0.15);
}
.toc-panel-overlay.open .toc-panel { right: 0; }

.toc-panel-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;
}
.toc-panel-title {
  font-family: var(--mono); font-size: 0.6rem; letter-spacing: 0.12em;
  text-transform: uppercase; color: var(--muted-light);
}
.toc-panel-close {
  width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--border);
  background: var(--paper-warm); color: var(--muted); cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: all 0.15s;
}
.toc-panel-close:hover { color: var(--accent); border-color: var(--accent); }

.toc-panel-home {
  display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.7rem;
  margin-bottom: 0.75rem; border-radius: 8px; border: 1px solid var(--border-light);
  background: var(--paper-warm); color: var(--muted); font-family: var(--mono);
  font-size: 0.55rem; letter-spacing: 0.06em; text-transform: uppercase;
  cursor: pointer; transition: all 0.15s; width: 100%;
}
.toc-panel-home:hover { color: var(--accent); border-color: var(--accent); }

.toc-panel a {
  display: block; padding: 0.45rem 0.6rem; margin-bottom: 0.1rem;
  color: var(--muted); text-decoration: none; font-family: var(--body);
  font-size: 0.85rem; border-radius: 6px; border-left: 3px solid transparent; transition: all 0.15s;
}
.toc-panel a:hover { background: rgba(139,37,0,0.04); color: var(--accent); }
.toc-panel a.active { color: var(--accent); border-left-color: var(--accent); background: rgba(139,37,0,0.04); font-weight: 500; }
.toc-panel a.toc-sub { padding-left: 1.5rem; font-size: 0.8rem; color: var(--muted-light); }
.toc-panel a.toc-sub::before { content: '\2013'; margin-right: 0.35rem; opacity: 0.35; }
[data-theme="dark"] .toc-panel { box-shadow: -4px 0 20px rgba(0,0,0,0.4); }

/* ===== SETTINGS PANEL ===== */
.settings-overlay {
  position: fixed; inset: 0; z-index: 400; background: rgba(26,22,16,0.6);
  display: none; align-items: flex-end; justify-content: center;
}
.settings-overlay.open { display: flex; }

.settings-panel {
  background: var(--paper); border-radius: 18px 18px 0 0; padding: 1.25rem 1.5rem 2rem;
  width: 100%; max-width: 480px; max-height: 82vh; overflow-y: auto;
  box-shadow: 0 -8px 30px rgba(0,0,0,0.2);
  transform: translateY(100%); transition: transform 0.3s ease;
}
.settings-overlay.open .settings-panel { transform: translateY(0); }
.settings-handle { width: 36px; height: 4px; border-radius: 2px; background: var(--border); margin: 0 auto 1rem; }
.settings-title { font-family: var(--serif); font-size: 1.2rem; font-weight: 500; color: var(--ink); margin-bottom: 1.25rem; text-align: center; }

.settings-group { margin-bottom: 1.1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-light); }
.settings-group:last-child { border-bottom: none; margin-bottom: 0; }
.settings-label { font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted-light); margin-bottom: 0.5rem; }
.settings-row { display: flex; gap: 0.35rem; flex-wrap: wrap; align-items: center; }

.settings-chip {
  padding: 0.35rem 0.7rem; border-radius: 20px; border: 1px solid var(--border);
  background: var(--paper-warm); color: var(--muted); font-family: var(--body);
  font-size: 0.8rem; cursor: pointer; transition: all 0.15s; white-space: nowrap;
}
.settings-chip:hover { border-color: var(--accent); color: var(--accent); }
.settings-chip.active { background: var(--accent); color: #fff !important; border-color: var(--accent); }
.settings-chip.active span { color: #fff !important; }

.settings-theme-row { display: flex; gap: 0.5rem; }
.settings-theme-btn {
  flex: 1; padding: 0.5rem; border-radius: 10px; border: 2px solid var(--border);
  background: var(--paper-warm); cursor: pointer; transition: all 0.15s; text-align: center;
}
.settings-theme-btn:hover { border-color: var(--accent); }
.settings-theme-btn.active { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
.settings-theme-preview { width: 100%; height: 22px; border-radius: 4px; margin-bottom: 0.35rem; border: 1px solid rgba(0,0,0,0.06); }
.settings-theme-name { font-family: var(--mono); font-size: 0.45rem; letter-spacing: 0.06em; text-transform: uppercase; color: var(--muted); }

.settings-slider-row { display: flex; align-items: center; gap: 0.6rem; }
.settings-slider-row input[type="range"] {
  flex: 1; height: 4px; -webkit-appearance: none; appearance: none;
  background: var(--border); border-radius: 2px; outline: none;
}
.settings-slider-row input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%;
  background: var(--accent); border: 2px solid var(--paper); cursor: pointer;
  box-shadow: 0 1px 4px var(--shadow);
}
.settings-slider-val { font-family: var(--mono); font-size: 0.55rem; color: var(--muted-light); min-width: 36px; text-align: right; }

.settings-toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 0.25rem 0; }
.settings-toggle-label { font-family: var(--body); font-size: 0.85rem; color: var(--ink); }
.settings-toggle {
  width: 42px; height: 24px; border-radius: 12px; border: none;
  background: var(--border); cursor: pointer; position: relative; transition: background 0.2s;
}
.settings-toggle.on { background: var(--accent); }
.settings-toggle::after {
  content: ''; position: absolute; top: 3px; left: 3px; width: 18px; height: 18px;
  border-radius: 50%; background: #fff; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}
.settings-toggle.on::after { transform: translateX(18px); }

@media (min-width: 769px) { .settings-panel { border-radius: 14px; margin-bottom: 2rem; } }
@media (max-width: 768px) { #settingsWidthGroup { display: none; } }
[data-theme="dark"] .settings-panel { box-shadow: 0 -8px 30px rgba(0,0,0,0.5); }
</style>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: blob:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fr.wikibooks.org; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src https://fr.wikibooks.org; img-src 'self' data: blob:;">
</head>
<body>

<!-- DESKTOP HEADER -->
<header class="header">
  <div class="header-top">
    <div class="logo" onclick="showWelcome()">
      <span class="logo-icon">φ</span>
      <h1>Dictionnaire <span>de Philosophie</span></h1>
    </div>
    <div class="header-stats"><span id="entryCount"></span> articles · Wikilivres</div>
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Changer de thème">
      <svg id="themeIconSun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      <svg id="themeIconMoon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
    </button>
    <button class="theme-toggle" onclick="openSettings()" title="Apparence" style="margin-left:0.25rem;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
    </button>
  </div>
  <div class="search-bar">
    <div class="search-input-wrap" id="searchWrap">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      <input type="text" id="searchInput" placeholder="Rechercher un concept, un philosophe…" autocomplete="off">
      <div class="search-suggestions" id="searchSuggestions"></div>
    </div>
    <button class="filter-btn" id="bookmarkFilter" onclick="toggleBookmarkFilter()">★ Favoris</button>
    <button class="add-entry-btn" onclick="openEditor()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
      Ajouter
    </button>
  </div>
  <div class="filter-bar" id="filterBar"></div>
  <nav class="alpha-nav" id="alphaNav"></nav>
</header>

<!-- MOBILE ARTICLE BAR (appears when reading) -->
<div class="mobile-article-bar" id="mobileArticleBar">
  <button class="mobile-back-btn" onclick="mobileBack()">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
  </button>
  <div class="mobile-article-title" id="mobileArticleTitle"></div>
  <button class="mobile-bookmark-btn" onclick="openTocPanel()" style="margin-right:0;" title="Sommaire">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h12"/></svg>
  </button>
  <button class="mobile-bookmark-btn" onclick="openSettings()" style="margin-right:0;" title="Apparence">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
  </button>
  <button class="mobile-bookmark-btn" id="mobileBookmarkBtn" onclick="toggleBookmark()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>
  </button>
</div>

<main class="main">
  <aside class="sidebar" id="sidebar">
    <div id="entryList"></div>
  </aside>
  <section class="content" id="content"></section>
</main>

<!-- DESKTOP BOOKMARK BUTTON -->
<button class="bookmark-btn" id="bookmarkBtn" onclick="toggleBookmark()" title="Ajouter aux favoris" style="display:none;">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>
</button>

<!-- BACK TO TOP -->
<button class="back-to-top" id="backToTop" onclick="var c=document.querySelector('.content');if(c)c.scrollTo({top:0,behavior:'smooth'});window.scrollTo({top:0,behavior:'smooth'})" title="Retour en haut">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 15l-6-6-6 6"/></svg>
</button>

<!-- FOCUS MODE TOGGLE -->
<button class="focus-toggle" id="focusToggle" onclick="toggleFocusMode()" title="Mode lecture" style="display:none;">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
</button>

<!-- READING TOOLBAR (floating pill bar) -->
<div class="reading-toolbar" id="readingToolbar">
  <button class="rtb-btn" onclick="showWelcome()" title="Accueil">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
  </button>
  <div class="rtb-sep"></div>
  <button class="rtb-btn" id="rtbToc" onclick="openTocPanel()" title="Sommaire">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h12"/></svg>
  </button>
  <button class="rtb-btn" onclick="var c=document.querySelector('.content');if(c)c.scrollTo({top:0,behavior:'smooth'});window.scrollTo({top:0,behavior:'smooth'})" title="Haut de page">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
  </button>
  <div class="rtb-sep"></div>
  <button class="rtb-btn" onclick="toggleBookmark()" id="rtbBookmark" title="Favori">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>
  </button>
  <button class="rtb-btn" onclick="toggleFocusMode()" id="rtbFocus" title="Mode lecture">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
  </button>
  <div class="rtb-sep"></div>
  <button class="rtb-btn" onclick="openSettings()" title="Apparence">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
  </button>
  <button class="rtb-btn" onclick="toggleImmersive()" title="Mode immersif">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/></svg>
  </button>
</div>

<!-- TOC SLIDE PANEL -->
<div class="toc-panel-overlay" id="tocPanelOverlay" onclick="if(event.target===this)closeTocPanel()">
  <div class="toc-panel" id="tocPanel">
    <div class="toc-panel-header">
      <div class="toc-panel-title">Sommaire</div>
      <button class="toc-panel-close" onclick="closeTocPanel()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <button class="toc-panel-home" onclick="closeTocPanel();showWelcome()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Retour à l'accueil
    </button>
    <div id="tocPanelLinks"></div>
  </div>
</div>

<!-- SETTINGS PANEL -->
<div class="settings-overlay" id="settingsOverlay" onclick="if(event.target===this)closeSettings()">
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-handle"></div>
    <div class="settings-title">Apparence</div>
    
    <div id="settingsPreview" style="padding:0.75rem;border-radius:10px;background:var(--paper-warm);border:1px solid var(--border-light);margin-bottom:1rem;overflow:hidden;">
      <div style="font-family:var(--serif);font-size:0.65rem;font-weight:600;letter-spacing:0.04em;text-transform:uppercase;color:var(--accent);margin-bottom:0.4rem;">Aperçu</div>
      <p id="settingsPreviewText" style="font-family:var(--body);font-size:0.88rem;line-height:1.9;color:var(--ink);margin:0;">La philosophie est l'amour de la sagesse. Elle interroge les fondements de l'existence, de la connaissance et de la morale à travers une réflexion méthodique.</p>
    </div>
    
    <div class="settings-group">
      <div class="settings-label">Thème</div>
      <div class="settings-theme-row">
        <button class="settings-theme-btn" data-stheme="light" onclick="setTheme('light')">
          <div class="settings-theme-preview" style="background:linear-gradient(135deg,#f5f0e8,#efe9dd)"></div>
          <div class="settings-theme-name">Clair</div>
        </button>
        <button class="settings-theme-btn" data-stheme="sepia" onclick="setTheme('sepia')">
          <div class="settings-theme-preview" style="background:linear-gradient(135deg,#f4ead5,#ede2c8)"></div>
          <div class="settings-theme-name">Sépia</div>
        </button>
        <button class="settings-theme-btn" data-stheme="dark" onclick="setTheme('dark')">
          <div class="settings-theme-preview" style="background:linear-gradient(135deg,#1a1810,#22201a)"></div>
          <div class="settings-theme-name">Sombre</div>
        </button>
      </div>
    </div>
    
    <div class="settings-group">
      <div class="settings-label">Taille du texte</div>
      <div class="settings-slider-row">
        <span style="font-family:var(--body);font-size:0.7rem;color:var(--muted)">A</span>
        <input type="range" id="settingsFontSize" min="75" max="150" step="5" oninput="setFontSize(this.value)">
        <span style="font-family:var(--body);font-size:1.1rem;color:var(--muted)">A</span>
        <span class="settings-slider-val" id="settingsFontVal"></span>
      </div>
    </div>
    
    <div class="settings-group">
      <div class="settings-label">Interligne</div>
      <div class="settings-slider-row">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2"><path d="M21 10H3M21 6H3M21 14H3M21 18H3"/></svg>
        <input type="range" id="settingsLineHeight" min="150" max="240" step="10" oninput="setLineHeight(this.value)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2"><path d="M21 10H3M21 4H3M21 16H3M21 22H3"/></svg>
        <span class="settings-slider-val" id="settingsLHVal"></span>
      </div>
    </div>
    
    <div class="settings-group" id="settingsWidthGroup">
      <div class="settings-label">Largeur du texte</div>
      <div class="settings-slider-row">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2"><path d="M9 3H4v18h5M15 3h5v18h-5"/></svg>
        <input type="range" id="settingsTextWidth" min="540" max="900" step="20" oninput="setTextWidth(this.value)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2"><path d="M7 3H2v18h5M17 3h5v18h-5"/></svg>
        <span class="settings-slider-val" id="settingsTWVal"></span>
      </div>
    </div>
    
    <div class="settings-group">
      <div class="settings-label">Police de corps</div>
      <div class="settings-row" id="settingsFontFamily">
        <button class="settings-chip" data-font="serif" onclick="setBodyFont('serif')" style="font-family:'Source Serif 4',Georgia,serif">Source Serif</button>
        <button class="settings-chip" data-font="garamond" onclick="setBodyFont('garamond')" style="font-family:'Cormorant Garamond',Georgia,serif">Cormorant</button>
        <button class="settings-chip" data-font="baskerville" onclick="setBodyFont('baskerville')" style="font-family:'Libre Baskerville',Georgia,serif">Baskerville</button>
        <button class="settings-chip" data-font="crimson" onclick="setBodyFont('crimson')" style="font-family:'Crimson Text',Georgia,serif">Crimson</button>
        <button class="settings-chip" data-font="ebgaramond" onclick="setBodyFont('ebgaramond')" style="font-family:'EB Garamond',Georgia,serif">EB Garamond</button>
        <button class="settings-chip" data-font="lora" onclick="setBodyFont('lora')" style="font-family:'Lora',Georgia,serif">Lora</button>
        <button class="settings-chip" data-font="system" onclick="setBodyFont('system')" style="font-family:system-ui,sans-serif">Sans-serif</button>
        <button class="settings-chip" data-font="mono" onclick="setBodyFont('mono')" style="font-family:'JetBrains Mono',monospace;font-size:0.75rem">Mono</button>
      </div>
    </div>
    
    <div class="settings-group">
      <div class="settings-label">Espacement des paragraphes</div>
      <div class="settings-slider-row">
        <input type="range" id="settingsParaSpacing" min="75" max="200" step="25" oninput="setParaSpacing(this.value)">
        <span class="settings-slider-val" id="settingsParaVal"></span>
      </div>
    </div>

    <div class="settings-group">
      <div class="settings-label">Options</div>
      <div class="settings-toggle-row">
        <span class="settings-toggle-label">Texte justifié</span>
        <button class="settings-toggle" id="settingsJustify" onclick="toggleJustify(this)"></button>
      </div>
      <div class="settings-toggle-row" style="margin-top:0.3rem">
        <span class="settings-toggle-label">Retrait 1re ligne</span>
        <button class="settings-toggle" id="settingsIndent" onclick="toggleIndent(this)"></button>
      </div>
      <div class="settings-toggle-row" style="margin-top:0.3rem">
        <span class="settings-toggle-label">Lettrine décorative</span>
        <button class="settings-toggle" id="settingsLettrine" onclick="toggleLettrine(this)"></button>
      </div>
      <div class="settings-toggle-row" style="margin-top:0.3rem">
        <span class="settings-toggle-label">Surlignage (sélection)</span>
        <button class="settings-toggle" id="settingsHighlight" onclick="toggleHighlightMode(this)"></button>
      </div>
    </div>
    
    <div class="settings-group">
      <div class="settings-label">Couleur d'accent</div>
      <div class="settings-row" id="settingsAccent">
        <button class="settings-chip" data-accent="crimson" onclick="setAccentColor('crimson')"><span style="color:#8b2500">●</span> Grenat</button>
        <button class="settings-chip" data-accent="navy" onclick="setAccentColor('navy')"><span style="color:#1a4a6e">●</span> Marine</button>
        <button class="settings-chip" data-accent="forest" onclick="setAccentColor('forest')"><span style="color:#2d5a27">●</span> Forêt</button>
        <button class="settings-chip" data-accent="plum" onclick="setAccentColor('plum')"><span style="color:#6b2d5b">●</span> Prune</button>
        <button class="settings-chip" data-accent="amber" onclick="setAccentColor('amber')"><span style="color:#b8860b">●</span> Ambre</button>
        <button class="settings-chip" data-accent="burgundy" onclick="setAccentColor('burgundy')"><span style="color:#722f37">●</span> Bordeaux</button>
        <button class="settings-chip" data-accent="teal" onclick="setAccentColor('teal')"><span style="color:#1a6e5e">●</span> Sarcelle</button>
        <button class="settings-chip" data-accent="slate" onclick="setAccentColor('slate')"><span style="color:#4a5568">●</span> Ardoise</button>
      </div>
    </div>
    
    <div style="display:flex;gap:0.5rem;justify-content:center;margin-top:0.5rem;">
      <button class="stats-close" onclick="resetAppearance()" style="background:transparent;border-color:var(--border-light);color:var(--muted-light);font-size:0.5rem;">Réinitialiser</button>
      <button class="stats-close" onclick="closeSettings()">Fermer</button>
    </div>
  </div>
</div>

<!-- IMMERSIVE EXIT -->
<button class="immersive-exit" id="immersiveExit" onclick="toggleImmersive()" title="Quitter le mode immersif">✕</button>

<!-- PROGRESS MAP -->
<div class="progress-map" id="progressMap" style="display:none;">
  <div class="progress-map-fill" id="progressMapFill"></div>
</div>

<!-- MOBILE ALPHABET STRIP -->
<nav class="mobile-alpha-strip" id="mobileAlphaStrip"></nav>
    <div class="alpha-tooltip" id="alphaTooltip"></div>

<!-- MOBILE BOTTOM TAB BAR -->
<nav class="mobile-tab-bar">
  <div class="mobile-tab-bar-inner">
    <button class="tab-btn active" data-tab="home" onclick="switchTab('home')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span>Accueil</span>
    </button>
    <button class="tab-btn" data-tab="index" onclick="switchTab('index')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
      <span>Index</span>
    </button>
    <button class="tab-btn" data-tab="search" onclick="switchTab('search')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      <span>Recherche</span>
    </button>
    <button class="tab-btn" data-tab="favorites" onclick="switchTab('favorites')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>
      <span>Favoris</span>
    </button>
  </div>
</nav>

<!-- MOBILE FAB (Add) -->
<button class="mobile-fab" id="mobileFab" onclick="switchTab('editor')">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
</button>

<!-- MOBILE READING PROGRESS -->
<div class="mobile-reading-progress" id="mobileReadingProgress"><div class="mobile-reading-fill" id="mobileReadingFill"></div></div>

<!-- MOBILE DRAWER -->
<div class="mobile-drawer" id="mobileDrawer">
  <div class="drawer-backdrop" onclick="closeDrawer()"></div>
  <div class="drawer-panel" id="drawerPanel">
    <div class="drawer-handle"><div class="drawer-handle-bar"></div></div>
    <div class="drawer-header" id="drawerHeader"></div>
    <div class="drawer-alpha-strip" id="drawerAlpha" style="display:none;"></div>
    <div class="drawer-content" id="drawerContent"></div>
  </div>
</div>

<script>
// ===== PERSISTENT STORAGE (IndexedDB + localStorage fallback) =====
// Android WebView peut effacer localStorage à la fermeture. IndexedDB persiste.
const PhiloDB = {
  db: null,
  STORE: 'data',
  DB_NAME: 'philo-dict',
  
  open() {
    return new Promise((resolve, reject) => {
      if (this.db) { resolve(this.db); return; }
      const req = indexedDB.open(this.DB_NAME, 1);
      req.onupgradeneeded = (e) => {
        e.target.result.createObjectStore(this.STORE);
      };
      req.onsuccess = (e) => { this.db = e.target.result; resolve(this.db); };
      req.onerror = () => resolve(null); // Fallback to localStorage
    });
  },
  
  async get(key) {
    try {
      const db = await this.open();
      if (!db) return null;
      return new Promise((resolve) => {
        const tx = db.transaction(this.STORE, 'readonly');
        const req = tx.objectStore(this.STORE).get(key);
        req.onsuccess = () => resolve(req.result !== undefined ? req.result : null);
        req.onerror = () => resolve(null);
      });
    } catch(e) { return null; }
  },
  
  async set(key, value) {
    try {
      const db = await this.open();
      if (!db) return;
      const tx = db.transaction(this.STORE, 'readwrite');
      tx.objectStore(this.STORE).put(value, key);
      tx.onerror = function(e) {
        if (e.target.error && e.target.error.name === 'QuotaExceededError') {
          console.warn('[PhiloDB] Quota exceeded for key:', key);
        }
      };
    } catch(e) {
      console.warn('[PhiloDB] IDB write error:', e.message);
    }
    // Always also write to localStorage as secondary backup
    try {
      localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value));
    } catch(e) {
      if (e.name === 'QuotaExceededError') {
        console.warn('[PhiloDB] localStorage quota exceeded for key:', key);
        // Try to free space by removing least critical data
        try { localStorage.removeItem('philo-scroll-pos'); } catch(x) {}
        try { localStorage.removeItem('philo-reading-times'); } catch(x) {}
      }
    }
  }
};

// Synchronous load from localStorage (instant), IDB will override in background
function lsGet(key, fallback) {
  try { var v = localStorage.getItem(key); return v !== null ? v : fallback; } catch(e) { return fallback; }
}

// ===== DICTIONARY DATA =====
const dictionary = [];


// ===== USER ENTRIES =====
let userEntries = safeParse(lsGet('philo-user-entries', '[]'), []);

function getAllEntries() {
  return [...dictionary, ...userEntries].sort((a, b) => a.term.localeCompare(b.term, 'fr'));
}

function saveUserEntries() {
  const json = JSON.stringify(userEntries);
  try { localStorage.setItem('philo-user-entries', json); } catch(e) {}
  PhiloDB.set('philo-user-entries', json);
}

// ===== STATE =====
let currentArticle = null;
let bookmarks = safeParse(lsGet('philo-bookmarks', '[]'), []);
let showOnlyBookmarks = false;
let activeLetterFilter = null;
let activeCategoryFilter = null;
let searchQuery = '';
let currentDrawerTab = null;
let isMobile = () => window.innerWidth <= 768;
let mobileViewingArticle = false;
let editingEntryId = null;
let massImportRunning = false;
let readArticles = new Set(safeParse(lsGet('philo-read', '[]'), []));
let readHistory = safeParse(lsGet('philo-history', '[]'), []);
let currentFontSize = parseInt(lsGet('philo-fontsize', '100'));
let suggestHighlight = -1;
let navHistory = []; // Stack of article IDs for back navigation
let sortMode = lsGet('philo-sort', 'alpha'); // alpha, category, unread, recent
let focusMode = false;
var articleNotes = safeParse(lsGet('philo-notes', '{}'), {});
var collections = safeParse(lsGet('philo-collections', '{"À relire":[],"Favoris":[]}'), {"À relire":[],"Favoris":[]});
var activeCollection = null;
var readingStartTimes = safeParse(lsGet('philo-reading-times', '{}'), {});
var appLineHeight = parseInt(lsGet('philo-line-height', '190'));
var appTextWidth = parseInt(lsGet('philo-text-width', '680'));
var appBodyFont = lsGet('philo-body-font', 'serif');
var appJustify = lsGet('philo-justify', 'false') === 'true';
var appIndent = lsGet('philo-indent', 'true') === 'true';
var appAccent = lsGet('philo-accent', 'crimson');
var tocPanelHeadings = []; // cached for TOC panel
var appParaSpacing = parseInt(lsGet('philo-para-spacing', '125'));
var appLettrine = lsGet('philo-lettrine', 'true') === 'true';
var articleScrollPos = safeParse(lsGet('philo-scroll-pos', '{}'), {});
var articleHighlights = safeParse(lsGet('philo-highlights', '{}'), {});

// ===== THEME =====
function initTheme() {
  const saved = lsGet('philo-theme', 'light');
  document.documentElement.setAttribute('data-theme', saved);
  updateThemeIcons(saved);
}

function toggleTheme() {
  var current = document.documentElement.getAttribute('data-theme') || 'light';
  var order = ['light', 'sepia', 'dark'];
  var idx = order.indexOf(current);
  var next = order[(idx + 1) % 3];
  setTheme(next);
}

function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  PhiloDB.set('philo-theme', theme);
  updateThemeIcons(theme);
  updateSettingsThemeButtons(theme);
}

function updateSettingsThemeButtons(theme) {
  document.querySelectorAll('.settings-theme-btn').forEach(function(btn) {
    btn.classList.toggle('active', btn.getAttribute('data-stheme') === theme);
  });
}

function updateThemeIcons(theme) {
  var isDark = theme === 'dark';
  document.querySelectorAll('[id$="ThemeSun"], [id$="IconSun"]').forEach(function(el) {
    el.style.display = isDark ? 'none' : 'block';
  });
  document.querySelectorAll('[id$="ThemeMoon"], [id$="IconMoon"]').forEach(function(el) {
    el.style.display = isDark ? 'block' : 'none';
  });
  // Update settings theme buttons if open
  updateSettingsThemeButtons(theme);
}

// ===== SEARCH HELPERS =====
function normalizeText(str) {
  return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
}

// Synonym groups for philosophy search
var philosophySynonyms = {
  'morale': ['ethique','vertu','devoir','bien','mal'],
  'ethique': ['morale','vertu','devoir','bien','mal'],
  'connaissance': ['savoir','epistemologie','science','verite'],
  'epistemologie': ['connaissance','savoir','science'],
  'savoir': ['connaissance','epistemologie'],
  'verite': ['connaissance','certitude','evidence'],
  'liberte': ['libre arbitre','autonomie','emancipation','volonte'],
  'dieu': ['theologie','divin','absolu','transcendance'],
  'theologie': ['dieu','divin','religion'],
  'ame': ['esprit','psyche','conscience'],
  'esprit': ['ame','conscience','pensee','intellect','entendement'],
  'conscience': ['esprit','ame','cogito','sujet'],
  'beau': ['beaute','esthetique','art','sublime'],
  'esthetique': ['beau','beaute','art','sublime','gout'],
  'politique': ['etat','pouvoir','democratie','gouvernement','cite'],
  'etat': ['politique','pouvoir','souverainete','gouvernement'],
  'justice': ['droit','equite','loi','morale'],
  'raison': ['rationalisme','logos','logique','entendement'],
  'logique': ['raison','raisonnement','syllogisme','dialectique'],
  'existence': ['etre','ontologie','dasein','phenomenologie'],
  'etre': ['existence','ontologie','substance','essence'],
  'ontologie': ['etre','existence','metaphysique'],
  'metaphysique': ['ontologie','etre','substance','essence','absolu'],
  'langage': ['langue','signe','mot','semantique','hermeneutique'],
  'bonheur': ['felicite','eudemonisme','plaisir','hedonisme'],
  'mort': ['mortalite','finitude','neant'],
  'temps': ['duree','devenir','eternite','temporalite'],
  'nature': ['physis','cosmos','monde','univers'],
  'histoire': ['historicisme','devenir','dialectique','progres'],
  'perception': ['sensation','experience','phenomene','sensible'],
  'idee': ['concept','notion','representation','forme'],
  'materialisme': ['matiere','corps','physique'],
  'idealisme': ['idee','esprit','transcendantal'],
  'empirisme': ['experience','sensation','perception','induction'],
  'rationalisme': ['raison','innee','deduction','descartes']
};

function expandWithSynonyms(term) {
  var n = normalizeText(term);
  var synonyms = philosophySynonyms[n];
  return synonyms ? [n].concat(synonyms) : [n];
}

function fuzzyMatch(needle, haystack) {
  const n = normalizeText(needle);
  const h = normalizeText(haystack);
  // Exact substring first
  if (h.includes(n)) return true;
  // Synonym matching
  var expanded = expandWithSynonyms(needle);
  if (expanded.length > 1 && expanded.some(function(syn) { return h.includes(syn); })) return true;
  // Token matching: all words of needle must appear in haystack
  const words = n.split(/\s+/).filter(w => w.length > 1);
  if (words.length > 1) {
    return words.every(w => h.includes(w));
  }
  // Levenshtein-lite: allow 1 char difference for short terms
  if (n.length >= 4 && n.length <= 12) {
    const tokens = h.split(/[\s,\xb7:;.()\[\]]+/);
    return tokens.some(t => {
      if (Math.abs(t.length - n.length) > 1) return false;
      let diffs = 0;
      for (let i = 0; i < Math.max(t.length, n.length); i++) {
        if (t[i] !== n[i]) diffs++;
        if (diffs > 1) return false;
      }
      return true;
    });
  }
  // Prefix matching (3+ chars)
  if (n.length >= 3) {
    const tokens = h.split(/[\s,\xb7:;.()\[\]]+/);
    return tokens.some(t => t.startsWith(n));
  }
  return false;
}

// ===== CATEGORY FILTERS =====
function getCategories() {
  const cats = new Map();
  getAllEntries().forEach(e => {
    e.category.split(' \u00b7 ').forEach(c => {
      const ct = c.trim();
      cats.set(ct, (cats.get(ct) || 0) + 1);
    });
  });
  // Sort by count desc, take top 12
  return [...cats.entries()].sort((a, b) => b[1] - a[1]).slice(0, 12).map(e => e[0]);
}

function buildFilterBar() {
  const bar = document.getElementById('filterBar');
  if (!bar) return;
  const cats = getCategories();
  bar.innerHTML = cats.map(c => 
    `<button class="filter-chip ${activeCategoryFilter === c ? 'active' : ''}" onclick="toggleCategoryFilter('${escapeAttr(c)}')">${escapeHtml(c)}</button>`
  ).join('');
}

function toggleCategoryFilter(cat) {
  activeCategoryFilter = activeCategoryFilter === cat ? null : cat;
  buildFilterBar();
  renderEntryList();
}

// ===== AUTO-LINKING =====
function autoLinkContent(html, currentId) {
  const allEntries = getAllEntries();
  // Build lookup of terms → ids (longest first to avoid partial matches)
  const terms = allEntries
    .filter(e => e.id !== currentId)
    .map(e => ({ term: e.term, id: e.id }))
    .sort((a, b) => b.term.length - a.term.length);
  
  // Only replace in text nodes (not inside tags or existing links)
  // We process the HTML by splitting around tags
  const linked = new Set();
  
  for (const { term, id } of terms) {
    if (linked.has(id)) continue;
    // Escape special regex characters in term
    const escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    // Skip terms that would create problematic regex
    if (escaped.length < 2) continue;
    try {
    // Match whole word, case insensitive, but not inside HTML tags or already linked
    const regex = new RegExp(`(?<![<\\/\\w"=])\\b(${escaped})\\b(?![^<]*>)(?![^<]*<\\/a>)`, 'i');
    if (regex.test(html)) {
      html = html.replace(regex, `<a class="auto-link" onclick="navigateTo('${safeId(id)}')">$1</a>`);
      linked.add(id);
    }
    } catch(e) { /* skip term with bad regex */ }
  }
  
  return html;
}

// ===== AUTO-DETECT RELATED =====
function detectRelated(entry) {
  const allEntries = getAllEntries();
  const content = (entry.content + ' ' + entry.definition + ' ' + entry.tags.join(' ')).toLowerCase();
  const related = [];
  
  for (const other of allEntries) {
    if (other.id === entry.id) continue;
    if (entry.related && entry.related.includes(other.id)) continue;
    // Check if the other term appears in this article's content
    const termNorm = normalizeText(other.term);
    const contentNorm = normalizeText(content);
    if (contentNorm.includes(termNorm) && termNorm.length > 3) {
      related.push(other.id);
    }
  }
  
  return related.slice(0, 8);
}

// ===== MASS IMPORT =====
async function massImportFromWikibooks() {
  if (massImportRunning) return;
  massImportRunning = true;
  
  const statusEl = document.getElementById('massImportStatus');
  const progressFill = document.getElementById('massImportFill');
  const progressPanel = document.getElementById('massImportProgress');
  const btn = document.getElementById('massImportBtn');
  
  if (progressPanel) progressPanel.style.display = 'block';
  if (btn) btn.disabled = true;
  
  const setStatus = (text, pct) => {
    if (statusEl) statusEl.innerHTML = `<span>${text}</span><span>${Math.round(pct)}%</span>`;
    if (progressFill) progressFill.style.width = pct + '%';
  };
  
  setStatus('R\u00e9cup\u00e9ration de la liste des articles\u2026', 2);
  
  // Step 1: Get list of all subpages of Dictionnaire_de_philosophie
  let pageList = [];
  try {
    const data = await jsonp(
      'https://fr.wikibooks.org/w/api.php?action=query&list=allpages'
      + '&apprefix=Dictionnaire+de+philosophie/'
      + '&apnamespace=0&aplimit=500&format=json'
    );
    if (data.query && data.query.allpages) {
      pageList = data.query.allpages.map(p => p.title);
    }
  } catch (e) {
    setStatus('\u2717 Impossible de r\u00e9cup\u00e9rer la liste. V\u00e9rifiez votre connexion.', 0);
    massImportRunning = false;
    if (btn) btn.disabled = false;
    return;
  }
  
  if (pageList.length === 0) {
    setStatus('\u2717 Aucun article trouv\u00e9 sur Wikilivres.', 0);
    massImportRunning = false;
    if (btn) btn.disabled = false;
    return;
  }
  
  // Filter out already existing entries and single-letter index pages
  const existingTerms = new Set(getAllEntries().map(e => normalizeText(e.term)));
  const toImport = pageList.filter(title => {
    const display = title.split('/').pop();
    // Skip single-letter index pages (A, B, C, etc.)
    if (/^[A-Z\u00C0-\u00FF]$/i.test(display.trim())) return false;
    // Skip meta pages (Sommaire, Index, etc.)
    if (/^(Sommaire|Index|Pr[eé]face)$/i.test(display.trim())) return false;
    return !existingTerms.has(normalizeText(display));
  });
  
  setStatus(`${toImport.length} articles \u00e0 importer (${pageList.length - toImport.length} d\u00e9j\u00e0 pr\u00e9sents)`, 5);
  
  if (toImport.length === 0) {
    setStatus('✓ Tous les articles sont déjà importés. <a href="#" onclick="event.preventDefault();document.getElementById(\'updateOverlay\')?.remove();checkForUpdates();" style="color:var(--accent);text-decoration:underline;">Vérifier les mises à jour</a>', 100);
    massImportRunning = false;
    if (btn) btn.disabled = false;
    return;
  }
  
  // Step 2: Import each article
  let imported = 0;
  let failed = 0;
  
  for (let i = 0; i < toImport.length; i++) {
    const title = toImport[i];
    const pct = 5 + (95 * (i + 1) / toImport.length);
    const displayTitle = title.split('/').pop().replace(/\//g, ' & ');
    
    setStatus(`${displayTitle} (${i + 1}/${toImport.length})`, pct);
    
    try {
      const data = await jsonp(
        'https://fr.wikibooks.org/w/api.php?action=query'
        + '&titles=' + encodeURIComponent(title)
        + '&prop=revisions&rvprop=content|ids|timestamp&rvslots=main'
        + '&format=json&formatversion=2'
      );
      
      const page = data.query?.pages?.[0];
      if (page && !page.missing && page.revisions?.length > 0) {
        const rev = page.revisions[0];
        const wikitext = cleanWikitext(rev.slots?.main?.content || '');
        if (wikitext.length > 50) {
          const parsed = parseMediaWiki(wikitext);
          const letter = displayTitle.charAt(0).toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
          const defMatch = parsed.html.match(/<p>([\s\S]*?)<\/p>/);
          const definition = defMatch ? defMatch[1].replace(/<[^>]+>/g, '').substring(0, 300) : '';
          
          const entry = {
            id: 'user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6),
            term: displayTitle,
            letter: /^[A-Z]$/.test(letter) ? letter : displayTitle.charAt(0).toUpperCase(),
            category: guessCategory(wikitext, displayTitle),
            etymology: '',
            definition,
            content: parsed.html,
            tags: guessTags(wikitext).split(', ').filter(Boolean),
            refs: parsed.refs,
            related: [],
            _userEntry: true,
            _wikiSource: wikitext,
            _wikiRevId: rev.revid || null,
            _wikiTimestamp: rev.timestamp || null,
            _wikiTitle: title,
            _importDate: new Date().toISOString()
          };
          
          userEntries.push(entry);
          imported++;
          
          // Periodic save every 10 articles (prevents data loss on crash)
          if (imported % 10 === 0) {
            saveUserEntries();
          }
        }
      }
    } catch (e) {
      failed++;
    }
    
    // Small delay to not hammer the API
    await new Promise(r => setTimeout(r, 150));
  }
  
  // Final save and refresh
  saveUserEntries();
  updateEntryCount();
  buildAlphaNav();
  buildFilterBar();
  renderEntryList();
  
  // Ensure completion shows even if DOM was partially refreshed
  const finalStatus = document.getElementById('massImportStatus');
  const finalFill = document.getElementById('massImportFill');
  if (finalStatus) finalStatus.innerHTML = `<span>✓ Import terminé\u202f: ${imported} articles importés` + (failed > 0 ? `, ${failed} échecs` : '') + `</span><span>100%</span>`;
  if (finalFill) finalFill.style.width = '100%';
  
  massImportRunning = false;
  if (btn) btn.disabled = false;
} // if editing an existing user entry

// ===== MEDIAWIKI PARSER =====
function parseMediaWiki(wikitext) {
  // Extract refs
  const refs = [];
  let text = wikitext.replace(/<ref>([\s\S]*?)<\/ref>/g, (_, content) => {
    refs.push(content.trim());
    return '';
  });
  
  // Remove {{references}} and similar
  text = text.replace(/\{\{references\}\}/gi, '');
  
  // Handle {{e}} → <sup>e</sup>
  text = text.replace(/\{\{e\}\}/g, '<sup>e</sup>');
  
  // Split into sections, extract bibliography and notes
  const lines = text.split('\n');
  let bodyLines = [];
  let bibLines = [];
  let inBib = false;
  let inNotes = false;
  let skipSection = false;
  
  for (const line of lines) {
    const trimmed = line.trim();
    
    // Detect section headers (= Title = or == Title ==)
    const h1Match = trimmed.match(/^=\s*([^=].+?[^=])\s*=$/);
    const h2Match = trimmed.match(/^==\s*(.+?)\s*==$/);
    // Single = heading (top-level mediawiki heading)
    if (h1Match && !trimmed.startsWith('==')) {
      const title = h1Match[1].trim();
      if (/^(notes?\s*(et\s*)?r[eé]f[eé]rences?|r[eé]f[eé]rences?)$/i.test(title)) {
        inNotes = true; inBib = false; skipSection = true; continue;
      }
      if (/^bibliographie$/i.test(title)) {
        inBib = true; inNotes = false; skipSection = true; continue;
      }
      if (/^(sources?\s*primaires?|[eé]tudes?)$/i.test(title)) { continue; }
      skipSection = false; inBib = false; inNotes = false;
    }
    if (h2Match && !trimmed.startsWith('===')) {
      const title = h2Match[1].trim();
      if (/^(notes?\s*(et\s*)?r[eé]f[eé]rences?|r[eé]f[eé]rences?)$/i.test(title)) {
        inNotes = true; inBib = false; skipSection = true; continue;
      }
      if (/^bibliographie$/i.test(title)) {
        inBib = true; inNotes = false; skipSection = true; continue;
      }
      if (/^(sources?\s*primaires?|[eé]tudes?)$/i.test(title)) {
        // Sub-category of bibliography, keep collecting
        continue;
      }
      skipSection = false;
      inBib = false;
      inNotes = false;
    }
    
    const h3Match = trimmed.match(/^===\s*(.+?)\s*===$/);
    if (h3Match) {
      const title = h3Match[1].trim();
      if (/^(sources?\s*primaires?|[eé]tudes?)$/i.test(title)) {
        // Sub-category of bibliography
        inBib = true; continue;
      }
      if (inBib || inNotes) continue;
    }
    
    if (inNotes && !inBib) continue; // skip notes section content
    
    if (inBib) {
      // Collect bibliography entries
      if (trimmed.startsWith('*')) {
        bibLines.push(trimmed.replace(/^\*\s*/, ''));
      }
      continue;
    }
    
    if (!skipSection) {
      bodyLines.push(line);
    }
  }
  
  // Convert body lines to HTML
  const html = convertWikiLinesToHtml(bodyLines);
  
  // Build refs from <ref> tags + bibliography
  const allRefs = [];
  // From bibliography
  for (const bib of bibLines) {
    allRefs.push(convertInlineWiki(bib));
  }
  // From inline refs (if no bibliography provided, use these)
  if (allRefs.length === 0) {
    for (const r of refs) {
      allRefs.push(convertInlineWiki(r));
    }
  }
  
  return { html: sanitizeHtml(html), refs: allRefs.map(function(r) { return sanitizeHtml(r); }) };
}

function convertWikiLinesToHtml(lines) {
  let html = '';
  let inList = false;
  let paragraphBuffer = [];
  
  function flushParagraph() {
    if (paragraphBuffer.length > 0) {
      const text = paragraphBuffer.join(' ').trim();
      if (text) html += `<p>${convertInlineWiki(text)}</p>\n`;
      paragraphBuffer = [];
    }
  }
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const trimmed = line.trim();
    
    // Empty line → flush paragraph
    if (trimmed === '') {
      flushParagraph();
      if (inList) { html += '</ul>\n'; inList = false; }
      continue;
    }
    
    // H1 (= Title =) → h3 (top-level section)
    const h1Match = trimmed.match(/^=\s*([^=].+?[^=])\s*=$/);
    if (h1Match && !trimmed.startsWith('==')) {
      flushParagraph();
      if (inList) { html += '</ul>\n'; inList = false; }
      html += `<h3>${convertInlineWiki(h1Match[1])}</h3>\n`;
      continue;
    }

    // H2 (== Title ==) → h3 (section) or h4 if h1 headings exist in doc
    const h2Match = trimmed.match(/^==\s*(.+?)\s*==$/);
    if (h2Match && !trimmed.startsWith('===')) {
      flushParagraph();
      if (inList) { html += '</ul>\n'; inList = false; }
      // Check if this document uses = headings (detect by scanning)
      const hasH1 = lines.some(l => /^=\s*[^=].+[^=]\s*=$/.test(l.trim()) && !l.trim().startsWith('=='));
      html += hasH1 
        ? `<h4>${convertInlineWiki(h2Match[1])}</h4>\n`
        : `<h3>${convertInlineWiki(h2Match[1])}</h3>\n`;
      continue;
    }
    
    // H3 (=== Title ===) → h4 (subsection)
    const h3Match = trimmed.match(/^===\s*(.+?)\s*===$/);
    if (h3Match) {
      flushParagraph();
      if (inList) { html += '</ul>\n'; inList = false; }
      html += `<h4>${convertInlineWiki(h3Match[1])}</h4>\n`;
      continue;
    }
    
    // Indented line (: prefix) → blockquote
    if (trimmed.startsWith(':')) {
      flushParagraph();
      if (inList) { html += '</ul>\n'; inList = false; }
      // Collect consecutive indented lines
      let blockLines = [trimmed.replace(/^:+\s*/, '')];
      while (i + 1 < lines.length && lines[i + 1].trim().startsWith(':')) {
        i++;
        blockLines.push(lines[i].trim().replace(/^:+\s*/, ''));
      }
      html += `<blockquote>${convertInlineWiki(blockLines.join('<br>'))}</blockquote>\n`;
      continue;
    }
    
    // List item (* prefix)
    if (trimmed.startsWith('*') && !trimmed.startsWith('**')) {
      flushParagraph();
      if (!inList) { html += '<ul>\n'; inList = true; }
      html += `<li>${convertInlineWiki(trimmed.replace(/^\*\s*/, ''))}</li>\n`;
      continue;
    }
    
    // Regular text → accumulate in paragraph
    paragraphBuffer.push(trimmed);
  }
  
  flushParagraph();
  if (inList) html += '</ul>\n';
  
  return html;
}

function convertInlineWiki(text) {
  // Bold: '''text''' → <strong>
  text = text.replace(/'''(.+?)'''/g, '<strong>$1</strong>');
  // Italic: ''text'' → <em>
  text = text.replace(/''(.+?)''/g, '<em>$1</em>');
  // {{e}} remnants
  text = text.replace(/\{\{e\}\}/g, '<sup>e</sup>');
  // Remove remaining {{ }}
  text = text.replace(/\{\{.*?\}\}/g, '');
  // External links: [url text]
  text = text.replace(/\[https?:\/\/\S+\s+(.+?)\]/g, '$1');
  // Internal wikilinks: [[Page|text]] or [[Page]]
  text = text.replace(/\[\[([^|\]]+)\|([^\]]+)\]\]/g, '$2');
  text = text.replace(/\[\[([^\]]+)\]\]/g, '$1');
  // Keep <br/> <br> <sup> <sub> <em> <strong>
  // Strip other HTML-like tags except safe ones
  return text;
}

// ===== EDITOR =====
function openEditor(entryId) {
  editingEntryId = entryId || null;
  mobileViewingArticle = false;
  currentArticle = null;
  
  if (isMobile()) {
    closeDrawer();
    document.getElementById('mobileArticleBar').style.display = 'none';
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-tab="editor"]')?.classList.add('active');
  }
  
  document.getElementById('bookmarkBtn').style.display = 'none';
  
  const content = document.getElementById('content');
  
  // Pre-fill if editing
  let existingTitle = '', existingCat = '', existingEtym = '', existingTags = '', existingWiki = '';
  let topTitle = 'Nouvel article';
  
  if (editingEntryId) {
    const entry = userEntries.find(e => e.id === editingEntryId);
    if (entry) {
      existingTitle = entry.term;
      existingCat = entry.category;
      existingEtym = entry.etymology;
      existingTags = entry.tags.join(', ');
      existingWiki = entry._wikiSource || '';
      topTitle = 'Modifier l\u2019article';
    }
  }
  
  content.innerHTML = `
    <div class="editor-container">
      <div class="editor-topbar">
        <h2>${topTitle}</h2>
        <div class="editor-actions">
          <button class="btn" onclick="showWelcome()">Annuler</button>
          <button class="btn btn-primary" onclick="saveEntry()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align:-1px"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
            Enregistrer
          </button>
        </div>
      </div>
      
      ${!editingEntryId ? `<div class="import-panel">
        <div class="import-panel-title">Importer depuis Wikilivres</div>
        <div class="import-panel-desc">Saisissez le nom d'un article du Dictionnaire de philosophie, ou collez une URL Wikilivres.</div>
        <div class="import-row">
          <input class="import-input" id="importInput" placeholder="Ex : Substance, Liberté, Concept…  ou URL complète" onkeydown="if(event.key==='Enter')importFromWikibooks()">
          <button class="import-btn" id="importBtn" onclick="importFromWikibooks()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Importer
          </button>
        </div>
        <div class="import-status" id="importStatus"></div>
        <div class="import-or">ou saisie manuelle</div>
      </div>` : ''}
      
      <div class="editor-field">
        <label class="editor-label">Titre de l'article</label>
        <input class="editor-input" id="editorTitle" placeholder="Ex : Substance, Libert\u00e9, Temps\u2026" value="${escapeAttr(existingTitle)}" oninput="checkDuplicate(this.value)">
        <div id="duplicateWarning"></div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <div class="editor-field">
          <label class="editor-label">Catégorie</label>
          <input class="editor-input editor-input-small" id="editorCategory" placeholder="Ex : Métaphysique · Ontologie" value="${escapeAttr(existingCat)}">
        </div>
        <div class="editor-field">
          <label class="editor-label">Mots-clés (séparés par des virgules)</label>
          <input class="editor-input editor-input-small" id="editorTags" placeholder="Ex : Aristote, Heidegger, Ontologie" value="${escapeAttr(existingTags)}">
        </div>
      </div>
      
      <div class="editor-field">
        <label class="editor-label">Étymologie</label>
        <input class="editor-input editor-input-small" id="editorEtymology" placeholder="Ex : Du grec ousia (οὐσία), « ce qui est »" value="${escapeAttr(existingEtym)}">
      </div>
      
      <div class="editor-field">
        <label class="editor-label">Contenu (format MediaWiki)</label>
        <div class="editor-tabs" style="display:flex;align-items:center;">
          <button class="editor-tab active" onclick="showEditorTab('write', this)">Écriture</button>
          <button class="editor-tab" onclick="showEditorTab('preview', this)">Aperçu</button>
          <div class="editor-mode-switch" style="margin-left:auto;">
            <button class="editor-mode-btn active" data-mode="wysiwyg" onclick="switchEditorMode('wysiwyg')">Visuel</button>
            <button class="editor-mode-btn" data-mode="wikitext" onclick="switchEditorMode('wikitext')">Wiki</button>
          </div>
        </div>
        <div id="editorWritePanel">
          <div class="editor-toolbar">
            <button onclick="editorMode==='wysiwyg'?wysiwygExec('bold'):insertMarkup('bold')" title="Gras"><b>G</b></button>
            <button onclick="editorMode==='wysiwyg'?wysiwygExec('italic'):insertMarkup('italic')" title="Italique"><i>I</i></button>
            <div class="sep"></div>
            <button onclick="editorMode==='wysiwyg'?wysiwygInsertHeading(2):insertMarkup('h2')" title="Titre de section">H2</button>
            <button onclick="editorMode==='wysiwyg'?wysiwygInsertHeading(3):insertMarkup('h3')" title="Sous-section">H3</button>
            <div class="sep"></div>
            <button onclick="editorMode==='wysiwyg'?wysiwygExec('insertUnorderedList'):insertMarkup('list')" title="Liste \u00e0 puces">\u2022</button>
            <button onclick="editorMode==='wysiwyg'?wysiwygInsertQuote():insertMarkup('quote')" title="Citation">\u275d</button>
            <button onclick="insertMarkup('ref')" title="R\u00e9f\u00e9rence">[n]</button>
          </div>
          <div class="wysiwyg-area" id="wysiwygArea" contenteditable="true"></div>
          <textarea class="editor-textarea" id="editorContent" style="display:none;" placeholder="Collez ici votre texte au format MediaWiki\u2026

== Titre de section ==

Paragraphe de texte avec ''italique'' et '''gras'''.

=== Sous-section ===

* Élément de liste
* Autre élément

<ref>Auteur, Titre, Éditeur, Année</ref>">${escapeHtml(existingWiki)}</textarea>
        </div>
        <div id="editorPreviewPanel" style="display:none;">
          <div class="editor-preview" id="editorPreviewContent">
            <p style="color:var(--muted-light);font-style:italic;">Cliquez sur « Aperçu » pour voir le rendu…</p>
          </div>
        </div>
      </div>
      
      <details class="editor-help">
        <summary>Aide — Syntaxe MediaWiki</summary>
        <div class="editor-help-content">
          <code>== Titre ==</code> → Titre de section<br>
          <code>=== Sous-titre ===</code> → Sous-section<br>
          <code>''italique''</code> → <em>italique</em><br>
          <code>'''gras'''</code> → <strong>gras</strong><br>
          <code>* élément</code> → Liste à puces<br>
          <code>:texte indenté</code> → Citation / bloc indenté<br>
          <code>&lt;ref&gt;Source&lt;/ref&gt;</code> → Référence (extraite automatiquement)<br>
          <code>{{e}}</code> → <sup>e</sup> (exposant ordinal)<br>
          <code>== Bibliographie ==</code> → Section spéciale : les entrées <code>* …</code> deviennent les références affichées<br>
          <code>== Notes et références ==</code> → Section ignorée dans le corps de l'article
        </div>
      </details>
    </div>`;
  
  if (!isMobile()) content.scrollTop = 0;
  else window.scrollTo({ top: 0, behavior: 'instant' });
  
  // Init WYSIWYG with existing content
  setTimeout(function() {
    var area = document.getElementById('wysiwygArea');
    var ta = document.getElementById('editorContent');
    if (area && ta && ta.value) {
      area.innerHTML = wikitextToHtml(ta.value);
    }
    editorMode = 'wysiwyg';
  }, 50);
}

function escapeAttr(s) { return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
function escapeHtml(s) { return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

// ===== WIKIBOOKS IMPORT (JSONP — bypasses CORS/sandbox) =====
function jsonp(url) {
  return new Promise((resolve, reject) => {
    // Validate URL domain
    try {
      var parsed = new URL(url);
      if (parsed.hostname !== 'fr.wikibooks.org') {
        reject(new Error('Unauthorized domain: ' + parsed.hostname));
        return;
      }
    } catch(e) { reject(new Error('Invalid URL')); return; }
    const cbName = '_wbcb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
    const timeout = setTimeout(() => {
      delete window[cbName];
      script.remove();
      reject(new Error('timeout'));
    }, 10000);
    
    window[cbName] = (data) => {
      clearTimeout(timeout);
      delete window[cbName];
      script.remove();
      resolve(data);
    };
    
    const script = document.createElement('script');
    script.src = url + '&callback=' + cbName;
    script.onerror = () => {
      clearTimeout(timeout);
      delete window[cbName];
      script.remove();
      reject(new Error('network'));
    };
    document.head.appendChild(script);
  });
}

async function importFromWikibooks() {
  const input = document.getElementById('importInput');
  const statusEl = document.getElementById('importStatus');
  const btn = document.getElementById('importBtn');
  let raw = input.value.trim();
  
  if (!raw) { input.focus(); return; }
  
  // Extract page title from URL or use as concept name
  let pageTitle = '';
  const urlMatch = raw.match(/fr\.wikibooks\.org\/wiki\/([^#?]+)/);
  const urlMatch2 = raw.match(/fr\.wikibooks\.org\/w\/index\.php\?title=([^&#]+)/);
  
  if (urlMatch) {
    pageTitle = decodeURIComponent(urlMatch[1].replace(/_/g, ' ').trim());
  } else if (urlMatch2) {
    pageTitle = decodeURIComponent(urlMatch2[1].replace(/_/g, ' ').trim());
  } else {
    pageTitle = raw.trim();
  }
  
  // Build list of titles to try
  let pagesToTry = [];
  if (pageTitle.toLowerCase().startsWith('dictionnaire')) {
    pagesToTry.push(pageTitle);
  } else {
    const cap = pageTitle.charAt(0).toUpperCase() + pageTitle.slice(1);
    const low = pageTitle.charAt(0).toLowerCase() + pageTitle.slice(1);
    pagesToTry.push('Dictionnaire de philosophie/' + cap);
    if (cap !== low) pagesToTry.push('Dictionnaire de philosophie/' + low);
    // Variant with accented first letter kept as-is
    pagesToTry.push('Dictionnaire de philosophie/' + pageTitle);
  }
  // Deduplicate
  pagesToTry = [...new Set(pagesToTry)];
  
  statusEl.className = 'import-status loading';
  statusEl.innerHTML = '\u23f3 Chargement depuis fr.wikibooks.org\u2026';
  btn.disabled = true;
  
  let wikitext = null;
  let usedTitle = '';
  
  for (const title of pagesToTry) {
    try {
      const apiUrl = 'https://fr.wikibooks.org/w/api.php?action=query'
        + '&titles=' + encodeURIComponent(title)
        + '&prop=revisions&rvprop=content|ids|timestamp&rvslots=main'
        + '&format=json&formatversion=2';
      
      const data = await jsonp(apiUrl);
      
      if (data.query && data.query.pages) {
        const page = data.query.pages[0];
        if (page && !page.missing && page.revisions && page.revisions.length > 0) {
          const rev = page.revisions[0];
          wikitext = (rev.slots && rev.slots.main && rev.slots.main.content) || null;
          if (wikitext) {
            usedTitle = page.title || title;
            break;
          }
        }
      }
    } catch (e) {
      console.log('JSONP attempt failed for:', title, e.message);
    }
  }
  
  btn.disabled = false;
  
  if (!wikitext) {
    const tried = pagesToTry.map(t => '\u00ab\u202f' + t + '\u202f\u00bb').join(', ');
    statusEl.className = 'import-status error';
    statusEl.innerHTML = '\u2717 Article introuvable. Pages test\u00e9es\u202f: ' + tried 
      + '. <a href="https://fr.wikibooks.org/wiki/Dictionnaire_de_philosophie" target="_blank" style="color:inherit;text-decoration:underline;">V\u00e9rifier sur Wikilivres</a>';
    return;
  }
  
  // Success — fill the editor
  wikitext = cleanWikitext(wikitext);
  
  let displayTitle = usedTitle;
  if (displayTitle.includes('/')) {
    displayTitle = displayTitle.split('/').pop();
  }
  
  document.getElementById('editorTitle').value = displayTitle;
  document.getElementById('editorContent').value = wikitext;
  
  const catGuess = guessCategory(wikitext, displayTitle);
  if (catGuess && !document.getElementById('editorCategory').value) {
    document.getElementById('editorCategory').value = catGuess;
  }
  
  const tagGuess = guessTags(wikitext);
  if (tagGuess && !document.getElementById('editorTags').value) {
    document.getElementById('editorTags').value = tagGuess;
  }
  
  // Try to extract etymology
  if (!document.getElementById('editorEtymology').value) {
    const etymMatch = wikitext.match(/(?:^|\n)\s*(Du (?:latin|grec|fran[cç]ais|moyen)[^\n]{10,200})/i);
    if (etymMatch) {
      document.getElementById('editorEtymology').value = etymMatch[1].replace(/'''|''/g, '').trim();
    }
  }
  
  statusEl.className = 'import-status success';
  statusEl.innerHTML = '\u2713 Article \u00ab\u202f<strong>' + escapeHtml(displayTitle) + '</strong>\u202f\u00bb import\u00e9 depuis <em>' + escapeHtml(usedTitle) + '</em>. V\u00e9rifiez les champs et cliquez sur <strong>Enregistrer</strong>.';
  
  document.getElementById('editorTitle').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function cleanWikitext(text) {
  // Remove inter-wiki / category links at the end
  text = text.replace(/\[\[Catégorie:[^\]]*\]\]/g, '');
  text = text.replace(/\[\[(en|de|es|it|pt|ja|zh|ko):[^\]]*\]\]/g, '');
  
  // Remove __TOC__, __NOTOC__, etc.
  text = text.replace(/__[A-Z]+__/g, '');
  
  // Remove {{ébauche}}, {{à recycler}}, etc. maintenance templates (keep {{e}} and {{references}})
  text = text.replace(/\{\{(ébauche|[àa] recycler|recycler|article court|suppression|stub|cleanup|redirect)[^}]*\}\}/gi, '');
  
  // Remove image markup [[Fichier:...]] and [[File:...]]
  text = text.replace(/\[\[(Fichier|File|Image):[^\]]*\]\]/gi, '');
  
  // Trim leading/trailing whitespace and multiple blank lines
  text = text.replace(/\n{3,}/g, '\n\n').trim();
  
  return text;
}

function guessCategory(wikitext, title) {
  const text = wikitext.toLowerCase();
  const t = title.toLowerCase();
  
  const patterns = [
    [/\b(logique|syllogisme|proposition|prédicat)\b/, 'Logique'],
    [/\b(métaphysique|substance|être|ontologi|existence)\b/, 'Métaphysique'],
    [/\b(moral|éthique|vertu|devoir|bien|mal)\b/, 'Philosophie morale'],
    [/\b(connaissance|épistémol|vérité|science|savoir)\b/, 'Épistémologie'],
    [/\b(dieu|théo|divin|religion|athé|déis|panthé)\b/, 'Philosophie de la religion'],
    [/\b(politi|état|justice|liberté|droit|citoyen)\b/, 'Philosophie politique'],
    [/\b(art|beauté|esthéti|sublime|goût)\b/, 'Esthétique'],
    [/\b(langage|sens|signifi|sémantique|phrase)\b/, 'Philosophie du langage'],
    [/\b(esprit|conscience|perception|âme|psycho)\b/, 'Philosophie de l\'esprit'],
    [/\b(histoire|hegel|marx|dialectique|progrès)\b/, 'Philosophie de l\'histoire'],
  ];
  
  for (const [regex, cat] of patterns) {
    if (regex.test(text) || regex.test(t)) return cat;
  }
  return 'Philosophie';
}

function guessTags(wikitext) {
  // Extract philosopher names (bold proper nouns in text)
  const boldNames = [];
  const boldRegex = /'''([A-ZÀ-ÖØ-Þ][a-zà-öø-ÿ]+(?: [A-ZÀ-ÖØ-Þ][a-zà-öø-ÿ]+){0,3})'''/g;
  let m;
  while ((m = boldRegex.exec(wikitext)) !== null) {
    boldNames.push(m[1]);
  }
  
  // Also look for common philosopher names mentioned
  const knownPhilosophers = ['Aristote', 'Platon', 'Socrate', 'Descartes', 'Kant', 'Hegel', 'Nietzsche', 'Heidegger', 'Spinoza', 'Leibniz', 'Hume', 'Locke', 'Marx', 'Sartre', 'Husserl', 'Wittgenstein', 'Bergson', 'Kierkegaard', 'Schopenhauer', 'Épicure', 'Thomas d\'Aquin', 'Augustin', 'Montaigne', 'Pascal', 'Rousseau', 'Hobbes', 'Levinas', 'Derrida', 'Foucault', 'Deleuze', 'Merleau-Ponty', 'Russell', 'Frege', 'Quine', 'Popper', 'Kuhn'];
  
  const found = new Set(boldNames);
  for (const name of knownPhilosophers) {
    if (wikitext.includes(name)) found.add(name);
  }
  
  return [...found].slice(0, 8).join(', ');
}

function showEditorTab(tab, btn) {
  document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  
  if (tab === 'write') {
    document.getElementById('editorWritePanel').style.display = '';
    document.getElementById('editorPreviewPanel').style.display = 'none';
  } else {
    document.getElementById('editorWritePanel').style.display = 'none';
    document.getElementById('editorPreviewPanel').style.display = '';
    // Render preview
    const wikitext = document.getElementById('editorContent').value;
    const preview = document.getElementById('editorPreviewContent');
    if (wikitext.trim()) {
      const parsed = parseMediaWiki(wikitext);
      preview.innerHTML = `<div class="article-body">${parsed.html}</div>`;
      if (parsed.refs.length > 0) {
        preview.innerHTML += `<div class="article-refs" style="margin-top:1.5rem;"><h4>Références extraites (${parsed.refs.length})</h4>${parsed.refs.map(r => '<p>— ' + escapeHtml(r) + '</p>').join('')}</div>`;
      }
    } else {
      preview.innerHTML = '<p style="color:var(--muted-light);font-style:italic;">Rien à afficher. Écrivez du contenu dans l\'onglet Écriture.</p>';
    }
  }
}

var savingEntry = false;
function saveEntry() {
  if (savingEntry) return;
  savingEntry = true;
  setTimeout(function() { savingEntry = false; }, 500);
  const title = document.getElementById('editorTitle').value.trim();
  const category = document.getElementById('editorCategory').value.trim() || 'Philosophie';
  const etymology = document.getElementById('editorEtymology').value.trim();
  const tagsRaw = document.getElementById('editorTags').value.trim();
  const wikitext = getEditorWikitext();
  
  if (!title) {
    alert('Veuillez saisir un titre pour l\u2019article.');
    return;
  }
  if (!wikitext.trim()) {
    alert('Veuillez saisir du contenu au format MediaWiki.');
    return;
  }
  
  const parsed = parseMediaWiki(wikitext);
  const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];
  const letter = title.charAt(0).toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  const id = editingEntryId || 'user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
  
  // Extract first paragraph as definition
  const defMatch = parsed.html.match(/<p>([\s\S]*?)<\/p>/);
  const definition = defMatch ? defMatch[1].replace(/<[^>]+>/g, '').substring(0, 300) : '';
  
  const entry = {
    id,
    term: title,
    letter: letter.length === 1 && /[A-Z]/.test(letter) ? letter : title.charAt(0).toUpperCase(),
    category,
    etymology,
    definition,
    content: parsed.html,
    tags,
    refs: parsed.refs,
    related: [],
    _userEntry: true,
    _wikiSource: wikitext
  };
  
  if (editingEntryId) {
    const idx = userEntries.findIndex(e => e.id === editingEntryId);
    if (idx > -1) userEntries[idx] = entry;
    else userEntries.push(entry);
  } else {
    userEntries.push(entry);
  }
  
  saveUserEntries();
  editingEntryId = null;
  
  // Refresh and show the new article
  updateEntryCount();
  buildAlphaNav();
  renderEntryList();
  showArticle(entry.id);
}

function deleteUserEntry(id) {
  if (!confirm('Supprimer cet article personnalisé ?')) return;
  userEntries = userEntries.filter(e => e.id !== id);
  saveUserEntries();
  updateEntryCount();
  buildAlphaNav();
  renderEntryList();
  showWelcome();
}

function updateEntryCount() {
  document.getElementById('entryCount').textContent = getAllEntries().length;
}

// ===== READ TRACKING =====
function trackRead(id) {
  readArticles.add(id);
  PhiloDB.set('philo-read', JSON.stringify([...readArticles]));
  // Add to history
  readHistory = readHistory.filter(h => h.id !== id);
  readHistory.unshift({ id: safeId(id), time: Date.now() });
  if (readHistory.length > 100) readHistory = readHistory.slice(0, 100);
  PhiloDB.set('philo-history', JSON.stringify(readHistory));
}

function getReadStats() {
  const all = getAllEntries();
  return { total: all.length, read: all.filter(e => readArticles.has(e.id)).length };
}

// ===== FONT SIZE =====
function adjustFontSize(delta) {
  currentFontSize = Math.max(75, Math.min(150, currentFontSize + delta * 5));
  PhiloDB.set('philo-fontsize', currentFontSize);
  applyFontSize();
  // Sync settings slider if open
  var sl = document.getElementById('settingsFontSize');
  if (sl) sl.value = currentFontSize;
  var val = document.getElementById('settingsFontVal');
  if (val) val.textContent = currentFontSize + '%';
}

function applyFontSize() {
  // Delegate to applyAppearance which handles all text styling in one place
  applyAppearance();
}

// ===== FOOTNOTES =====
function buildFootnotes(html, refs) {
  // Convert <ref>...</ref> markers into numbered superscripts
  let noteIndex = 0;
  const notes = [];
  
  // Extract inline refs from HTML
  html = html.replace(/<ref[^>]*>([\s\S]*?)<\/ref>/gi, (match, content) => {
    noteIndex++;
    notes.push(content.replace(/<[^>]+>/g, '').trim());
    return `<span class="footnote-ref" onclick="document.getElementById('fn-${noteIndex}').scrollIntoView({behavior:'smooth',block:'center'})" title="${escapeAttr(notes[notes.length-1].substring(0,100))}">[${noteIndex}]</span>`;
  });
  
  // Add refs from parsed bibliography as additional notes
  refs.forEach(r => {
    noteIndex++;
    notes.push(r);
  });
  
  // Build footnotes section
  let footnotesHtml = '';
  if (notes.length > 0) {
    footnotesHtml = `<div class="footnotes-section"><h4>Notes & Références (${notes.length})</h4>` +
      notes.map((n, i) => `<div class="footnote-item" id="fn-${i+1}"><span class="footnote-num">${i+1}.</span><span>${n}</span></div>`).join('') +
      `</div>`;
  }
  
  return { html, footnotesHtml };
}

// ===== TABLE OF CONTENTS =====
function buildTOC(contentEl) {
  const headings = contentEl.querySelectorAll('.article-body h3, .article-body h4');
  if (headings.length < 3) return;
  
  // Add IDs to headings
  headings.forEach(function(h, i) { h.id = 'section-' + i; });
  
  if (isMobile()) {
    var tocBtn = document.createElement('div');
    var links = [];
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      var isSub = h.tagName === 'H4';
      links.push('<a href="#section-' + i + '" class="' + (isSub ? 'toc-sub' : '') + '" onclick="event.preventDefault();document.getElementById(\'section-' + i + '\').scrollIntoView({behavior:\'smooth\',block:\'start\'})">' + h.textContent + '</a>');
    }
    tocBtn.innerHTML = '<button class="toc-mobile-toggle" onclick="this.nextElementSibling.classList.toggle(\'open\')">' +
      '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h12"/></svg>' +
      'Sommaire (' + headings.length + ' sections)' +
      '</button><div class="toc-mobile-list">' + links.join('') + '</div>';
    var body = contentEl.querySelector('.article-body');
    if (body) body.insertBefore(tocBtn, body.firstChild);
  } else {
    var toc = document.createElement('div');
    toc.className = 'toc-float';
    var links = [];
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      var isSub = h.tagName === 'H4';
      links.push('<a href="#section-' + i + '" data-idx="' + i + '" class="' + (isSub ? 'toc-sub' : '') + '" onclick="event.preventDefault();document.getElementById(\'section-' + i + '\').scrollIntoView({behavior:\'smooth\',block:\'start\'})">' + h.textContent + '</a>');
    }
    toc.innerHTML = '<div class="toc-float-title">Sommaire</div>' + links.join('') +
      '<div style="margin-top:0.75rem;padding-top:0.6rem;border-top:1px solid var(--border);">' +
        '<div class="font-size-controls" style="justify-content:center;">' +
          '<button class="font-size-btn" onclick="adjustFontSize(-1)">A\u2212</button>' +
          '<span style="font-family:var(--mono);font-size:0.5rem;color:var(--muted-light);">' + currentFontSize + '%</span>' +
          '<button class="font-size-btn" onclick="adjustFontSize(1)">A+</button>' +
        '</div>' +
      '</div>';
    var wrap = contentEl.querySelector('.article-body-wrap');
    if (wrap) wrap.appendChild(toc);
    
    // Scroll spy
    var content = document.querySelector('.content');
    var spy = function() {
      var tocLinks = toc.querySelectorAll('a[data-idx]');
      var active = 0;
      for (var j = 0; j < headings.length; j++) {
        if (headings[j].getBoundingClientRect().top < 120) active = j;
      }
      for (var j = 0; j < tocLinks.length; j++) {
        if (j === active) tocLinks[j].classList.add('active');
        else tocLinks[j].classList.remove('active');
      }
    };
    (content || window).addEventListener('scroll', spy, { passive: true });
    spy();
  }
}

// ===== GRAPH =====
function showGraph() {
  const allEntries = getAllEntries();
  if (allEntries.length === 0) return;
  
  const overlay = document.createElement('div');
  overlay.className = 'graph-overlay';
  overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
  
  overlay.innerHTML = `<div class="graph-container">
    <div class="graph-header">
      <h3>Graphe des relations</h3>
      <button class="graph-close" onclick="this.closest('.graph-overlay').remove()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="graph-canvas-wrap"><canvas id="graphCanvas"></canvas></div>
  </div>`;
  document.body.appendChild(overlay);
  
  const canvas = document.getElementById('graphCanvas');
  const wrap = canvas.parentElement;
  canvas.width = wrap.clientWidth * 2;
  canvas.height = wrap.clientHeight * 2;
  canvas.style.width = wrap.clientWidth + 'px';
  canvas.style.height = wrap.clientHeight + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(2, 2);
  
  const W = wrap.clientWidth, H = wrap.clientHeight;
  
  // Build nodes (limit to entries with connections)
  const entryMap = new Map(allEntries.map(e => [e.id, e]));
  const links = [];
  const connectedIds = new Set();
  
  allEntries.forEach(e => {
    const related = [...(e.related || []), ...detectRelated(e).slice(0, 4)];
    related.forEach(rid => {
      if (entryMap.has(rid) && rid !== e.id) {
        links.push({ source: e.id, target: rid });
        connectedIds.add(e.id);
        connectedIds.add(rid);
      }
    });
  });
  
  // Take top connected nodes (max 60)
  const nodeCounts = new Map();
  links.forEach(l => {
    nodeCounts.set(l.source, (nodeCounts.get(l.source)||0)+1);
    nodeCounts.set(l.target, (nodeCounts.get(l.target)||0)+1);
  });
  const topIds = [...nodeCounts.entries()].sort((a,b) => b[1]-a[1]).slice(0, 60).map(e => e[0]);
  const nodeSet = new Set(topIds);
  
  const nodes = topIds.map((id, i) => {
    const e = entryMap.get(id);
    const angle = (i / topIds.length) * Math.PI * 2;
    const r = Math.min(W, H) * 0.35;
    return { id, label: e.term, x: W/2 + Math.cos(angle) * r + (Math.random()-0.5)*40, y: H/2 + Math.sin(angle) * r + (Math.random()-0.5)*40, vx:0, vy:0 };
  });
  const nodeMap = new Map(nodes.map(n => [n.id, n]));
  const filteredLinks = links.filter(l => nodeSet.has(l.source) && nodeSet.has(l.target));
  
  // Simple force simulation
  function tick() {
    // Center gravity
    nodes.forEach(n => { n.vx += (W/2 - n.x) * 0.001; n.vy += (H/2 - n.y) * 0.001; });
    // Repulsion
    for (let i = 0; i < nodes.length; i++) {
      for (let j = i+1; j < nodes.length; j++) {
        let dx = nodes[j].x - nodes[i].x, dy = nodes[j].y - nodes[i].y;
        const d = Math.sqrt(dx*dx + dy*dy) || 1;
        const f = 800 / (d * d);
        nodes[i].vx -= dx/d * f; nodes[i].vy -= dy/d * f;
        nodes[j].vx += dx/d * f; nodes[j].vy += dy/d * f;
      }
    }
    // Attraction along links
    filteredLinks.forEach(l => {
      const s = nodeMap.get(l.source), t = nodeMap.get(l.target);
      if (!s || !t) return;
      let dx = t.x - s.x, dy = t.y - s.y;
      const d = Math.sqrt(dx*dx + dy*dy) || 1;
      const f = (d - 80) * 0.005;
      s.vx += dx/d * f; s.vy += dy/d * f;
      t.vx -= dx/d * f; t.vy -= dy/d * f;
    });
    // Apply + dampen
    nodes.forEach(n => {
      n.vx *= 0.85; n.vy *= 0.85;
      n.x += n.vx; n.y += n.vy;
      n.x = Math.max(40, Math.min(W-40, n.x));
      n.y = Math.max(30, Math.min(H-30, n.y));
    });
  }
  
  function draw() {
    ctx.clearRect(0, 0, W, H);
    // Links
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
    ctx.lineWidth = 0.5;
    filteredLinks.forEach(l => {
      const s = nodeMap.get(l.source), t = nodeMap.get(l.target);
      if (!s || !t) return;
      ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(t.x, t.y); ctx.stroke();
    });
    // Nodes
    const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    const ink = getComputedStyle(document.documentElement).getPropertyValue('--ink').trim();
    nodes.forEach(n => {
      const count = nodeCounts.get(n.id) || 1;
      const r = 3 + Math.min(count * 1.5, 8);
      ctx.beginPath(); ctx.arc(n.x, n.y, r, 0, Math.PI*2);
      ctx.fillStyle = accent; ctx.globalAlpha = 0.7; ctx.fill(); ctx.globalAlpha = 1;
      ctx.font = '500 ' + Math.max(8, Math.min(11, 7 + count)) + 'px "Cormorant Garamond"';
      ctx.fillStyle = ink;
      ctx.textAlign = 'center';
      ctx.fillText(n.label, n.x, n.y - r - 3);
    });
  }
  
  let frame = 0;
  function animate() {
    tick(); draw(); frame++;
    if (frame < 200 && document.body.contains(canvas)) requestAnimationFrame(animate);
  }
  animate();
  
  // Click on node → open article
  canvas.onclick = (e) => {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    for (const n of nodes) {
      const dx = mx - n.x, dy = my - n.y;
      if (dx*dx + dy*dy < 200) {
        overlay.remove();
        navigateTo(n.id);
        return;
      }
    }
  };
}

// ===== SEARCH SUGGESTIONS =====
function showSearchSuggestions(query) {
  const box = document.getElementById('searchSuggestions');
  if (!box) return;
  
  if (!query || query.length < 2) {
    box.classList.remove('visible');
    suggestHighlight = -1;
    return;
  }
  
  const results = getAllEntries().filter(e => {
    var ct = (customArticleTags[e.id] || []).join(' ');
    return fuzzyMatch(query, `${e.term} ${e.category} ${e.tags.join(' ')} ${ct}`);
  }).slice(0, 6);
  
  if (results.length === 0) {
    box.classList.remove('visible');
    return;
  }
  
  box.innerHTML = results.map((e, i) => `
    <div class="search-suggestion${i === suggestHighlight ? ' highlighted' : ''}" onmousedown="navigateTo('${safeId(e.id)}')" data-idx="${i}">
      <div class="search-suggestion-letter">${e.letter}</div>
      <div class="search-suggestion-text">
        <div class="search-suggestion-title">${escapeHtml(e.term)}</div>
        <div class="search-suggestion-cat">${escapeHtml(e.category)}</div>
      </div>
    </div>`).join('');
  box.classList.add('visible');
}

// ===== PHILOSOPHER INDEX =====
function showPhilosopherIndex() {
  const allEntries = getAllEntries();
  const philosophers = new Map();
  const knownPhilosophers = ['Aristote','Platon','Socrate','Descartes','Kant','Hegel','Nietzsche','Heidegger','Spinoza','Leibniz','Hume','Locke','Marx','Sartre','Husserl','Wittgenstein','Bergson','Kierkegaard','Schopenhauer','\u00c9picure','Thomas d\'Aquin','Augustin','Montaigne','Pascal','Rousseau','Hobbes','Levinas','Derrida','Foucault','Deleuze','Merleau-Ponty','Russell','Frege','Quine','Popper','Kuhn','Duns Scot','Ockham','Ab\u00e9lard','Averro\u00e8s','Avicenne','Plotin'];
  
  allEntries.forEach(e => {
    const text = e.content.replace(/<[^>]+>/g, '') + ' ' + e.tags.join(' ');
    knownPhilosophers.forEach(p => {
      if (text.includes(p)) {
        if (!philosophers.has(p)) philosophers.set(p, []);
        philosophers.get(p).push(e.id);
      }
    });
  });
  
  const sorted = [...philosophers.entries()].sort((a, b) => b[1].length - a[1].length);
  
  const content = document.getElementById('content');
  content.innerHTML = `
    <div class="article" style="animation:slideIn 0.4s ease;">
      <header class="article-header">
        <div class="article-category">Index</div>
        <h2 class="article-title">Philosophes</h2>
        <div class="article-definition">${sorted.length} penseurs r\u00e9f\u00e9renc\u00e9s dans ${allEntries.length} articles</div>
      </header>
      <div class="philosopher-grid">
        ${sorted.map(([name, ids]) => `
          <div class="philosopher-card" onclick="searchPhilosopher('${escapeAttr(name)}')">
            <div class="philosopher-card-name">${name}</div>
            <div class="philosopher-card-count">${ids.length} article${ids.length > 1 ? 's' : ''}</div>
          </div>`).join('')}
      </div>
    </div>`;
  
  currentArticle = null;
  if (isMobile()) { mobileViewingArticle = false; }
}

function searchPhilosopher(name) {
  if (isMobile()) {
    switchTab('search');
    setTimeout(() => {
      const input = document.querySelector('.drawer-search');
      if (input) { input.value = name; input.dispatchEvent(new Event('input')); }
    }, 400);
  } else {
    document.getElementById('searchInput').value = name;
    searchQuery = name;
    renderEntryList();
    showSearchSuggestions('');
  }
}

// ===== EXPORT / IMPORT =====
function exportJSON() {
  const data = {
    version: 1,
    exported: new Date().toISOString(),
    entries: userEntries,
    bookmarks,
    readArticles: [...readArticles],
    readHistory,
    customTags: customArticleTags,
    customTagNames: allCustomTagNames
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'dictionnaire-philosophie-' + new Date().toISOString().slice(0, 10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importJSON() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = JSON.parse(ev.target.result);
        if (!data.entries || !Array.isArray(data.entries)) {
          alert('Format invalide.');
          return;
        }
        // Merge entries (avoid exact duplicates by id)
        const existingIds = new Set(userEntries.map(e => e.id));
        let added = 0;
        data.entries.forEach(e => {
          var validated = validateEntry(e);
          if (validated && !existingIds.has(validated.id)) {
            userEntries.push(validated);
            existingIds.add(validated.id);
            added++;
          }
        });
        // Merge bookmarks
        if (data.bookmarks) {
          data.bookmarks.forEach(b => { if (!bookmarks.includes(b)) bookmarks.push(b); });
          PhiloDB.set('philo-bookmarks', JSON.stringify(bookmarks));
        }
        // Merge read data
        if (data.readArticles) {
          data.readArticles.forEach(id => readArticles.add(id));
          PhiloDB.set('philo-read', JSON.stringify([...readArticles]));
        }
        saveUserEntries();
        updateEntryCount();
        buildAlphaNav();
        buildFilterBar();
        renderEntryList();
        showWelcome();
        alert(`Import r\u00e9ussi : ${added} articles ajout\u00e9s (${data.entries.length - added} d\u00e9j\u00e0 pr\u00e9sents).`);
      } catch (err) {
        alert('Erreur de lecture du fichier : ' + err.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// ===== DUPLICATE DETECTION =====
function findDuplicate(title) {
  const norm = normalizeText(title);
  return getAllEntries().find(e => normalizeText(e.term) === norm);
}

// ===== EDITOR TOOLBAR =====
function insertMarkup(type) {
  const ta = document.getElementById('editorContent');
  if (!ta) return;
  const markups = {
    bold: ["'''", "'''"],
    italic: ["''", "''"],
    h2: ["\n== ", " ==\n"],
    h3: ["\n=== ", " ===\n"],
    list: ["\n* ", ""],
    quote: ["\n: ", ""],
    ref: ["<ref>", "</ref>"]
  };
  const m = markups[type];
  if (!m) return;
  const start = ta.selectionStart, end = ta.selectionEnd;
  const sel = ta.value.substring(start, end);
  const replacement = m[0] + (sel || 'texte') + m[1];
  ta.value = ta.value.substring(0, start) + replacement + ta.value.substring(end);
  ta.focus();
  ta.selectionStart = start + m[0].length;
  ta.selectionEnd = start + m[0].length + (sel || 'texte').length;
}

function checkDuplicate(title) {
  const warn = document.getElementById('duplicateWarning');
  if (!warn || !title.trim()) { if (warn) warn.innerHTML = ''; return; }
  const dup = findDuplicate(title.trim());
  if (dup && (!editingEntryId || dup.id !== editingEntryId)) {
    warn.innerHTML = `<div class="duplicate-warning">\u26a0 Un article <strong>${escapeHtml(dup.term)}</strong> existe d\u00e9j\u00e0 dans la cat\u00e9gorie ${escapeHtml(dup.category)}. <a href="#" onclick="event.preventDefault();navigateTo('${safeId(dup.id)}')">Voir l\u2019article</a></div>`;
  } else {
    warn.innerHTML = '';
  }
}

// ===== IDB RESTORATION (runs after sync init) =====
var idbRestoreComplete = false;
async function restoreFromIDB() {
  try {
    const idbEntries = await PhiloDB.get('philo-user-entries');
    if (idbEntries) {
      const parsed = safeParse(idbEntries, []);
      // Use IDB data if it has more entries than localStorage (localStorage was wiped)
      if (Array.isArray(parsed) && parsed.length > userEntries.length) {
        userEntries = parsed.map(function(e) { return validateEntry(e); }).filter(Boolean);
        try { localStorage.setItem('philo-user-entries', JSON.stringify(userEntries)); } catch(e) {}
        updateEntryCount();
        buildAlphaNav();
        buildFilterBar();
        renderEntryList();
        if (!currentArticle) showWelcome();
        console.log('[PhiloDB] Restored', parsed.length, 'entries from IndexedDB');
      }
    }
    
    // Restore bookmarks
    const idbBookmarks = await PhiloDB.get('philo-bookmarks');
    if (idbBookmarks) {
      const parsed = safeParse(idbBookmarks, []);
      if (Array.isArray(parsed) && parsed.length > bookmarks.length) {
        bookmarks = parsed;
        try { localStorage.setItem('philo-bookmarks', idbBookmarks); } catch(e) {}
      }
    }
    
    // Restore read state
    const idbRead = await PhiloDB.get('philo-read');
    if (idbRead) {
      const parsed = safeParse(idbRead, []);
      if (Array.isArray(parsed) && parsed.length > readArticles.size) {
        readArticles = new Set(parsed);
        try { localStorage.setItem('philo-read', idbRead); } catch(e) {}
      }
    }
    
    // Restore history
    const idbHistory = await PhiloDB.get('philo-history');
    if (idbHistory) {
      const parsed = safeParse(idbHistory, []);
      if (Array.isArray(parsed) && parsed.length > readHistory.length) {
        readHistory = parsed;
        try { localStorage.setItem('philo-history', idbHistory); } catch(e) {}
      }
    }
    
    // Restore theme
    const idbTheme = await PhiloDB.get('philo-theme');
    if (idbTheme && !lsGet('philo-theme', '')) {
      try { localStorage.setItem('philo-theme', idbTheme); } catch(e) {}
      initTheme();
    }
    
    // Restore font size
    const idbFontSize = await PhiloDB.get('philo-fontsize');
    if (idbFontSize) {
      const size = parseInt(idbFontSize);
      if (size && size !== 100) {
        currentFontSize = size;
        try { localStorage.setItem('philo-fontsize', idbFontSize); } catch(e) {}
      }
    }
    
    // Restore notes
    const idbNotes = await PhiloDB.get('philo-notes');
    if (idbNotes) {
      try {
        var parsed = safeParse(idbNotes, {});
        if (parsed && typeof parsed === 'object' && Object.keys(parsed).length > Object.keys(articleNotes).length) {
          articleNotes = parsed;
          try { localStorage.setItem('philo-notes', idbNotes); } catch(e) {}
        }
      } catch(e) {}
    }
    
    // Restore collections
    const idbCollections = await PhiloDB.get('philo-collections');
    if (idbCollections) {
      try {
        var parsed = safeParse(idbCollections, {});
        if (parsed && typeof parsed === 'object') {
          collections = parsed;
          try { localStorage.setItem('philo-collections', idbCollections); } catch(e) {}
        }
      } catch(e) {}
    }
    
    // Restore reading times
    const idbTimes = await PhiloDB.get('philo-reading-times');
    if (idbTimes) {
      try {
        var parsed = safeParse(idbTimes, {});
        if (parsed && typeof parsed === 'object') {
          readingStartTimes = parsed;
          try { localStorage.setItem('philo-reading-times', idbTimes); } catch(e) {}
        }
      } catch(e) {}
    }
    
    // Restore appearance settings
    var idbLH = await PhiloDB.get('philo-line-height');
    if (idbLH) { appLineHeight = parseInt(idbLH) || 190; try { localStorage.setItem('philo-line-height', idbLH); } catch(e) {} }
    var idbTW = await PhiloDB.get('philo-text-width');
    if (idbTW) { appTextWidth = parseInt(idbTW) || 680; try { localStorage.setItem('philo-text-width', idbTW); } catch(e) {} }
    var idbBF = await PhiloDB.get('philo-body-font');
    if (idbBF) { appBodyFont = idbBF; try { localStorage.setItem('philo-body-font', idbBF); } catch(e) {} }
    var idbJ = await PhiloDB.get('philo-justify');
    if (idbJ) { appJustify = idbJ === 'true'; try { localStorage.setItem('philo-justify', idbJ); } catch(e) {} }
    var idbI = await PhiloDB.get('philo-indent');
    if (idbI) { appIndent = idbI === 'true'; try { localStorage.setItem('philo-indent', idbI); } catch(e) {} }
    var idbAc = await PhiloDB.get('philo-accent');
    if (idbAc) { appAccent = idbAc; try { localStorage.setItem('philo-accent', idbAc); } catch(e) {} }
    var idbPS = await PhiloDB.get('philo-para-spacing');
    if (idbPS) { appParaSpacing = parseInt(idbPS) || 125; try { localStorage.setItem('philo-para-spacing', idbPS); } catch(e) {} }
    var idbLet = await PhiloDB.get('philo-lettrine');
    if (idbLet) { appLettrine = idbLet === 'true'; try { localStorage.setItem('philo-lettrine', idbLet); } catch(e) {} }
    var idbHL = await PhiloDB.get('philo-highlights');
    if (idbHL) { try { articleHighlights = safeParse(idbHL, {}); try { localStorage.setItem('philo-highlights', idbHL); } catch(e) {} } catch(e) {} }
    var idbHLMode = await PhiloDB.get('philo-highlight-mode');
    if (idbHLMode) { highlightMode = idbHLMode === 'true'; try { localStorage.setItem('philo-highlight-mode', idbHLMode); } catch(e) {} if (highlightMode) document.body.classList.add('highlight-mode'); }
    var idbSP = await PhiloDB.get('philo-scroll-pos');
    if (idbSP) { try { articleScrollPos = safeParse(idbSP, {}); try { localStorage.setItem('philo-scroll-pos', idbSP); } catch(e) {} } catch(e) {} }
    var idbCT = await PhiloDB.get('philo-custom-tags');
    if (idbCT) { try { customArticleTags = safeParse(idbCT, {}); try { localStorage.setItem('philo-custom-tags', idbCT); } catch(e) {} } catch(e) {} }
    var idbCTN = await PhiloDB.get('philo-all-custom-tags');
    if (idbCTN) { try { allCustomTagNames = safeParse(idbCTN, []); try { localStorage.setItem('philo-all-custom-tags', idbCTN); } catch(e) {} } catch(e) {} }
    applyAppearance();
  } catch (e) {
    console.log('[PhiloDB] IDB restore skipped:', e.message);
  }
}

// ===== INITIALIZATION =====
function init() {
  initTheme();
  applyAppearance();
  if (highlightMode) document.body.classList.add('highlight-mode');
  updateEntryCount();
  buildAlphaNav();
  buildFilterBar();
  buildMobileAlphaStrip();
  renderEntryList();
  showWelcome();
  
  // Stop reading timer when page hidden
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) { stopReadingTimer(); saveScrollPos(); }
    else {
      if (currentArticle) startReadingTimer();
      // Check for updates when returning to app (throttled to 24h)
      setTimeout(function() { if (userEntries.length > 0) silentUpdateCheck(); }, 5000);
    }
  });
  
  // Double-tap zoom on mobile
  document.addEventListener('touchend', handleDoubleTap, { passive: false });
  
  // Highlight mode: capture selection
  document.addEventListener('mouseup', handleHighlightSelection);
  document.addEventListener('touchend', function(e) {
    setTimeout(handleHighlightSelection, 100);
  }, { passive: true });
  
  // Escape from immersive mode
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && immersiveMode) { toggleImmersive(); e.stopPropagation(); }
  });
  
  // Update Android widget if native
  try { updateAndroidWidget(); } catch(e) {}

  // Restore data from IndexedDB (survives Android WebView localStorage wipes)
  restoreFromIDB();
  
  // First-launch onboarding
  showOnboarding();
  
  // Silent background update check (10s after startup)
  setTimeout(function() {
    if (userEntries.length > 0) silentUpdateCheck();
  }, 10000);
  
  // Desktop search with suggestions
  const searchEl = document.getElementById('searchInput');
  searchEl.addEventListener('input', (e) => {
    searchQuery = e.target.value.trim().slice(0, 200);
    activeLetterFilter = null;
    updateAlphaNav();
    renderEntryList();
    showSearchSuggestions(searchQuery);
  });
  searchEl.addEventListener('focus', () => { if (searchQuery.length >= 2) showSearchSuggestions(searchQuery); });
  searchEl.addEventListener('blur', () => { setTimeout(() => showSearchSuggestions(''), 200); });
  searchEl.addEventListener('keydown', (e) => {
    const box = document.getElementById('searchSuggestions');
    const items = box?.querySelectorAll('.search-suggestion') || [];
    if (e.key === 'ArrowDown') { e.preventDefault(); suggestHighlight = Math.min(suggestHighlight + 1, items.length - 1); showSearchSuggestions(searchQuery); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); suggestHighlight = Math.max(suggestHighlight - 1, -1); showSearchSuggestions(searchQuery); }
    else if (e.key === 'Enter' && suggestHighlight >= 0 && items[suggestHighlight]) {
      e.preventDefault();
      items[suggestHighlight].dispatchEvent(new Event('mousedown'));
    }
  });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
      e.preventDefault();
      if (isMobile()) { switchTab('search'); } 
      else { document.getElementById('searchInput').focus(); }
    }
    if (e.key === 'Escape') {
      // Close panels first
      var tocOpen = document.getElementById('tocPanelOverlay')?.classList.contains('open');
      var settingsOpen = document.getElementById('settingsOverlay')?.classList.contains('open');
      if (tocOpen) { closeTocPanel(); return; }
      if (settingsOpen) { closeSettings(); return; }
      if (isMobile()) { closeDrawer(); }
      else {
        document.getElementById('searchInput').blur();
        document.getElementById('searchInput').value = '';
        searchQuery = '';
        renderEntryList();
        showSearchSuggestions('');
      }
    }
    // Article navigation: Left/Right arrows, Backspace to go back
    if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
      if (e.key === 'ArrowLeft' && currentArticle) {
        e.preventDefault();
        var allE = getAllEntries();
        var ci = allE.findIndex(function(en) { return en.id === currentArticle.id; });
        if (ci > 0) navigateTo(allE[ci - 1].id);
      }
      if (e.key === 'ArrowRight' && currentArticle) {
        e.preventDefault();
        var allE = getAllEntries();
        var ci = allE.findIndex(function(en) { return en.id === currentArticle.id; });
        if (ci >= 0 && ci < allE.length - 1) navigateTo(allE[ci + 1].id);
      }
      if (e.key === 'Backspace') {
        e.preventDefault();
        goBack();
      }
      if (e.key === 'r' || e.key === 'R') {
        showRandomArticle();
      }
      if ((e.key === 't' || e.key === 'T') && currentArticle) {
        openTocPanel();
      }
      if (e.key === 'f' || e.key === 'F') {
        if (currentArticle) toggleFocusMode();
      }
    }
  });
  
  // Back-to-top button visibility
  var bttBtn = document.getElementById('backToTop');
  var contentEl = document.querySelector('.content');
  var scrollTarget = contentEl || window;
  
  function updateBackToTop() {
    var scrollY = contentEl ? contentEl.scrollTop : window.scrollY;
    if (bttBtn) {
      if (scrollY > 400 && currentArticle) {
        bttBtn.classList.add('visible');
      } else {
        bttBtn.classList.remove('visible');
      }
    }
    // Also update TOC panel active state
    if (document.getElementById('tocPanelOverlay')?.classList.contains('open')) {
      updateTocPanelActive();
    }
  }
  
  function onArticleScroll() {
    updateBackToTop();
    updateProgressMap();
  }
  (contentEl || window).addEventListener('scroll', onArticleScroll, { passive: true });
  window.addEventListener('scroll', onArticleScroll, { passive: true });
  
  // Save scroll position periodically
  var scrollSaveTimer = null;
  function debouncedSaveScroll() {
    clearTimeout(scrollSaveTimer);
    scrollSaveTimer = setTimeout(saveScrollPos, 1000);
  }
  (contentEl || window).addEventListener('scroll', debouncedSaveScroll, { passive: true });
  window.addEventListener('scroll', debouncedSaveScroll, { passive: true });
  
  // Drawer touch-to-dismiss
  const drawerPanel = document.getElementById('drawerPanel');
  let touchStartY = 0;
  drawerPanel.addEventListener('touchstart', (e) => {
    touchStartY = e.touches[0].clientY;
  }, { passive: true });
  drawerPanel.addEventListener('touchmove', (e) => {
    const dy = e.touches[0].clientY - touchStartY;
    if (dy > 80 && drawerPanel.scrollTop <= 0) {
      closeDrawer();
    }
  }, { passive: true });
  
  // Mobile article scroll → show title in bar + reading progress + hide tab/fab
  window.addEventListener('scroll', () => {
    if (!isMobile() || !mobileViewingArticle) return;
    const titleEl = document.querySelector('.article-title');
    if (titleEl) {
      const rect = titleEl.getBoundingClientRect();
      document.getElementById('mobileArticleTitle').classList.toggle('visible', rect.bottom < 60);
    }
    // Reading progress
    const article = document.querySelector('.article');
    if (article) {
      const articleTop = article.offsetTop;
      const articleH = article.scrollHeight;
      const scrollY = window.scrollY - articleTop;
      const winH = window.innerHeight;
      const pct = Math.min(100, Math.max(0, (scrollY / (articleH - winH)) * 100));
      const fill = document.getElementById('mobileReadingFill');
      if (fill) fill.style.width = pct + '%';
    }
  }, { passive: true });
  
  // Swipe left/right between articles on mobile
  let swipeStartX = 0, swipeStartY = 0, swiping = false;
  document.addEventListener('touchstart', (e) => {
    if (!isMobile() || !mobileViewingArticle) return;
    swipeStartX = e.touches[0].clientX;
    swipeStartY = e.touches[0].clientY;
    swiping = true;
  }, { passive: true });
  
  document.addEventListener('touchend', (e) => {
    if (!swiping || !mobileViewingArticle) return;
    swiping = false;
    const dx = e.changedTouches[0].clientX - swipeStartX;
    const dy = e.changedTouches[0].clientY - swipeStartY;
    // Only trigger on horizontal swipes (dx > 80px, not too vertical)
    if (Math.abs(dx) > 80 && Math.abs(dy) < Math.abs(dx) * 0.6) {
      const allEntries = getAllEntries();
      const idx = allEntries.findIndex(e => e.id === currentArticle?.id);
      if (idx < 0) return;
      if (dx < 0 && idx < allEntries.length - 1) {
        // Swipe left → next
        navigateTo(allEntries[idx + 1].id);
      } else if (dx > 0 && idx > 0) {
        // Swipe right → prev
        navigateTo(allEntries[idx - 1].id);
      }
    }
  }, { passive: true });
}

// ===== ALPHABET NAV (Desktop) =====
function buildAlphaNav() {
  const nav = document.getElementById('alphaNav');
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
  const usedLetters = new Set(getAllEntries().map(e => e.letter));
  nav.innerHTML = letters.map(l => 
    `<button class="alpha-btn ${usedLetters.has(l) ? 'has-entries' : ''}" onclick="filterByLetter('${l}')">${l}</button>`
  ).join('');
}

function updateAlphaNav() {
  document.querySelectorAll('.alpha-btn').forEach(btn => {
    btn.classList.toggle('active', btn.textContent === activeLetterFilter);
  });
}

function filterByLetter(letter) {
  activeLetterFilter = activeLetterFilter === letter ? null : letter;
  searchQuery = '';
  document.getElementById('searchInput').value = '';
  updateAlphaNav();
  renderEntryList();
}

// ===== DESKTOP ENTRY LIST =====
function renderEntryList() {
  const container = document.getElementById('entryList');
  let entries = getFilteredEntries();
  
  // Sort controls
  var sortHtml = '<div class="sort-controls">' +
    '<span style="font-family:var(--mono);font-size:0.45rem;letter-spacing:0.06em;text-transform:uppercase;color:var(--muted-light);align-self:center;margin-right:0.2rem;">Tri</span>' +
    '<button class="sort-btn' + (sortMode==='alpha' ? ' active' : '') + '" onclick="setSortMode(\'alpha\')">A\u2192Z</button>' +
    '<button class="sort-btn' + (sortMode==='category' ? ' active' : '') + '" onclick="setSortMode(\'category\')">Cat.</button>' +
    '<button class="sort-btn' + (sortMode==='unread' ? ' active' : '') + '" onclick="setSortMode(\'unread\')">Non lus</button>' +
    '<button class="sort-btn' + (sortMode==='recent' ? ' active' : '') + '" onclick="setSortMode(\'recent\')">R\u00e9cents</button>' +
    '</div>';
  
  // Recent sidebar section (show recent 5)
  var recentHtml = '';
  if (!searchQuery && !activeLetterFilter && !activeCategoryFilter && !showOnlyBookmarks) {
    var recentItems = readHistory.slice(0, 5);
    var allE = getAllEntries();
    if (recentItems.length > 0) {
      recentHtml = '<div class="sidebar-recent"><div class="sidebar-recent-title">R\u00e9cemment lus</div>';
      recentItems.forEach(function(h) {
        var e = allE.find(function(a) { return a.id === h.id; });
        if (e) {
          var ago = Date.now() - h.time;
          var mins = Math.floor(ago / 60000);
          var tStr = mins < 1 ? 'maintenant' : mins < 60 ? mins + 'min' : Math.floor(mins/60) + 'h';
          recentHtml += '<div class="sidebar-recent-item" onclick="navigateTo(\'' + safeId(e.id) + '\')"><span class="sidebar-recent-time">' + tStr + '</span> ' + escapeHtml(e.term) + '</div>';
        }
      });
      recentHtml += '</div>';
    }
  }
  
  if (entries.length === 0) {
    container.innerHTML = sortHtml + recentHtml + `<div class="sidebar-section"><div class="no-results"><div class="no-results-icon">\u2205</div><h3>Aucun r\u00e9sultat</h3><p>Essayez une autre recherche</p></div></div>`;
    return;
  }
  
  // Apply sort
  if (sortMode === 'category') {
    entries.sort(function(a,b) { return a.category.localeCompare(b.category) || a.term.localeCompare(b.term); });
  } else if (sortMode === 'unread') {
    entries.sort(function(a,b) {
      var aR = readArticles.has(a.id) ? 1 : 0;
      var bR = readArticles.has(b.id) ? 1 : 0;
      return aR - bR || a.term.localeCompare(b.term);
    });
  } else if (sortMode === 'recent') {
    var timeMap = {};
    readHistory.forEach(function(h, i) { if (!timeMap[h.id]) timeMap[h.id] = h.time; });
    entries.sort(function(a,b) { return (timeMap[b.id] || 0) - (timeMap[a.id] || 0); });
  }
  // Default alpha: already sorted by letter
  
  var groupKey = (sortMode === 'category') ? 'category' : 'letter';
  const grouped = {};
  entries.forEach(function(e) {
    var key = (groupKey === 'category') ? e.category.split(' \u00b7 ')[0] : e.letter;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(e);
  });
  
  let html = sortHtml + recentHtml;
  var keys = Object.keys(grouped).sort();
  if (sortMode === 'recent') keys = Object.keys(grouped); // Keep order
  
  keys.forEach(function(key) {
    html += `<div class="sidebar-section"><div class="letter-group-header">${key}</div><ul class="entry-list">`;
    grouped[key].forEach(function(entry) {
      const isActive = currentArticle && currentArticle.id === entry.id;
      const isBookmarked = bookmarks.includes(entry.id);
      const isUser = entry._userEntry;
      const isRead = readArticles.has(entry.id);
      html += `<li class="entry-item ${isActive ? 'active' : ''}" onclick="navigateTo('${safeId(entry.id)}')">
        <span class="entry-letter">${isBookmarked ? '\u2605' : isUser ? '\u270e' : escapeHtml(entry.letter || '')}</span>
        <div><span class="entry-name">${escapeHtml(entry.term)}</span><span class="entry-category">${escapeHtml(entry.category)}</span></div>
        ${!isRead ? '<div class="read-dot" title="Non lu"></div>' : ''}</li>`;
    });
    html += `</ul></div>`;
  });
  container.innerHTML = html;
}

function getFilteredEntries() {
  let entries = getAllEntries();
  if (searchQuery) {
    entries = entries.filter(e => {
      // Search in all fields including full article content
      const target = `${e.term} ${e.category} ${e.definition} ${e.tags.join(' ')} ${e.etymology} ${e.content.replace(/<[^>]+>/g, '')}`;
      return fuzzyMatch(searchQuery, target);
    });
  }
  if (activeLetterFilter) entries = entries.filter(e => e.letter === activeLetterFilter);
  if (activeCategoryFilter) entries = entries.filter(e => e.category.includes(activeCategoryFilter));
  if (showOnlyBookmarks) entries = entries.filter(e => bookmarks.includes(e.id));
  if (activeCollection && collections[activeCollection]) {
    entries = entries.filter(function(e) { return collections[activeCollection].indexOf(e.id) >= 0; });
  }
  return entries;
}

// ===== ARTICLE DISPLAY =====
// ===== NAVIGATION HISTORY =====
function navigateTo(id) {
  if (!id || typeof id !== 'string') return;
  if (ttsActive) stopTTS();
  saveScrollPos();
  if (currentArticle && currentArticle.id !== id) {
    navHistory.push(currentArticle.id);
    if (navHistory.length > 30) navHistory.shift();
  }
  showArticle(id);
}

function goBack() {
  if (navHistory.length > 0) {
    var prevId = navHistory.pop();
    showArticle(prevId);
  } else {
    showWelcome();
  }
}

function showArticle(id) {
  const allEntries = getAllEntries();
  const entry = allEntries.find(e => e.id === id);
  if (!entry) return;
  
  currentArticle = entry;
  trackRead(id);
  closeTocPanel();
  closeSettings();
  const content = document.getElementById('content');
  if (!content) return;
  const isBookmarked = bookmarks.includes(entry.id);
  
  // Defensive: ensure critical fields exist
  if (!entry.content) entry.content = '';
  if (!entry.definition) entry.definition = '';
  if (!entry.category) entry.category = 'Philosophie';
  if (!entry.tags) entry.tags = [];
  if (!entry.refs) entry.refs = [];
  
  // Auto-link terms in article body
  let linkedContent = autoLinkContent(entry.content, entry.id);
  
  // Build footnotes from inline refs + bibliography
  const footnoteResult = buildFootnotes(linkedContent, entry.refs || []);
  linkedContent = footnoteResult.html;
  
  // Inject lettrine on first paragraph
  if (appLettrine) {
    linkedContent = linkedContent.replace(/(<p[^>]*>)(\s*(?:<a[^>]*>)?)([\wÀ-ÿ«])/i, function(m, pTag, aTag, letter) {
      return pTag + (aTag||'') + '<span class="lettrine">' + letter + '</span>';
    });
  }
  
  // Build related articles (manual + auto-detected)
  let relatedIds = [...(entry.related || [])];
  const autoRelated = detectRelated(entry);
  autoRelated.forEach(rid => { if (!relatedIds.includes(rid)) relatedIds.push(rid); });
  relatedIds = relatedIds.slice(0, 10);
  
  let relatedHtml = '';
  if (relatedIds.length > 0) {
    const relatedEntries = relatedIds.map(rid => allEntries.find(e => e.id === rid)).filter(Boolean);
    if (relatedEntries.length > 0) {
      relatedHtml = `<div class="article-tags">${relatedEntries.map(r => 
        `<span class="article-tag" onclick="navigateTo('${safeId(r.id)}')">${escapeHtml(r.term)}</span>`).join('')}</div>`;
    }
  }
  
  let tagsHtml = entry.tags.map(t => `<span class="article-tag" onclick="searchTag('${escapeAttr(t)}')">${escapeHtml(t)}</span>`).join('');
  let customTagsHtml = buildCustomTagsHtml(id);
  
  const wikiUrl = `https://fr.wikibooks.org/wiki/Dictionnaire_de_philosophie/${encodeURIComponent(entry.term.replace(/ & /g, '/').replace(/ \(logique\)/, '_(logique)'))}`;
  
  // Prev/Next navigation
  const idx = allEntries.findIndex(e => e.id === id);
  const prev = idx > 0 ? allEntries[idx - 1] : null;
  const next = idx < allEntries.length - 1 ? allEntries[idx + 1] : null;
  
  let navHtml = '<nav class="article-nav">';
  if (prev) {
    navHtml += '<button class="article-nav-btn prev" onclick="navigateTo(\'' + prev.id + '\')"><div class="nav-label">\u2190 Précédent</div><div class="nav-title">' + escapeHtml(prev.term) + '</div></button>';
  }
  navHtml += '<div class="article-nav-center"><button class="article-nav-home" onclick="showWelcome()" title="Accueil"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></button></div>';
  if (next) {
    navHtml += '<button class="article-nav-btn next" onclick="navigateTo(\'' + next.id + '\')"><div class="nav-label">Suivant \u2192</div><div class="nav-title">' + escapeHtml(next.term) + '</div></button>';
  }
  navHtml += '</nav>';
  if (isMobile()) {
    navHtml += '<div style="text-align:center;padding:0.5rem 0 0.25rem;font-family:var(--mono);font-size:0.5rem;letter-spacing:0.06em;text-transform:uppercase;color:var(--muted-light);opacity:0.6;">\u2190 Swipe pour naviguer \u2192</div>';
  }
  
  // Breadcrumb (desktop) + back link
  var backLabel = navHistory.length > 0 ? 'Retour' : 'Accueil';
  var backAction = navHistory.length > 0 ? 'goBack()' : 'showWelcome()';
  var breadcrumbHtml = '<div class="article-breadcrumb">'
    + '<a onclick="showWelcome()">Accueil</a>'
    + '<span class="bc-sep">\u203a</span>'
    + '<a onclick="searchTag(\'' + escapeAttr(entry.category) + '\')">' + escapeHtml(entry.category) + '</a>'
    + '<span class="bc-sep">\u203a</span>'
    + '<span class="bc-current">' + escapeHtml(entry.term) + '</span>'
    + '</div>';
  var backLinkHtml = '<a class="article-back-link" onclick="' + backAction + '">'
    + '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>'
    + backLabel + '<span class="nav-key-hint">Retour</span></a>';
  
  // User entry badge + actions
  const userBadge = entry._userEntry ? '<span class="user-entry-badge">Article personnalisé</span>' : '';
  const userActions = entry._userEntry ? `
    <div class="article-edit-actions">
      <button class="btn" onclick="openEditor('${safeId(entry.id)}')">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        Modifier
      </button>
      <button class="btn btn-danger" onclick="deleteUserEntry('${safeId(entry.id)}')">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
        Supprimer
      </button>
    </div>` : '';
  
  // Reading time (200 words/min for French)
  const wordCount = entry.content.replace(/<[^>]+>/g, '').split(/\s+/).length;
  const readMin = Math.max(1, Math.round(wordCount / 200));
  
  // Quality indicators
  const hasRefs = entry.refs && entry.refs.length > 0;
  const wikiSrc = entry._wikiSource || '';
  const hasNotes = /<ref>/i.test(wikiSrc);
  const hasBiblio = /^=+\s*bibliographie\s*=+/im.test(wikiSrc);
  var qualityHints = [];
  if (!hasBiblio) qualityHints.push('<span class="quality-hint" title="Aucune section Bibliographie détectée"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg> Sans bibliographie</span>');
  if (!hasNotes && !hasRefs) qualityHints.push('<span class="quality-hint" title="Aucune note ou référence dans le texte"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Sans notes</span>');
  const qualityHtml = qualityHints.length > 0 ? '<div class="quality-hints">' + qualityHints.join('') + '</div>' : '';
  
  const readTimeHtml = `<div class="mobile-reading-time">${readMin} min de lecture \u00b7 ${wordCount} mots</div>` + qualityHtml;
  
  // Position counter
  var posHtml = '<div class="nav-position">Article ' + (idx + 1) + ' sur ' + allEntries.length + '</div>';
  
  // Fiche express
  var ficheHtml = buildFicheExpress(entry);
  
  // Notes
  var noteText = getNote(entry.id);
  var notesHtml = '<div class="article-notes"><div class="article-notes-title"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Notes personnelles</div><textarea placeholder="Ajoutez vos notes, r\u00e9flexions, citations\u2026" oninput="saveNote(\'' + safeId(entry.id) + '\',this.value)">' + escapeHtml(noteText) + '</textarea></div>';
  
  // Share + fiche buttons
  var toolbarHtml = '<div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;margin-top:0.75rem;">' +
    '<button class="fiche-toggle" onclick="toggleFiche()">Fiche express</button>' +
    '<button class="share-btn" onclick="shareArticle()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg> Partager</button>' +
    '</div>' +
    buildTTSBar();
  
  // Collections
  var collectHtml = '<div style="margin-top:1rem;"><div style="font-family:var(--mono);font-size:0.55rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--gold);margin-bottom:0.4rem;display:flex;align-items:center;gap:0.4rem;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2z"/></svg> Collections</div>' + buildCollectionPicker(entry.id) + '</div>';

  // Stop previous reading timer, start new one
  stopReadingTimer();
  
  // Parcours banner
  var parcoursBannerHtml = buildParcoursBanner(id);

  content.innerHTML = '\n' +
    '    <article class="article article-enter">\n' +
    backLinkHtml + '\n' +
    breadcrumbHtml + '\n' +
    parcoursBannerHtml + '\n' +
    '      <header class="article-header" style="position:relative;">\n' +
    (entry._userEntry ? '        <button class="article-edit-top" onclick="openEditor(\'' + safeId(entry.id) + '\')" title="Modifier"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>' : '') + '\n' +
    '        <div class="article-category">' + (isMobile() ? '<span class="mobile-article-category-pill">' + escapeHtml(entry.category) + '</span>' : escapeHtml(entry.category)) + userBadge + '</div>\n' +
    '        <h2 class="article-title">' + escapeHtml(entry.term) + '</h2>\n' +
    readTimeHtml + '\n' +
    (entry.etymology ? '        <div class="article-etymology">' + escapeHtml(entry.etymology) + '</div>' : '') + '\n' +
    '        <div class="article-definition">' + escapeHtml(entry.definition) + '</div>\n' +
    toolbarHtml + '\n' +
    '      </header>\n' +
    ficheHtml + '\n' +
    '      <div class="article-body-wrap">\n' +
    '        <div class="article-body">' + linkedContent + '</div>\n' +
    '      </div>\n' +
    notesHtml + '\n' +
    '      <div class="article-tags" style="margin-top:2.5rem;padding-top:1.5rem;border-top:1px solid var(--border);">\n' +
    '        <span style="font-family:var(--mono);font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted-light);align-self:center;margin-right:0.5rem;">Mots-cl\u00e9s</span>\n' +
    tagsHtml + '\n' + customTagsHtml + '\n' +
    '      </div>\n' +
    (relatedHtml ? '      <div style="margin-top:1rem;"><span style="font-family:var(--mono);font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted-light);margin-right:0.5rem;">Articles li\u00e9s</span>' + relatedHtml + '</div>' : '') + '\n' +
    buildMiniGraph(entry) + '\n' +
    collectHtml + '\n' +
    footnoteResult.footnotesHtml + '\n' +
    (!entry._userEntry ? '      <div class="article-source"><a href="' + wikiUrl + '" target="_blank" rel="noopener">Lire sur Wikilivres \u2197</a></div>' : '') + '\n' +
    userActions + '\n' +
    posHtml + '\n' +
    navHtml + '\n' +
    '    </article>';
  
  // Post-render: TOC + font size + visited links + focus toggle
  buildTOC(content);
  applyFontSize();
  markVisitedLinks();
  restoreHighlights(id);
  startReadingTimer();
  showReadingToolbar();
  updateRtbBookmark();
  updateRtbFocus();
  // Progress map
  var pm = document.getElementById('progressMap');
  if (pm) pm.style.display = 'block';
  updateProgressMap();
  // Enable/disable TOC button based on headings count
  var rtbTocBtn = document.getElementById('rtbToc');
  if (rtbTocBtn) {
    var hCount = content.querySelectorAll('.article-body h3, .article-body h4').length;
    rtbTocBtn.style.opacity = hCount >= 2 ? '1' : '0.3';
    rtbTocBtn.style.pointerEvents = hCount >= 2 ? 'auto' : 'none';
  }
  var ft = document.getElementById('focusToggle');
  if (ft) ft.style.display = 'flex';
  
  // Desktop bookmark button
  const bookmarkBtn = document.getElementById('bookmarkBtn');
  bookmarkBtn.style.display = 'flex';
  bookmarkBtn.classList.toggle('bookmarked', isBookmarked);
  bookmarkBtn.innerHTML = isBookmarked 
    ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>'
    : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>';
  
  renderEntryList();
  
  // Mobile-specific
  if (isMobile()) {
    closeDrawer();
    mobileViewingArticle = true;
    document.getElementById('mobileArticleBar').style.display = 'flex';
    document.getElementById('mobileArticleTitle').textContent = entry.term;
    document.getElementById('mobileArticleTitle').classList.remove('visible');
    document.getElementById('mobileReadingProgress').style.display = 'block';
    document.getElementById('mobileReadingFill').style.width = '0%';
    document.getElementById('mobileFab').classList.add('hidden');
    document.querySelector('.mobile-tab-bar').classList.add('reading');
    var strip = document.getElementById('mobileAlphaStrip');
    if (strip) strip.style.display = 'none';
    updateMobileBookmarkBtn();
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    window.scrollTo({ top: 0, behavior: 'instant' });
    // Restore saved scroll position if any
    if (articleScrollPos[id]) {
      restoreScrollPos(id);
    }
  } else {
    document.getElementById('sidebar').classList.remove('mobile-open');
    content.scrollTop = 0;
    // Restore saved scroll position if any
    if (articleScrollPos[id]) {
      restoreScrollPos(id);
    }
  }
}

function updateMobileBookmarkBtn() {
  if (!currentArticle) return;
  const btn = document.getElementById('mobileBookmarkBtn');
  const isBookmarked = bookmarks.includes(currentArticle.id);
  btn.classList.toggle('bookmarked', isBookmarked);
  btn.innerHTML = isBookmarked
    ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>'
    : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>';
}

function searchTag(tag) {
  if (isMobile()) {
    switchTab('search');
    setTimeout(() => {
      const input = document.querySelector('.drawer-search');
      if (input) { input.value = tag; input.dispatchEvent(new Event('input')); }
    }, 400);
  } else {
    document.getElementById('searchInput').value = tag;
    searchQuery = tag;
    activeLetterFilter = null;
    updateAlphaNav();
    renderEntryList();
  }
}

// ===== WELCOME SCREEN =====
function showWelcome() {
  saveScrollPos();
  if (ttsActive) stopTTS();
  currentArticle = null;
  // Hide progress map
  var pm = document.getElementById('progressMap');
  if (pm) pm.style.display = 'none';
  // Exit immersive if active
  if (immersiveMode) toggleImmersive();
  mobileViewingArticle = false;
  document.getElementById('bookmarkBtn').style.display = 'none';
  var btt = document.getElementById('backToTop');
  if (btt) btt.classList.remove('visible');
  var ft = document.getElementById('focusToggle');
  if (ft) ft.style.display = 'none';
  if (focusMode) toggleFocusMode();
  stopReadingTimer();
  hideReadingToolbar();
  closeTocPanel();
  
  if (isMobile()) {
    document.getElementById('mobileArticleBar').style.display = 'none';
    document.getElementById('mobileReadingProgress').style.display = 'none';
    document.getElementById('mobileFab').classList.remove('hidden');
    document.querySelector('.mobile-tab-bar').classList.remove('reading');
    var strip = document.getElementById('mobileAlphaStrip');
    if (strip) strip.style.display = '';
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-tab="home"]').classList.add('active');
  }
  
  const allEntries = getAllEntries();
  const categories = new Set();
  const philosophers = new Set();
  const nonPhilosophers = ['Religion','Langage','Logique','Vertu','Devoir','Pluralisme','Mythologie','Nature','Immanence','Substance','Providence','Transcendance','Raison','Sagesse','Libert\u00e9','Capitalisme','Colonialisme','Dialectique','Paradoxe','Identit\u00e9','Rationalisme','Empirisme','Paradigme','Mouvement','Devenir','Connaissance','Scepticisme','Th\u00e9ologie','Facticit\u00e9','Ontologie','Biologie'];
  allEntries.forEach(e => {
    e.category.split(' \u00b7 ').forEach(c => categories.add(c));
    e.tags.forEach(t => {
      if (t[0] === t[0].toUpperCase() && !nonPhilosophers.includes(t)) philosophers.add(t);
    });
  });
  
  const readStats = getReadStats();
  const readPct = allEntries.length > 0 ? Math.round(readStats.read / readStats.total * 100) : 0;
  const hasContent = allEntries.length > 5;
  
  // Update notification banner
  const updateBannerHtml = pendingUpdatesCount > 0 ? '<div class="update-banner" onclick="checkForUpdates()">' +
    '<div class="update-banner-icon">↻</div>' +
    '<div class="update-banner-text"><span class="update-banner-count">' + pendingUpdatesCount + ' article' + (pendingUpdatesCount > 1 ? 's' : '') + '</span> modifié' + (pendingUpdatesCount > 1 ? 's' : '') + ' sur Wikilivres</div>' +
    '<div class="update-banner-arrow">›</div></div>' : '';

  // Article of the day
  const aotd = getArticleOfDay();
  const aotdExcerpt = aotd ? aotd.definition.replace(/<[^>]+>/g, '').slice(0, 140) : '';
  const aotdHtml = aotd ? `
    <div class="article-of-day" onclick="navigateTo('${safeId(aotd.id)}')">
      <div class="article-of-day-badge"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/></svg> Article du jour</div>
      <div class="article-of-day-title">${escapeHtml(aotd.term)}</div>
      <div class="article-of-day-excerpt">${escapeHtml(aotdExcerpt)}\u2026</div>
    </div>` : '';
  
  // Parcours guidés
  const parcoursHtml = hasContent ? buildParcoursCards() : '';

  // Smart suggestions (based on reading history) or random
  const smartEntries = readHistory.length > 3 ? getSmartSuggestions(allEntries) : [];
  const suggestionSource = smartEntries.length > 0 ? smartEntries : [...allEntries].sort(() => Math.random() - 0.5).slice(0, 4);
  const suggestionsLabel = smartEntries.length > 0 ? 'Recommandé pour vous' : '\u00c0 d\u00e9couvrir';
  const suggestionsIcon = smartEntries.length > 0 ? '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>' : '';
  const suggestionsHtml = suggestionSource.length > 0 ? `
    <div style="margin-top:1.75rem;">
      <div class="dash-smart-title">${suggestionsIcon} ${suggestionsLabel}</div>
      ${suggestionSource.map(e => `
        <div class="drawer-entry" onclick="navigateTo('${safeId(e.id)}')" style="border-radius:10px;margin:0 auto;max-width:420px;border:none;">
          <div class="drawer-entry-letter">${e._userEntry ? '\u270e' : e.letter}</div>
          <div class="drawer-entry-text">
            <div class="drawer-entry-name">${escapeHtml(e.term)}</div>
            <div class="drawer-entry-cat">${escapeHtml(e.category)}</div>
          </div>
          <div class="drawer-entry-arrow">\u203a</div>
        </div>`).join('')}
    </div>` : '';
  
  // Recent history (compact, max 4)
  const recentHistory = readHistory.slice(0, 4).map(h => {
    const e = allEntries.find(a => a.id === h.id);
    return e ? { ...e, time: h.time } : null;
  }).filter(Boolean);
  const historyHtml = recentHistory.length > 0 ? `
    <div style="margin-top:1.75rem;max-width:420px;margin-left:auto;margin-right:auto;">
      <div style="font-family:var(--mono);font-size:0.5rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted-light);margin-bottom:0.5rem;text-align:center;">Lectures r\u00e9centes</div>
      ${recentHistory.map(e => {
        const ago = Date.now() - e.time;
        const mins = Math.floor(ago / 60000);
        const timeStr = mins < 1 ? '\u00e0 l\u2019instant' : mins < 60 ? mins + ' min' : Math.floor(mins/60) + ' h';
        return `<div class="history-item" onclick="navigateTo('${safeId(e.id)}')"><span class="history-time">${timeStr}</span><span>${escapeHtml(e.term)}</span></div>`;
      }).join('')}
    </div>` : '';
  
  // Dashboard stats with streak + activity heatmap
  const streak = getReadingStreak();
  const activityMap = getActivityMap();
  const streakHtml = streak > 0 ? `<div class="dash-streak"><span class="dash-streak-fire">\ud83d\udd25</span> ${streak} jour${streak > 1 ? 's' : ''} consécutif${streak > 1 ? 's' : ''}</div>` : '';
  const activityHtml = readHistory.length > 0 ? `<div class="dash-activity" title="Activité des 28 derniers jours">${activityMap.map(d => {
    var lvl = d.count === 0 ? '' : d.count === 1 ? ' l1' : d.count <= 3 ? ' l2' : d.count <= 5 ? ' l3' : ' l4';
    return '<div class="dash-day' + lvl + '" title="' + d.day + ': ' + d.count + ' article' + (d.count > 1 ? 's' : '') + '"></div>';
  }).join('')}</div>` : '';
  
  const statsLine = allEntries.length > 0 ? `
    <div style="font-family:var(--mono);font-size:0.7rem;letter-spacing:0.04em;color:var(--muted);margin-top:1.5rem;">
      ${allEntries.length} articles \u00b7 ${categories.size} domaines \u00b7 ${readStats.read} lus (${readPct}%)
    </div>
    <div style="max-width:240px;margin:0.4rem auto 0;">
      <div class="reading-progress-bar" style="height:3px;"><div class="reading-progress-fill" style="width:${readPct}%"></div></div>
    </div>
    ${streakHtml}
    ${activityHtml}` : `
    <div style="font-family:var(--mono);font-size:0.7rem;letter-spacing:0.04em;color:var(--muted);margin-top:1.5rem;">
      ${allEntries.length} articles \u00b7 ${categories.size} domaines
    </div>`;
  
  // Quick actions (mobile)
  const mobileQuickHtml = isMobile() ? `
    <div class="mobile-quick-actions" style="margin-top:1.5rem;">
      <div class="mobile-quick-btn" onclick="switchTab('search')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <span>Recherche</span>
      </div>
      <div class="mobile-quick-btn" onclick="switchTab('index')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
        <span>Index</span>
      </div>
      <div class="mobile-quick-btn" onclick="showRandomArticle()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
        <span>Hasard</span>
      </div>
    </div>` : '';
  
  // Desktop quick actions (compact row)
  const desktopQuickHtml = !isMobile() ? `
    <div style="display:flex;justify-content:center;gap:0.5rem;margin-top:1.25rem;flex-wrap:wrap;">
      <button class="share-btn" onclick="showRandomArticle()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg> Hasard</button>
      <button class="share-btn" onclick="showPhilosopherIndex()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg> Philosophes</button>
      <button class="share-btn" onclick="showGraph()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="2"/><circle cx="5" cy="5" r="2"/><circle cx="19" cy="19" r="2"/><path d="M12 10V7M7 17l3 1M17 7l-3-1"/></svg> Graphe</button>
      <button class="share-btn" onclick="showGlossary()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg> Glossaire</button>
      <button class="share-btn" onclick="showStats()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg> Statistiques</button>
      ${Object.keys(articleNotes).length > 0 ? '<button class="share-btn" onclick="showNotesSearch()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Notes</button>' : ''}
      ${userEntries.length > 0 ? '<button class="share-btn" onclick="checkForUpdates()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg> MàJ' + (pendingUpdatesCount > 0 ? ' <span class="update-badge">' + pendingUpdatesCount + '</span>' : '') + '</button>' : ''}
    </div>` : '';
  
  // Import bar (collapsed if content exists)
  const importHtml = `
    <div style="margin-top:2rem;text-align:center;">
      ${hasContent ? `<button class="share-btn" id="showImportToggle" onclick="document.getElementById('massImportWrap').style.display='block';this.style.display='none';" style="margin-bottom:0.5rem;">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Importer plus d\u2019articles
      </button>` : ''}
      <div class="mass-import-bar" id="massImportWrap" ${hasContent ? 'style="display:none;"' : ''}>
        ${hasContent ? '' : '<h3>Importer le dictionnaire</h3>'}
        <p>T\u00e9l\u00e9chargez les articles du Dictionnaire de philosophie des Wikilivres.</p>
        <button class="btn btn-primary" id="massImportBtn" onclick="massImportFromWikibooks()" ${massImportRunning ? 'disabled' : ''}>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Importer depuis Wikilivres
        </button>
        <div class="mass-import-progress" id="massImportProgress" style="display:none;">
          <div class="mass-import-progress-bar"><div class="mass-import-progress-fill" id="massImportFill"></div></div>
          <div class="mass-import-status" id="massImportStatus"></div>
        </div>
      </div>
    </div>`;
  
  // Secondary tools (compact)
  const toolsHtml = isMobile() ? `
    <div style="display:flex;justify-content:center;gap:0.35rem;margin-top:1.25rem;flex-wrap:wrap;">
      <button class="share-btn" onclick="showPhilosopherIndex()">Philosophes</button>
      <button class="share-btn" onclick="showGraph()">Graphe</button>
      <button class="share-btn" onclick="showGlossary()">Glossaire</button>
      <button class="share-btn" onclick="showStats()">Stats</button>
      <button class="share-btn" onclick="showNotesSearch()">Notes</button>
      <button class="share-btn" onclick="checkForUpdates()">MàJ${pendingUpdatesCount > 0 ? ' <span class="update-badge">' + pendingUpdatesCount + '</span>' : ''}</button>
      <button class="share-btn" onclick="exportJSON()">Export</button>
      <button class="share-btn" onclick="generateEPUB()">EPUB</button>
      <button class="share-btn" onclick="importJSON()">Import</button>
    </div>` : `
    <div style="display:flex;justify-content:center;gap:0.5rem;margin-top:0.75rem;flex-wrap:wrap;">
      <button class="share-btn" onclick="exportJSON()">Exporter JSON</button>
      <button class="share-btn" onclick="generateEPUB()">EPUB</button>
      <button class="share-btn" onclick="importJSON()">Importer</button>
    </div>`;
  
  document.getElementById('content').innerHTML = `
    <div class="welcome welcome-enter">
      <button onclick="openSettings()" title="Apparence" style="position:absolute;top:1rem;right:1rem;z-index:10;width:38px;height:38px;display:flex;align-items:center;justify-content:center;background:var(--paper-warm);color:var(--muted);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      </button>
      <div class="welcome-ornament">\u03c6\u03b9\u03bb\u03bf\u03c3\u03bf\u03c6\u03af\u03b1</div>
      <h2>L\u2019amour de la <em>sagesse</em></h2>
      <p>Explorez les concepts de la philosophie occidentale, de l\u2019Antiquit\u00e9 \u00e0 la pens\u00e9e contemporaine.</p>
      ${statsLine}
      ${mobileQuickHtml}
      ${desktopQuickHtml}
      ${updateBannerHtml}
      ${aotdHtml}
      ${parcoursHtml}
      ${suggestionsHtml}
      ${historyHtml}
      ${importHtml}
      ${toolsHtml}
    </div>`;
  
  renderEntryList();
}

// ===== BOOKMARKS =====
function toggleBookmark() {
  if (!currentArticle) return;
  const idx = bookmarks.indexOf(currentArticle.id);
  if (idx > -1) bookmarks.splice(idx, 1);
  else bookmarks.push(currentArticle.id);
  PhiloDB.set('philo-bookmarks', JSON.stringify(bookmarks));
  
  if (isMobile()) { updateMobileBookmarkBtn(); }
  showArticle(currentArticle.id);
}

function toggleBookmarkFilter() {
  showOnlyBookmarks = !showOnlyBookmarks;
  document.getElementById('bookmarkFilter').classList.toggle('active', showOnlyBookmarks);
  renderEntryList();
}

// ===== MOBILE TAB BAR =====
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`[data-tab="${tab}"]`)?.classList.add('active');
  
  if (tab === 'home') {
    closeDrawer();
    showWelcome();
    return;
  }
  
  if (tab === 'editor') {
    closeDrawer();
    openEditor();
    return;
  }
  
  currentDrawerTab = tab;
  openDrawer(tab);
}

// ===== MOBILE DRAWER =====
function openDrawer(tab) {
  const drawer = document.getElementById('mobileDrawer');
  const header = document.getElementById('drawerHeader');
  const content = document.getElementById('drawerContent');
  const alphaStrip = document.getElementById('drawerAlpha');
  
  drawer.classList.add('open');
  document.body.style.overflow = 'hidden';
  
  const allEntries = getAllEntries();
  
  if (tab === 'index') {
    header.innerHTML = `<div class="drawer-title">Index des articles</div>`;
    buildDrawerAlpha();
    alphaStrip.style.display = 'flex';
    renderDrawerEntries(allEntries);
  } else if (tab === 'search') {
    header.innerHTML = `
      <div class="drawer-title">Recherche</div>
      <div class="drawer-search-wrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <input type="text" class="drawer-search" placeholder="Concept, philosophe, domaine\u2026" autocomplete="off">
      </div>`;
    
    // Category filter chips
    const cats = getCategories();
    const filterHtml = `<div class="drawer-filter-strip" id="drawerFilterStrip">
      <button class="drawer-filter-chip active" data-cat="" onclick="drawerFilterCategory('', this)">Tout</button>
      ${cats.map(c => `<button class="drawer-filter-chip" data-cat="${escapeAttr(c)}" onclick="drawerFilterCategory('${escapeAttr(c)}', this)">${c}</button>`).join('')}
    </div>`;
    
    alphaStrip.style.display = 'none';
    
    // Insert filter strip after header
    content.innerHTML = '';
    header.insertAdjacentHTML('afterend', filterHtml);
    
    drawerSearchState = { query: '', category: '' };
    renderDrawerSearchResults(allEntries);
    
    setTimeout(() => {
      const input = document.querySelector('.drawer-search');
      input?.focus();
      input?.addEventListener('input', (e) => {
        drawerSearchState.query = e.target.value.trim();
        applyDrawerSearch(allEntries);
      });
    }, 400);
  } else if (tab === 'favorites') {
    header.innerHTML = `<div class="drawer-title">Favoris</div>`;
    alphaStrip.style.display = 'none';
    const favEntries = allEntries.filter(e => bookmarks.includes(e.id));
    if (favEntries.length === 0) {
      content.innerHTML = `<div style="text-align:center;padding:3rem 1.5rem;">
        <div style="font-size:2.5rem;opacity:0.2;margin-bottom:1rem;">\u2605</div>
        <div style="font-family:var(--serif);font-size:1.2rem;color:var(--muted);margin-bottom:0.5rem;">Aucun favori</div>
        <div style="font-size:0.85rem;color:var(--muted-light);">Ajoutez des articles \u00e0 vos favoris pour les retrouver ici.</div>
      </div>`;
    } else {
      renderDrawerEntries(favEntries);
    }
  }
}

let drawerSearchState = { query: '', category: '' };

function drawerFilterCategory(cat, btn) {
  drawerSearchState.category = cat;
  document.querySelectorAll('.drawer-filter-chip').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const allEntries = getAllEntries();
  applyDrawerSearch(allEntries);
}

function applyDrawerSearch(allEntries) {
  let results = allEntries;
  if (drawerSearchState.query) {
    results = results.filter(ent => {
      const target = `${ent.term} ${ent.category} ${ent.definition} ${ent.tags.join(' ')} ${ent.etymology} ${ent.content.replace(/<[^>]+>/g, '')}`;
      return fuzzyMatch(drawerSearchState.query, target);
    });
  }
  if (drawerSearchState.category) {
    results = results.filter(ent => ent.category.includes(drawerSearchState.category));
  }
  renderDrawerSearchResults(results);
}

function renderDrawerSearchResults(entries) {
  // Add count before entries
  const countEl = document.getElementById('drawerResultsCount');
  if (countEl) countEl.remove();
  
  const content = document.getElementById('drawerContent');
  const countHtml = `<div class="drawer-results-count" id="drawerResultsCount">${entries.length} r\u00e9sultat${entries.length !== 1 ? 's' : ''}</div>`;
  content.insertAdjacentHTML('beforebegin', countHtml);
  
  renderDrawerEntries(entries);
}

function closeDrawer() {
  const drawer = document.getElementById('mobileDrawer');
  drawer.classList.remove('open');
  document.body.style.overflow = '';
  currentDrawerTab = null;
  // Cleanup injected elements
  document.getElementById('drawerResultsCount')?.remove();
  document.getElementById('drawerFilterStrip')?.remove();
}

function buildDrawerAlpha() {
  const strip = document.getElementById('drawerAlpha');
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
  const usedLetters = new Set(getAllEntries().map(e => e.letter));
  
  strip.innerHTML = `<button class="drawer-alpha-btn active" onclick="drawerFilterLetter(null, this)">\u2217</button>` +
    letters.map(l => 
      `<button class="drawer-alpha-btn ${usedLetters.has(l) ? 'has-entries' : ''}" onclick="drawerFilterLetter('${l}', this)">${l}</button>`
    ).join('');
}

let drawerLetterFilterState = null;

function drawerFilterLetter(letter, btn) {
  drawerLetterFilterState = letter;
  document.querySelectorAll('.drawer-alpha-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  
  let entries = getAllEntries();
  if (letter) entries = entries.filter(e => e.letter === letter);
  renderDrawerEntries(entries);
  
  btn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
}

function renderDrawerEntries(entries) {
  const content = document.getElementById('drawerContent');
  
  if (entries.length === 0) {
    content.innerHTML = `<div style="text-align:center;padding:3rem 1.5rem;">
      <div style="font-size:2.5rem;opacity:0.2;margin-bottom:1rem;">\u2205</div>
      <div style="font-family:var(--serif);font-size:1.2rem;color:var(--muted);">Aucun r\u00e9sultat</div>
    </div>`;
    return;
  }
  
  const grouped = {};
  entries.forEach(e => {
    if (!grouped[e.letter]) grouped[e.letter] = [];
    grouped[e.letter].push(e);
  });
  
  let html = '';
  Object.keys(grouped).sort().forEach(letter => {
    html += `<div class="drawer-letter-divider">${letter}</div>`;
    grouped[letter].forEach(entry => {
      const isBookmarked = bookmarks.includes(entry.id);
      const isUser = entry._userEntry;
      html += `
        <div class="drawer-entry" onclick="navigateTo('${safeId(entry.id)}')">
          <div class="drawer-entry-letter">${isUser ? '\u270e' : entry.letter}</div>
          <div class="drawer-entry-text">
            <div class="drawer-entry-name">${escapeHtml(entry.term)}</div>
            <div class="drawer-entry-cat">${escapeHtml(entry.category)}</div>
          </div>
          ${isBookmarked ? '<div class="drawer-entry-bookmark">\u2605</div>' : ''}
          <div class="drawer-entry-arrow">\u203a</div>
        </div>`;
    });
  });
  content.innerHTML = html;
}

// ===== MOBILE BACK =====
function mobileBack() {
  if (navHistory.length > 0) {
    // Go back to previous article
    var prevId = navHistory.pop();
    showArticle(prevId);
  } else {
    // Go to welcome screen
    mobileViewingArticle = false;
    document.getElementById('mobileArticleBar').style.display = 'none';
    document.getElementById('mobileReadingProgress').style.display = 'none';
    document.getElementById('mobileFab').classList.remove('hidden');
    document.querySelector('.mobile-tab-bar').classList.remove('reading');
    showWelcome();
  }
}

// ===== FEATURE: ARTICLE OF THE DAY =====
function getArticleOfDay() {
  var all = getAllEntries();
  if (all.length === 0) return null;
  // Deterministic: seed from date
  var d = new Date();
  var seed = d.getFullYear() * 10000 + (d.getMonth()+1) * 100 + d.getDate();
  var idx = seed % all.length;
  return all[idx];
}

// ===== FEATURE: FOCUS MODE =====
function toggleFocusMode() {
  focusMode = !focusMode;
  document.body.classList.toggle('focus-mode', focusMode);
  var btn = document.getElementById('focusToggle');
  if (btn) btn.title = focusMode ? 'Quitter le mode lecture' : 'Mode lecture';
  var strip = document.getElementById('mobileAlphaStrip');
  if (strip) strip.style.display = focusMode ? 'none' : '';
  updateRtbFocus();
}

// ===== FEATURE: RANDOM ARTICLE =====
function showRandomArticle() {
  var all = getAllEntries();
  var unread = all.filter(function(e) { return !readArticles.has(e.id); });
  var pool = unread.length > 0 ? unread : all;
  var pick = pool[Math.floor(Math.random() * pool.length)];
  if (pick) navigateTo(pick.id);
}

// ===== FEATURE: NOTES =====
function getNote(id) { return articleNotes[id] || ''; }
function saveNote(id, text) {
  if (text.trim()) articleNotes[id] = text.trim();
  else delete articleNotes[id];
  PhiloDB.set('philo-notes', JSON.stringify(articleNotes));
}

// ===== FEATURE: FICHE EXPRESS =====
function buildFicheExpress(entry) {
  var def = entry.definition.replace(/<[^>]+>/g, '');
  var body = entry.content.replace(/<[^>]+>/g, '');
  // Extract key sentences
  var sentences = body.split(/[.!?]+/).filter(function(s) { return s.trim().length > 30; });
  var keyPoints = [];
  // First sentence is often key
  if (sentences[0]) keyPoints.push(sentences[0].trim() + '.');
  // Find sentences with key markers
  var markers = ['est ', 'signifie', 'désigne', 'implique', 'suppose', 'selon ', 'pour ', 'consiste', 'se définit', 'renvoie'];
  for (var i = 1; i < sentences.length && keyPoints.length < 5; i++) {
    var s = sentences[i].trim();
    for (var m = 0; m < markers.length; m++) {
      if (s.toLowerCase().indexOf(markers[m]) >= 0 && keyPoints.indexOf(s + '.') < 0) {
        keyPoints.push(s + '.');
        break;
      }
    }
  }
  // Fill if needed
  for (var i = 1; i < sentences.length && keyPoints.length < 4; i++) {
    var s = sentences[i].trim() + '.';
    if (keyPoints.indexOf(s) < 0) keyPoints.push(s);
  }
  if (keyPoints.length === 0) keyPoints.push(def);
  var html = '<div class="fiche-express"><h4>Fiche de r\u00e9vision</h4><ul>';
  keyPoints.forEach(function(p) { html += '<li>' + p + '</li>'; });
  html += '</ul>';
  // Related terms
  var related = (entry.related || []).slice(0, 5);
  var auto = detectRelated(entry).slice(0, 5);
  auto.forEach(function(r) { if (related.indexOf(r) < 0) related.push(r); });
  if (related.length > 0) {
    var all = getAllEntries();
    html += '<div style="margin-top:0.75rem;font-family:var(--mono);font-size:0.5rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted-light);margin-bottom:0.35rem;">\u00c0 relier</div>';
    html += '<div class="article-tags">';
    related.slice(0,6).forEach(function(rid) {
      var re = all.find(function(a) { return a.id === rid; });
      if (re) html += '<span class="article-tag" onclick="navigateTo(\'' + safeId(re.id) + '\')">' + escapeHtml(re.term) + '</span>';
    });
    html += '</div>';
  }
  html += '</div>';
  return html;
}

function toggleFiche() {
  var art = document.querySelector('.article');
  if (!art) return;
  art.classList.toggle('fiche-mode');
  var btn = document.querySelector('.fiche-toggle');
  if (btn) btn.classList.toggle('active');
}

// ===== FEATURE: SHARE =====
function shareArticle() {
  if (!currentArticle) return;
  var text = currentArticle.term + ' \u2014 ' + currentArticle.definition.replace(/<[^>]+>/g, '').slice(0, 200);
  if (navigator.share) {
    navigator.share({ title: currentArticle.term, text: text }).catch(function(e) {});
  } else {
    // Copy to clipboard
    var ta = document.createElement('textarea');
    ta.value = currentArticle.term + '\n\n' + currentArticle.definition.replace(/<[^>]+>/g, '') + '\n\n' + currentArticle.content.replace(/<[^>]+>/g, '').slice(0, 500) + '...';
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); } catch(e) {}
    document.body.removeChild(ta);
    // Visual feedback
    var btn = document.querySelector('.share-btn');
    if (btn) { var orig = btn.innerHTML; btn.innerHTML = '\u2713 Copi\u00e9'; setTimeout(function() { btn.innerHTML = orig; }, 1500); }
  }
}

// ===== FEATURE: STATS =====
function showStats() {
  var all = getAllEntries();
  var readCount = 0;
  all.forEach(function(e) { if (readArticles.has(e.id)) readCount++; });
  var pct = all.length > 0 ? Math.round(readCount / all.length * 100) : 0;

  // Category breakdown
  var catCounts = {};
  var catRead = {};
  all.forEach(function(e) {
    var cats = e.category.split(' \u00b7 ');
    cats.forEach(function(c) {
      catCounts[c] = (catCounts[c] || 0) + 1;
      if (readArticles.has(e.id)) catRead[c] = (catRead[c] || 0) + 1;
    });
  });
  var sortedCats = Object.keys(catCounts).sort(function(a,b) { return catCounts[b] - catCounts[a]; });

  // Estimated total reading time
  var totalWords = 0;
  all.forEach(function(e) {
    if (readArticles.has(e.id)) {
      totalWords += e.content.replace(/<[^>]+>/g, '').split(/\s+/).length;
    }
  });
  var totalMins = Math.round(totalWords / 200);
  var totalTimeStr = totalMins < 60 ? totalMins + ' min' : Math.floor(totalMins/60) + 'h' + (totalMins%60 > 0 ? (totalMins%60) + 'min' : '');

  // Notes count
  var notesCount = Object.keys(articleNotes).length;

  // Quality metrics
  var withBiblio = 0, withNotes = 0;
  all.forEach(function(e) {
    var ws = e._wikiSource || '';
    if (/^=+\s*bibliographie\s*=+/im.test(ws)) withBiblio++;
    if (/<ref>/i.test(ws) || (e.refs && e.refs.length > 0)) withNotes++;
  });
  var noBiblio = all.length - withBiblio;
  var noNotes = all.length - withNotes;

  var barsHtml = '';
  sortedCats.slice(0, 10).forEach(function(c) {
    var total = catCounts[c];
    var read = catRead[c] || 0;
    var w = total > 0 ? Math.round(read / total * 100) : 0;
    barsHtml += '<div class="stats-bar-row">' +
      '<div class="stats-bar-label">' + c + '</div>' +
      '<div class="stats-bar"><div class="stats-bar-fill" style="width:' + w + '%"></div></div>' +
      '<div class="stats-bar-val">' + read + '/' + total + '</div></div>';
  });

  var overlay = document.createElement('div');
  overlay.className = 'stats-overlay';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  overlay.innerHTML = '<div class="stats-panel">' +
    '<h3>Statistiques de lecture</h3>' +
    '<div class="stats-grid">' +
      '<div class="stats-card"><div class="stats-card-num">' + readCount + '/' + all.length + '</div><div class="stats-card-label">Articles lus</div></div>' +
      '<div class="stats-card"><div class="stats-card-num">' + pct + '%</div><div class="stats-card-label">Progression</div></div>' +
      '<div class="stats-card"><div class="stats-card-num">' + totalTimeStr + '</div><div class="stats-card-label">Temps estim\u00e9</div></div>' +
    '</div>' +
    '<div class="reading-progress-bar" style="margin-bottom:1.5rem;height:10px;"><div class="reading-progress-fill" style="width:' + pct + '%"></div></div>' +
    '<div style="font-family:var(--mono);font-size:0.55rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted-light);margin-bottom:0.6rem;">Progression par domaine</div>' +
    barsHtml +
    '<div class="stats-grid" style="margin-top:1.5rem;">' +
      '<div class="stats-card"><div class="stats-card-num">' + notesCount + '</div><div class="stats-card-label">Notes</div></div>' +
      '<div class="stats-card"><div class="stats-card-num">' + bookmarks.length + '</div><div class="stats-card-label">Favoris</div></div>' +
      '<div class="stats-card"><div class="stats-card-num">' + userEntries.length + '</div><div class="stats-card-label">Perso.</div></div>' +
    '</div>' +
    '<div style="font-family:var(--mono);font-size:0.55rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted-light);margin:1.2rem 0 0.5rem;">Qualité des sources</div>' +
    '<div style="display:flex;gap:0.5rem;">' +
      '<div style="flex:1;padding:0.5rem;border:1px dashed var(--border-light);border-radius:6px;text-align:center;">' +
        '<div style="font-size:0.75rem;font-weight:600;color:' + (noBiblio > 0 ? 'var(--muted)' : 'var(--accent)') + ';">' + (all.length - noBiblio) + '/' + all.length + '</div>' +
        '<div style="font-family:var(--mono);font-size:0.4rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted-light);margin-top:0.15rem;">Avec bibliographie</div>' +
      '</div>' +
      '<div style="flex:1;padding:0.5rem;border:1px dashed var(--border-light);border-radius:6px;text-align:center;">' +
        '<div style="font-size:0.75rem;font-weight:600;color:' + (noNotes > 0 ? 'var(--muted)' : 'var(--accent)') + ';">' + (all.length - noNotes) + '/' + all.length + '</div>' +
        '<div style="font-family:var(--mono);font-size:0.4rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted-light);margin-top:0.15rem;">Avec notes / références</div>' +
      '</div>' +
    '</div>' +
    '<div style="text-align:center;"><button class="stats-close" onclick="this.closest(\'.stats-overlay\').remove()">Fermer</button></div>' +
  '</div>';
  document.body.appendChild(overlay);
}

// ===== FEATURE: SORT =====
function setSortMode(mode) {
  sortMode = mode;
  PhiloDB.set('philo-sort', mode);
  renderEntryList();
}

// ===== FEATURE: VISITED LINKS =====
function markVisitedLinks() {
  document.querySelectorAll('.auto-link').forEach(function(a) {
    var onclick = a.getAttribute('onclick') || '';
    var m = onclick.match(/navigateTo\('([^']+)'\)/);
    if (m && readArticles.has(m[1])) a.classList.add('visited');
  });
}

// ===== FEATURE: MOBILE ALPHA STRIP =====
function buildMobileAlphaStrip() {
  var strip = document.getElementById('mobileAlphaStrip');
  if (!strip) return;
  var used = new Set(getAllEntries().map(function(e) { return e.letter; }));
  var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
  var html = '';
  letters.forEach(function(l) {
    if (used.has(l)) {
      html += '<a data-letter="' + l + '">' + l + '</a>';
    }
  });
  // Attach sliding touch handler
  initAlphaSlider(strip);
  strip.innerHTML = html;
}

function mobileJumpToLetter(letter) {
  if (mobileViewingArticle) return;
  switchTab('index');
  setTimeout(function() {
    drawerFilterLetter(letter);
  }, 300);
}

// ===== FEATURE: COLLECTIONS =====
function saveCollections() {
  PhiloDB.set('philo-collections', JSON.stringify(collections));
}

function addToCollection(colName, articleId) {
  if (!collections[colName]) collections[colName] = [];
  if (collections[colName].indexOf(articleId) < 0) {
    collections[colName].push(articleId);
    saveCollections();
  }
}

function removeFromCollection(colName, articleId) {
  if (!collections[colName]) return;
  collections[colName] = collections[colName].filter(function(id) { return id !== articleId; });
  saveCollections();
}

function createCollection(name) {
  name = name.trim();
  if (!name || collections[name]) return;
  collections[name] = [];
  saveCollections();
}

function deleteCollection(name) {
  if (!confirm('Supprimer la collection \u00ab ' + name + ' \u00bb ?')) return;
  delete collections[name];
  if (activeCollection === name) activeCollection = null;
  saveCollections();
  renderEntryList();
}

function buildCollectionPicker(articleId) {
  var html = '<div class="collection-pills">';
  Object.keys(collections).forEach(function(name) {
    var isIn = collections[name].indexOf(articleId) >= 0;
    html += '<span class="collection-pill' + (isIn ? ' active' : '') + '" onclick="toggleArticleInCollection(\'' + escapeAttr(name) + '\',\'' + articleId + '\',this)">' + (isIn ? '\u2713 ' : '') + name + '</span>';
  });
  html += '<span class="collection-pill collection-add-btn" onclick="promptNewCollection(\'' + articleId + '\')">+ Nouvelle</span>';
  html += '</div>';
  return html;
}

function toggleArticleInCollection(name, articleId, el) {
  if (collections[name] && collections[name].indexOf(articleId) >= 0) {
    removeFromCollection(name, articleId);
  } else {
    addToCollection(name, articleId);
  }
  // Refresh the picker
  var container = el.closest('.collection-pills').parentElement;
  container.innerHTML = '<div style="font-family:var(--mono);font-size:0.55rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--gold);margin-bottom:0.4rem;display:flex;align-items:center;gap:0.4rem;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2z"/></svg> Collections</div>' + buildCollectionPicker(articleId);
}

function promptNewCollection(articleId) {
  var name = prompt('Nom de la nouvelle collection :');
  if (!name) return;
  createCollection(name);
  if (articleId) addToCollection(name, articleId);
  if (currentArticle) showArticle(currentArticle.id);
}

// ===== FEATURE: READING TIME TRACKING =====
function startReadingTimer() {
  if (currentArticle) {
    readingStartTimes._current = Date.now();
    readingStartTimes._currentId = currentArticle.id;
  }
}

function stopReadingTimer() {
  if (readingStartTimes._current && readingStartTimes._currentId) {
    var elapsed = Math.round((Date.now() - readingStartTimes._current) / 1000);
    if (elapsed > 5 && elapsed < 3600) { // Between 5s and 1h
      var id = readingStartTimes._currentId;
      readingStartTimes[id] = (readingStartTimes[id] || 0) + elapsed;
      PhiloDB.set('philo-reading-times', JSON.stringify(readingStartTimes));
    }
  }
  readingStartTimes._current = null;
  readingStartTimes._currentId = null;
}

// ===== READING TOOLBAR =====
function showReadingToolbar() {
  var tb = document.getElementById('readingToolbar');
  if (tb) tb.classList.add('visible');
  document.body.classList.add('has-toolbar');
  updateRtbBookmark();
}

function hideReadingToolbar() {
  var tb = document.getElementById('readingToolbar');
  if (tb) tb.classList.remove('visible');
  document.body.classList.remove('has-toolbar');
}

function updateRtbBookmark() {
  var btn = document.getElementById('rtbBookmark');
  if (!btn || !currentArticle) return;
  var isB = bookmarks.indexOf(currentArticle.id) >= 0;
  btn.classList.toggle('active', isB);
  btn.innerHTML = isB
    ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>'
    : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>';
}

function updateRtbFocus() {
  var btn = document.getElementById('rtbFocus');
  if (btn) btn.classList.toggle('active', focusMode);
}

// ===== TOC PANEL =====
function openTocPanel() {
  var overlay = document.getElementById('tocPanelOverlay');
  populateTocPanel();
  overlay.classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(function() {
    var active = document.querySelector('#tocPanelLinks a.active');
    if (active) active.scrollIntoView({ block: 'center', behavior: 'smooth' });
  }, 200);
}

function closeTocPanel() {
  var overlay = document.getElementById('tocPanelOverlay');
  overlay.classList.remove('open');
  document.body.style.overflow = '';
}

// Swipe-right-to-dismiss for TOC panel
(function() {
  var panel = document.getElementById('tocPanel');
  if (!panel) return;
  var startX = 0, currentX = 0, isDragging = false;
  panel.addEventListener('touchstart', function(e) {
    startX = e.touches[0].clientX; currentX = startX; isDragging = true;
  }, { passive: true });
  panel.addEventListener('touchmove', function(e) {
    if (!isDragging) return;
    currentX = e.touches[0].clientX;
    var diff = currentX - startX;
    if (diff > 0) { panel.style.transform = 'translateX(' + diff + 'px)'; panel.style.transition = 'none'; }
  }, { passive: true });
  panel.addEventListener('touchend', function() {
    if (!isDragging) return; isDragging = false;
    var diff = currentX - startX;
    panel.style.transition = ''; panel.style.transform = '';
    if (diff > 80) closeTocPanel();
  }, { passive: true });
})();

function populateTocPanel() {
  var container = document.getElementById('tocPanelLinks');
  if (!container) return;
  
  // Show article title
  var titleDiv = document.querySelector('.toc-panel-title');
  if (titleDiv && currentArticle) {
    titleDiv.textContent = currentArticle.term;
  } else if (titleDiv) {
    titleDiv.textContent = 'Sommaire';
  }
  
  var contentEl = document.getElementById('content');
  if (!contentEl) { container.innerHTML = '<div style="color:var(--muted-light);font-size:0.85rem;padding:0.5rem;">Aucun sommaire disponible.</div>'; return; }
  
  var headings = contentEl.querySelectorAll('.article-body h3, .article-body h4');
  if (headings.length < 2) {
    container.innerHTML = '<div style="color:var(--muted-light);font-size:0.85rem;padding:0.5rem;">Cet article n\u2019a pas de sections.</div>';
    return;
  }
  
  tocPanelHeadings = headings;
  var html = '';
  for (var i = 0; i < headings.length; i++) {
    var h = headings[i];
    var isSub = h.tagName === 'H4';
    html += '<a href="#" class="' + (isSub ? 'toc-sub' : '') + '" data-toc-idx="' + i + '" onclick="event.preventDefault();tocPanelJump(' + i + ')">' + h.textContent + '</a>';
  }
  
  // Add prev/next article links at bottom
  var allE = getAllEntries();
  var ci = currentArticle ? allE.findIndex(function(en) { return en.id === currentArticle.id; }) : -1;
  if (ci >= 0) {
    html += '<div style="margin-top:1rem;padding-top:0.75rem;border-top:1px solid var(--border-light);">';
    if (ci > 0) {
      html += '<a href="#" onclick="event.preventDefault();closeTocPanel();navigateTo(\'' + allE[ci-1].id + '\')" style="font-size:0.75rem;color:var(--muted-light);display:flex;align-items:center;gap:0.3rem;margin-bottom:0.3rem;">' +
        '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>' +
        escapeHtml(allE[ci-1].term) + '</a>';
    }
    if (ci < allE.length - 1) {
      html += '<a href="#" onclick="event.preventDefault();closeTocPanel();navigateTo(\'' + allE[ci+1].id + '\')" style="font-size:0.75rem;color:var(--muted-light);display:flex;align-items:center;gap:0.3rem;justify-content:flex-end;">' +
        escapeHtml(allE[ci+1].term) +
        '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></a>';
    }
    html += '</div>';
  }
  
  container.innerHTML = html;
  updateTocPanelActive();
}

function tocPanelJump(idx) {
  var h = tocPanelHeadings[idx];
  if (h) {
    closeTocPanel();
    setTimeout(function() {
      h.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 150);
  }
}

function updateTocPanelActive() {
  if (!tocPanelHeadings || tocPanelHeadings.length === 0) return;
  var links = document.querySelectorAll('#tocPanelLinks a[data-toc-idx]');
  var active = 0;
  for (var j = 0; j < tocPanelHeadings.length; j++) {
    if (tocPanelHeadings[j].getBoundingClientRect().top < 140) active = j;
  }
  links.forEach(function(a, i) {
    a.classList.toggle('active', i === active);
  });
}

// ===== SETTINGS PANEL =====
function openSettings() {
  var overlay = document.getElementById('settingsOverlay');
  overlay.classList.add('open');
  syncSettingsUI();
  // Prevent body scroll while settings open
  document.body.style.overflow = 'hidden';
}

function closeSettings() {
  document.getElementById('settingsOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

// Swipe-to-dismiss for settings panel
(function() {
  var panel = document.getElementById('settingsPanel');
  if (!panel) return;
  var startY = 0, currentY = 0, isDragging = false;
  
  panel.addEventListener('touchstart', function(e) {
    // Only start drag if at scroll top or touching the handle area
    if (panel.scrollTop > 5) return;
    startY = e.touches[0].clientY;
    isDragging = true;
  }, { passive: true });
  
  panel.addEventListener('touchmove', function(e) {
    if (!isDragging) return;
    currentY = e.touches[0].clientY;
    var diff = currentY - startY;
    if (diff > 0) {
      panel.style.transform = 'translateY(' + diff + 'px)';
      panel.style.transition = 'none';
    }
  }, { passive: true });
  
  panel.addEventListener('touchend', function() {
    if (!isDragging) return;
    isDragging = false;
    var diff = currentY - startY;
    panel.style.transition = '';
    panel.style.transform = '';
    if (diff > 100) {
      closeSettings();
    }
  }, { passive: true });
})();

function syncSettingsUI() {
  // Font size
  var fsSlider = document.getElementById('settingsFontSize');
  var fsVal = document.getElementById('settingsFontVal');
  if (fsSlider) { fsSlider.value = currentFontSize; }
  if (fsVal) { fsVal.textContent = currentFontSize + '%'; }
  
  // Line height
  var lhSlider = document.getElementById('settingsLineHeight');
  var lhVal = document.getElementById('settingsLHVal');
  if (lhSlider) { lhSlider.value = appLineHeight; }
  if (lhVal) { lhVal.textContent = (appLineHeight / 100).toFixed(1); }
  
  // Text width
  var twSlider = document.getElementById('settingsTextWidth');
  var twVal = document.getElementById('settingsTWVal');
  if (twSlider) { twSlider.value = appTextWidth; }
  if (twVal) { twVal.textContent = appTextWidth + 'px'; }
  
  // Font family
  document.querySelectorAll('#settingsFontFamily .settings-chip').forEach(function(btn) {
    btn.classList.toggle('active', btn.getAttribute('data-font') === appBodyFont);
  });
  
  // Theme buttons
  var currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
  updateSettingsThemeButtons(currentTheme);
  
  // Para spacing
  var psSlider = document.getElementById('settingsParaSpacing');
  var psVal = document.getElementById('settingsParaVal');
  if (psSlider) { psSlider.value = appParaSpacing; }
  if (psVal) { psVal.textContent = (appParaSpacing / 100).toFixed(2) + 'em'; }

  // Toggles
  var jBtn = document.getElementById('settingsJustify');
  if (jBtn) jBtn.classList.toggle('on', appJustify);
  var iBtn = document.getElementById('settingsIndent');
  if (iBtn) iBtn.classList.toggle('on', appIndent);
  var letBtn = document.getElementById('settingsLettrine');
  if (letBtn) letBtn.classList.toggle('on', appLettrine);
  var hlBtn = document.getElementById('settingsHighlight');
  if (hlBtn) hlBtn.classList.toggle('on', highlightMode);
  
  // Accent color
  document.querySelectorAll('#settingsAccent .settings-chip').forEach(function(btn) {
    btn.classList.toggle('active', btn.getAttribute('data-accent') === appAccent);
  });
  
  // Preview
  updateSettingsPreview();
}

// ===== APPEARANCE FUNCTIONS =====
function setFontSize(val) {
  currentFontSize = parseInt(val);
  PhiloDB.set('philo-fontsize', currentFontSize);
  applyAppearance();
  var fsVal = document.getElementById('settingsFontVal');
  if (fsVal) fsVal.textContent = currentFontSize + '%';
}

function setLineHeight(val) {
  appLineHeight = parseInt(val);
  PhiloDB.set('philo-line-height', appLineHeight);
  applyAppearance();
  var lhVal = document.getElementById('settingsLHVal');
  if (lhVal) lhVal.textContent = (appLineHeight / 100).toFixed(1);
}

function setTextWidth(val) {
  appTextWidth = parseInt(val);
  PhiloDB.set('philo-text-width', appTextWidth);
  applyAppearance();
  var twVal = document.getElementById('settingsTWVal');
  if (twVal) twVal.textContent = appTextWidth + 'px';
}

function setBodyFont(fontKey) {
  appBodyFont = fontKey;
  PhiloDB.set('philo-body-font', fontKey);
  applyAppearance();
  document.querySelectorAll('#settingsFontFamily .settings-chip').forEach(function(btn) {
    btn.classList.toggle('active', btn.getAttribute('data-font') === fontKey);
  });
}

function toggleJustify(btn) {
  appJustify = !appJustify;
  btn.classList.toggle('on', appJustify);
  PhiloDB.set('philo-justify', appJustify ? 'true' : 'false');
  applyAppearance();
}

function toggleIndent(btn) {
  appIndent = !appIndent;
  btn.classList.toggle('on', appIndent);
  PhiloDB.set('philo-indent', appIndent ? 'true' : 'false');
  applyAppearance();
}

var accentColors = {
  crimson:  { accent: '#8b2500', accentLight: '#c4502a', darkAccent: '#d4734a', darkAccentLight: '#e8956a' },
  navy:     { accent: '#1a4a6e', accentLight: '#2d6fa0', darkAccent: '#5a9fce', darkAccentLight: '#7cb8dc' },
  forest:   { accent: '#2d5a27', accentLight: '#408a38', darkAccent: '#5dae54', darkAccentLight: '#7ec876' },
  plum:     { accent: '#6b2d5b', accentLight: '#9a4282', darkAccent: '#c06aaa', darkAccentLight: '#d48cc0' },
  amber:    { accent: '#b8860b', accentLight: '#d4a020', darkAccent: '#e8b830', darkAccentLight: '#f0cc60' },
  burgundy: { accent: '#722f37', accentLight: '#9a3f4a', darkAccent: '#c86070', darkAccentLight: '#d88898' },
  teal:     { accent: '#1a6e5e', accentLight: '#289a84', darkAccent: '#3cc8aa', darkAccentLight: '#60d8be' },
  slate:    { accent: '#4a5568', accentLight: '#6b7d95', darkAccent: '#90a4bc', darkAccentLight: '#a8bcd0' }
};

function setAccentColor(key) {
  appAccent = key;
  PhiloDB.set('philo-accent', key);
  applyAppearance();
  document.querySelectorAll('#settingsAccent .settings-chip').forEach(function(btn) {
    btn.classList.toggle('active', btn.getAttribute('data-accent') === key);
  });
}

function resetAppearance() {
  currentFontSize = 100; appLineHeight = 190; appTextWidth = 680;
  appBodyFont = 'serif'; appJustify = false; appIndent = true;
  appAccent = 'crimson'; appParaSpacing = 125; appLettrine = true;
  PhiloDB.set('philo-fontsize', 100);
  PhiloDB.set('philo-line-height', 190);
  PhiloDB.set('philo-text-width', 680);
  PhiloDB.set('philo-body-font', 'serif');
  PhiloDB.set('philo-justify', 'false');
  PhiloDB.set('philo-indent', 'true');
  PhiloDB.set('philo-accent', 'crimson');
  PhiloDB.set('philo-para-spacing', 125);
  PhiloDB.set('philo-lettrine', 'true');
  applyFontSize();
  applyAppearance();
  applyLettrine();
  syncSettingsUI();
}

function applyAppearance() {
  var fontMap = {
    'serif': "'Source Serif 4', Georgia, serif",
    'garamond': "'Cormorant Garamond', Georgia, serif",
    'baskerville': "'Libre Baskerville', Georgia, serif",
    'crimson': "'Crimson Text', Georgia, serif",
    'ebgaramond': "'EB Garamond', Georgia, serif",
    'lora': "'Lora', Georgia, serif",
    'system': "system-ui, -apple-system, 'Segoe UI', sans-serif",
    'mono': "'JetBrains Mono', monospace"
  };
  var fontStack = fontMap[appBodyFont] || fontMap['serif'];
  var scale = currentFontSize / 100;
  
  // Font-size multiplier per font (garamond renders larger, mono smaller)
  var fontMult = 1;
  if (appBodyFont === 'garamond') fontMult = 1.05;
  else if (appBodyFont === 'ebgaramond') fontMult = 1.03;
  else if (appBodyFont === 'crimson') fontMult = 1.02;
  else if (appBodyFont === 'mono') fontMult = 0.88;
  
  // Remove both old style IDs (legacy + current)
  ['appearance-overrides', 'font-size-override'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.remove();
  });
  
  // Build one unified stylesheet
  var pSize = (scale * fontMult).toFixed(3);
  var css = '';
  
  // Font-size for all text elements (always set, even at 100%, to keep garamond/mono ratios)
  css += '.article-body p, .article-body li { font-size: ' + pSize + 'rem !important; }\n';
  css += '.article-body h3 { font-size: ' + (1.15 * scale).toFixed(3) + 'rem !important; }\n';
  css += '.article-body h4 { font-size: ' + (1.0 * scale).toFixed(3) + 'rem !important; }\n';
  css += '.article-body blockquote { font-size: ' + (0.92 * scale * fontMult).toFixed(3) + 'rem !important; }\n';
  css += '.article-definition { font-size: ' + (1.05 * scale).toFixed(3) + 'rem !important; }\n';
  css += '.article-notes textarea { font-size: ' + (0.88 * scale).toFixed(3) + 'rem !important; }\n';
  
  // Font-family + line-height + text options
  css += '.article-body p, .article-body li, .article-body blockquote, .article-definition, .article-notes textarea { ' +
    'line-height: ' + (appLineHeight / 100) + ' !important; ' +
    'font-family: ' + fontStack + ' !important; ' +
    (appJustify ? 'text-align: justify !important; hyphens: auto !important; -webkit-hyphens: auto !important; hyphenate-limit-chars: 6 3 2 !important; overflow-wrap: break-word !important; ' : '') +
    '}\n';
  
  // Mono letter-spacing
  if (appBodyFont === 'mono') {
    css += '.article-body p, .article-body li { letter-spacing: -0.01em !important; }\n';
  }
  
  // Text width
  css += '.article-body-wrap { max-width: ' + appTextWidth + 'px !important; }\n';
  css += '.focus-mode .article-body-wrap { max-width: ' + Math.min(appTextWidth, 720) + 'px !important; }\n';
  
  // Text indent
  if (!appIndent) {
    css += '.article-body p { text-indent: 0 !important; }\n';
  }

  // Paragraph spacing
  var paraEm = (appParaSpacing / 100).toFixed(2);
  css += '.article-body p { margin-bottom: ' + paraEm + 'em !important; }\n';
  
  // Accent color overrides
  var ac = accentColors[appAccent];
  if (ac && appAccent !== 'crimson') {
    css += ':root { --accent: ' + ac.accent + '; --accent-light: ' + ac.accentLight + '; }\n';
    css += '[data-theme="dark"] { --accent: ' + ac.darkAccent + '; --accent-light: ' + ac.darkAccentLight + '; }\n';
    css += '[data-theme="sepia"] { --accent: ' + ac.accent + '; --accent-light: ' + ac.accentLight + '; }\n';
  }
  
  var style = document.createElement('style');
  style.id = 'appearance-overrides';
  style.textContent = css;
  document.head.appendChild(style);
  
  updateSettingsPreview();
}

function updateSettingsPreview() {
  var el = document.getElementById('settingsPreviewText');
  if (!el) return;
  var fontMap = {
    'serif': "'Source Serif 4', Georgia, serif",
    'garamond': "'Cormorant Garamond', Georgia, serif",
    'baskerville': "'Libre Baskerville', Georgia, serif",
    'crimson': "'Crimson Text', Georgia, serif",
    'ebgaramond': "'EB Garamond', Georgia, serif",
    'lora': "'Lora', Georgia, serif",
    'system': "system-ui, -apple-system, 'Segoe UI', sans-serif",
    'mono': "'JetBrains Mono', monospace"
  };
  var fontStack = fontMap[appBodyFont] || fontMap['serif'];
  var scale = currentFontSize / 100;
  el.style.fontFamily = fontStack;
  el.style.fontSize = (0.88 * scale) + 'rem';
  el.style.lineHeight = (appLineHeight / 100);
  el.style.textAlign = appJustify ? 'justify' : 'left';
  el.style.textIndent = appIndent ? '1.2em' : '0';
}

// ===== PARAGRAPH SPACING =====
function setParaSpacing(val) {
  appParaSpacing = parseInt(val);
  PhiloDB.set('philo-para-spacing', appParaSpacing);
  applyAppearance();
  var psVal = document.getElementById('settingsParaVal');
  if (psVal) psVal.textContent = (appParaSpacing / 100).toFixed(2) + 'em';
}

// ===== LETTRINE =====
var highlightMode = lsGet('philo-highlight-mode', 'false') === 'true';

function applyLettrine() {
  // Lettrine is now injected via HTML in showArticle, so re-render if needed
  if (currentArticle) showArticle(currentArticle.id);
}

function toggleLettrine(btn) {
  appLettrine = !appLettrine;
  if (btn) btn.classList.toggle('on', appLettrine);
  PhiloDB.set('philo-lettrine', appLettrine ? 'true' : 'false');
  if (currentArticle) showArticle(currentArticle.id);
}

// ===== HIGHLIGHT MODE =====
function toggleHighlightMode(btn) {
  highlightMode = !highlightMode;
  if (btn) btn.classList.toggle('on', highlightMode);
  document.body.classList.toggle('highlight-mode', highlightMode);
  PhiloDB.set('philo-highlight-mode', highlightMode ? 'true' : 'false');
  try { localStorage.setItem('philo-highlight-mode', highlightMode ? 'true' : 'false'); } catch(e) {}
}

function handleHighlightSelection() {
  if (!highlightMode || !currentArticle) return;
  var sel = window.getSelection();
  if (!sel || sel.isCollapsed || !sel.rangeCount) return;
  var range = sel.getRangeAt(0);
  var body = document.querySelector('.article-body');
  if (!body || !body.contains(range.commonAncestorContainer)) return;
  var text = sel.toString().trim();
  if (text.length < 3) return;
  
  // Wrap selection in highlight span
  var span = document.createElement('span');
  span.className = 'user-highlight';
  span.title = 'Cliquer pour supprimer le surlignage';
  span.onclick = function(e) {
    e.stopPropagation();
    // Unwrap highlight
    var parent = this.parentNode;
    while (this.firstChild) parent.insertBefore(this.firstChild, this);
    parent.removeChild(this);
    saveHighlights();
  };
  try {
    range.surroundContents(span);
    sel.removeAllRanges();
    saveHighlights();
  } catch(e) { /* cross-element selections */ }
}

function saveHighlights() {
  if (!currentArticle) return;
  var body = document.querySelector('.article-body');
  if (!body) return;
  var highlights = [];
  body.querySelectorAll('.user-highlight').forEach(function(hl) {
    highlights.push(hl.textContent);
  });
  articleHighlights[currentArticle.id] = highlights;
  PhiloDB.set('philo-highlights', JSON.stringify(articleHighlights));
}

function restoreHighlights(id) {
  var saved = articleHighlights[id];
  if (!saved || saved.length === 0) return;
  var body = document.querySelector('.article-body');
  if (!body) return;
  
  saved.forEach(function(text) {
    if (!text || text.length < 3) return;
    var walker = document.createTreeWalker(body, NodeFilter.SHOW_TEXT, null, false);
    var node;
    while (node = walker.nextNode()) {
      var idx = node.textContent.indexOf(text);
      if (idx >= 0 && !node.parentElement.classList.contains('user-highlight')) {
        var range = document.createRange();
        range.setStart(node, idx);
        range.setEnd(node, idx + text.length);
        var span = document.createElement('span');
        span.className = 'user-highlight';
        span.title = 'Cliquer pour supprimer le surlignage';
        span.onclick = function(e) {
          e.stopPropagation();
          var parent = this.parentNode;
          while (this.firstChild) parent.insertBefore(this.firstChild, this);
          parent.removeChild(this);
          saveHighlights();
        };
        try { range.surroundContents(span); } catch(e) {}
        break;
      }
    }
  });
}

// ===== IMMERSIVE MODE =====
var immersiveMode = false;

function toggleImmersive() {
  immersiveMode = !immersiveMode;
  document.body.classList.toggle('immersive-mode', immersiveMode);
  if (!immersiveMode) {
    // Restore UI elements
    if (currentArticle) {
      showReadingToolbar();
      var pm = document.getElementById('progressMap');
      if (pm) pm.style.display = currentArticle ? 'block' : 'none';
    }
  } else {
    hideReadingToolbar();
  }
}

// ===== SCROLL POSITION BOOKMARK =====
function saveScrollPos() {
  if (!currentArticle) return;
  var contentEl = document.querySelector('.content');
  var scrollY = isMobile() ? window.scrollY : (contentEl ? contentEl.scrollTop : 0);
  var article = document.querySelector('.article');
  if (!article) return;
  var articleH = article.scrollHeight;
  if (articleH < 100) return;
  var pct = scrollY / articleH;
  if (pct < 0.03) {
    // Near top: remove saved position
    delete articleScrollPos[currentArticle.id];
  } else {
    articleScrollPos[currentArticle.id] = { pct: pct, time: Date.now() };
  }
  PhiloDB.set('philo-scroll-pos', JSON.stringify(articleScrollPos));
}

function restoreScrollPos(id) {
  var saved = articleScrollPos[id];
  if (!saved || !saved.pct) return;
  // Only restore if saved recently (within 7 days)
  if (Date.now() - saved.time > 7 * 86400000) {
    delete articleScrollPos[id];
    PhiloDB.set('philo-scroll-pos', JSON.stringify(articleScrollPos));
    return;
  }
  setTimeout(function() {
    var article = document.querySelector('.article');
    if (!article) return;
    var targetY = saved.pct * article.scrollHeight;
    if (isMobile()) {
      window.scrollTo({ top: targetY, behavior: 'smooth' });
    } else {
      var contentEl = document.querySelector('.content');
      if (contentEl) contentEl.scrollTo({ top: targetY, behavior: 'smooth' });
    }
    // Show a subtle resume indicator
    showResumeIndicator(targetY);
  }, 200);
}

function showResumeIndicator(scrollY) {
  var body = document.querySelector('.article-body');
  if (!body) return;
  // Find the paragraph at this scroll position
  var paras = body.querySelectorAll('p, h3, h4');
  for (var i = 0; i < paras.length; i++) {
    var rect = paras[i].getBoundingClientRect();
    var elTop = paras[i].offsetTop;
    if (elTop >= scrollY - 50) {
      var marker = document.createElement('div');
      marker.className = 'scroll-resume';
      marker.title = 'Reprise de lecture';
      paras[i].style.position = 'relative';
      paras[i].appendChild(marker);
      break;
    }
  }
}

// ===== PROGRESS MAP =====
function updateProgressMap() {
  var map = document.getElementById('progressMap');
  var fill = document.getElementById('progressMapFill');
  if (!map || !fill || !currentArticle) return;
  
  var article = document.querySelector('.article');
  if (!article) { map.style.display = 'none'; return; }
  
  map.style.display = 'block';
  var contentEl = document.querySelector('.content');
  var scrollY = isMobile() ? window.scrollY : (contentEl ? contentEl.scrollTop : 0);
  var viewH = isMobile() ? window.innerHeight : (contentEl ? contentEl.clientHeight : window.innerHeight);
  var articleH = article.scrollHeight;
  var pct = Math.min(100, Math.max(0, ((scrollY + viewH * 0.5) / articleH) * 100));
  fill.style.height = pct + '%';
}

// ===== DOUBLE-TAP ZOOM (MOBILE) =====
var lastTapTime = 0;
var lastTapTarget = null;

function handleDoubleTap(e) {
  if (!isMobile() || !currentArticle) return;
  var target = e.target.closest('.article-body p, .article-body blockquote');
  if (!target) return;
  
  var now = Date.now();
  if (now - lastTapTime < 350 && lastTapTarget === target) {
    // Double tap detected
    e.preventDefault();
    target.classList.toggle('para-zoomed');
    lastTapTime = 0;
    lastTapTarget = null;
  } else {
    lastTapTime = now;
    lastTapTarget = target;
  }
}

// ===== PARCOURS GUIDÉS =====
var parcoursDefinitions = [
  { id: 'ethique', icon: '⚖️', title: 'Éthique & morale', desc: 'Les fondements de l\'action juste',
    keywords: ['éthique','morale','vertu','devoir','bien','mal','justice','bonheur','liberté','conscience','responsabilité','volonté'] },
  { id: 'connaissance', icon: '🔍', title: 'Théorie de la connaissance', desc: 'Savoir, croire, douter',
    keywords: ['connaissance','vérité','raison','empirisme','rationalisme','scepticisme','logique','science','certitude','doute','perception','jugement'] },
  { id: 'politique', icon: '🏛️', title: 'Philosophie politique', desc: 'Pouvoir, société, contrat',
    keywords: ['politique','état','pouvoir','démocratie','liberté','droit','justice','loi','contrat','société','capitalisme','colonialisme','révolution'] },
  { id: 'existence', icon: '💭', title: 'Existence & métaphysique', desc: 'L\'être, le temps, la mort',
    keywords: ['existence','être','néant','mort','temps','conscience','âme','substance','identité','devenir','ontologie','phénoménologie','absurde'] },
  { id: 'langage', icon: '📖', title: 'Langage & pensée', desc: 'Mots, signes, vérité',
    keywords: ['langage','signe','sens','vérité','logique','dialectique','rhétorique','herméneutique','interprétation','concept','idée','définition'] },
  { id: 'esthetique', icon: '🎭', title: 'Esthétique', desc: 'Le beau, l\'art, le sublime',
    keywords: ['esthétique','art','beau','beauté','sublime','goût','création','imagination','sensible','contemplation'] }
];

var activeParcoursId = lsGet('philo-active-parcours', '');
var parcoursProgress = safeParse(lsGet('philo-parcours-progress', '{}'), {});

function getParcoursArticles(parcours) {
  var all = getAllEntries();
  var found = [];
  var kws = parcours.keywords.map(function(k) { return k.toLowerCase(); });
  all.forEach(function(e) {
    var term = e.term.toLowerCase();
    var cats = e.category.toLowerCase();
    var tags = e.tags.map(function(t) { return t.toLowerCase(); });
    var def = (e.definition || '').toLowerCase();
    var score = 0;
    kws.forEach(function(k) {
      if (term.includes(k)) score += 5;
      if (tags.some(function(t) { return t.includes(k); })) score += 3;
      if (cats.includes(k)) score += 2;
      if (def.includes(k)) score += 1;
    });
    if (score > 0) found.push({ entry: e, score: score });
  });
  found.sort(function(a, b) { return b.score - a.score; });
  return found.slice(0, 12).map(function(f) { return f.entry; });
}

function buildParcoursCards() {
  var all = getAllEntries();
  if (all.length < 10) return '';
  var html = '<div style="margin-top:1.75rem;">' +
    '<div style="font-family:var(--mono);font-size:0.5rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted-light);margin-bottom:0.5rem;text-align:center;">Parcours thématiques</div>';
  
  parcoursDefinitions.forEach(function(p) {
    var articles = getParcoursArticles(p);
    if (articles.length < 3) return;
    var prog = parcoursProgress[p.id] || [];
    var done = prog.filter(function(id) { return articles.some(function(a) { return a.id === id; }); }).length;
    var pct = Math.round(done / articles.length * 100);
    html += '<button class="parcours-card" onclick="startParcours(\'' + p.id + '\')">' +
      '<div class="parcours-icon">' + p.icon + '</div>' +
      '<div class="parcours-info"><div class="parcours-title">' + p.title + '</div>' +
      '<div class="parcours-meta">' + articles.length + ' articles · ' + p.desc + '</div></div>' +
      '<div class="parcours-progress">' + (done > 0 ? pct + '%' : '→') + '</div></button>';
  });
  html += '</div>';
  return html;
}

function startParcours(id) {
  var parcours = parcoursDefinitions.find(function(p) { return p.id === id; });
  if (!parcours) return;
  activeParcoursId = id;
  PhiloDB.set('philo-active-parcours', id);
  var articles = getParcoursArticles(parcours);
  if (articles.length === 0) return;
  // Find first unread in this parcours
  var prog = parcoursProgress[id] || [];
  var next = articles.find(function(a) { return prog.indexOf(a.id) < 0; });
  navigateTo((next || articles[0]).id);
}

function getParcoursForArticle(id) {
  if (!activeParcoursId) return null;
  var parcours = parcoursDefinitions.find(function(p) { return p.id === activeParcoursId; });
  if (!parcours) return null;
  var articles = getParcoursArticles(parcours);
  var idx = articles.findIndex(function(a) { return a.id === id; });
  if (idx < 0) return null;
  return { parcours: parcours, articles: articles, index: idx };
}

function buildParcoursBanner(id) {
  var info = getParcoursForArticle(id);
  if (!info) return '';
  var prog = parcoursProgress[info.parcours.id] || [];
  // Mark current as done
  if (prog.indexOf(id) < 0) {
    prog.push(id);
    parcoursProgress[info.parcours.id] = prog;
    PhiloDB.set('philo-parcours-progress', JSON.stringify(parcoursProgress));
  }
  var dots = info.articles.map(function(a, i) {
    var cls = 'parcours-banner-dot';
    if (a.id === id) cls += ' current';
    else if (prog.indexOf(a.id) >= 0) cls += ' done';
    return '<div class="' + cls + '"></div>';
  }).join('');
  var nextIdx = info.index + 1;
  var nextBtn = nextIdx < info.articles.length
    ? '<span class="parcours-banner-next" onclick="navigateTo(\'' + info.articles[nextIdx].id + '\')">Suivant →</span>'
    : '<span class="parcours-banner-next" onclick="activeParcoursId=\'\';PhiloDB.set(\'philo-active-parcours\',\'\');showWelcome();">✓ Terminé</span>';
  return '<div class="parcours-banner">' +
    '<span>' + info.parcours.icon + ' ' + info.parcours.title + ' · ' + (info.index + 1) + '/' + info.articles.length + '</span>' +
    '<div class="parcours-banner-dots">' + dots + '</div>' +
    nextBtn + '</div>';
}

// ===== NOTES SEARCH =====
function showNotesSearch() {
  var overlay = document.createElement('div');
  overlay.className = 'stats-overlay';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  overlay.innerHTML = '<div class="stats-panel" style="max-width:460px;">' +
    '<h3>Recherche dans les notes</h3>' +
    '<input type="text" id="notesSearchInput" placeholder="Mot-clé…" ' +
    'style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:8px;' +
    'background:var(--paper-warm);font-size:0.88rem;color:var(--ink);font-family:var(--body);' +
    'box-sizing:border-box;outline:none;" oninput="filterNotes(this.value)">' +
    '<div id="notesSearchResults" class="notes-search-results"></div>' +
    '<div style="text-align:center;"><button class="stats-close" onclick="this.closest(\'.stats-overlay\').remove()">Fermer</button></div>' +
  '</div>';
  document.body.appendChild(overlay);
  setTimeout(function() { document.getElementById('notesSearchInput').focus(); }, 100);
  filterNotes('');
}

function filterNotes(query) {
  var results = document.getElementById('notesSearchResults');
  if (!results) return;
  var q = query.toLowerCase().trim();
  var all = getAllEntries();
  var matches = [];
  
  Object.keys(articleNotes).forEach(function(id) {
    var note = articleNotes[id];
    if (!note || !note.trim()) return;
    var entry = all.find(function(e) { return e.id === id; });
    if (!entry) return;
    if (q && note.toLowerCase().indexOf(q) < 0 && entry.term.toLowerCase().indexOf(q) < 0) return;
    matches.push({ entry: entry, note: note });
  });
  
  if (matches.length === 0) {
    results.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--muted-light);font-size:0.8rem;">' +
      (q ? 'Aucun résultat pour « ' + q + ' »' : 'Aucune note enregistrée') + '</div>';
    return;
  }
  
  results.innerHTML = matches.map(function(m) {
    var excerpt = m.note.length > 120 ? m.note.slice(0, 120) + '…' : m.note;
    if (q) {
      var re = new RegExp('(' + q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
      excerpt = excerpt.replace(re, '<mark>$1</mark>');
    }
    return '<div class="notes-result" onclick="this.closest(\'.stats-overlay\').remove();navigateTo(\'' + m.entry.id + '\')">' +
      '<div class="notes-result-term">' + escapeHtml(m.entry.term) + '</div>' +
      '<div class="notes-result-excerpt">' + excerpt + '</div></div>';
  }).join('');
}

// ===== ONBOARDING =====
function showOnboarding() {
  if (lsGet('philo-onboarded', '') === 'true') return;
  var overlay = document.createElement('div');
  overlay.className = 'onboarding-overlay';
  overlay.id = 'onboardingOverlay';
  overlay.innerHTML = '<div class="onboarding-panel">' +
    '<div class="onboarding-slide active" data-slide="0">' +
      '<div class="onboarding-icon">φ</div>' +
      '<div class="onboarding-title">Bienvenue dans le<br>Dictionnaire de Philosophie</div>' +
      '<div class="onboarding-text">Explorez plus de 140 articles sur les grands concepts de la pensée occidentale, de l\'Antiquité à nos jours.</div>' +
      '<div class="onboarding-dots"><div class="onboarding-dot active"></div><div class="onboarding-dot"></div><div class="onboarding-dot"></div></div>' +
      '<button class="onboarding-btn" onclick="nextOnboardingSlide(1)">Suivant</button>' +
      '<button class="onboarding-skip" onclick="closeOnboarding()">Passer</button>' +
    '</div>' +
    '<div class="onboarding-slide" data-slide="1">' +
      '<div class="onboarding-icon">📚</div>' +
      '<div class="onboarding-title">Importez les articles</div>' +
      '<div class="onboarding-text">Cliquez sur « Importer depuis Wikilivres » pour télécharger le dictionnaire complet. Tout est stocké localement, aucun compte nécessaire.</div>' +
      '<div class="onboarding-dots"><div class="onboarding-dot"></div><div class="onboarding-dot active"></div><div class="onboarding-dot"></div></div>' +
      '<button class="onboarding-btn" onclick="nextOnboardingSlide(2)">Suivant</button>' +
      '<button class="onboarding-skip" onclick="closeOnboarding()">Passer</button>' +
    '</div>' +
    '<div class="onboarding-slide" data-slide="2">' +
      '<div class="onboarding-icon">⚙️</div>' +
      '<div class="onboarding-title">Personnalisez votre lecture</div>' +
      '<div class="onboarding-text">Thème sombre ou sépia, choix de police, taille du texte, lettrine… Accédez aux paramètres via l\'icône engrenage en haut à droite.</div>' +
      '<div class="onboarding-dots"><div class="onboarding-dot"></div><div class="onboarding-dot"></div><div class="onboarding-dot active"></div></div>' +
      '<button class="onboarding-btn" onclick="closeOnboarding()">Commencer</button>' +
    '</div>' +
  '</div>';
  document.body.appendChild(overlay);
}

function nextOnboardingSlide(n) {
  document.querySelectorAll('.onboarding-slide').forEach(function(s) { s.classList.remove('active'); });
  var slide = document.querySelector('[data-slide="' + n + '"]');
  if (slide) slide.classList.add('active');
}

function closeOnboarding() {
  var overlay = document.getElementById('onboardingOverlay');
  if (overlay) overlay.remove();
  PhiloDB.set('philo-onboarded', 'true');
  try { localStorage.setItem('philo-onboarded', 'true'); } catch(e) {}
}

// ===== SECURITY HELPERS =====
function sanitizeHtml(html) {
  // Remove <script> tags and their content
  html = html.replace(/<script[\s\S]*?<\/script>/gi, '');
  // Remove ALL on* event handlers from imported content
  html = html.replace(/\s+on\w+\s*=\s*["'][^"']*["']/gi, '');
  html = html.replace(/\s+on\w+\s*=\s*[^\s>]+/gi, '');
  // Remove javascript: URIs
  html = html.replace(/href\s*=\s*["']\s*javascript:[^"']*["']/gi, 'href="#"');
  // Remove data: URIs in src (except images)
  html = html.replace(/src\s*=\s*["']\s*data:(?!image\/)[^"']*["']/gi, '');
  // Remove <iframe>, <object>, <embed>, <form>, <input type=hidden>
  html = html.replace(/<(iframe|object|embed|form|meta|link|base)[\s\S]*?(\/?>|<\/\1>)/gi, '');
  return html;
}

function safeId(id) {
  // Ensure ID is safe for use in onclick="navigateTo('...')"
  if (typeof id !== 'string') return '';
  return id.replace(/['"\\<>&]/g, '');
}

function safeParse(str, fallback) {
  try { return JSON.parse(str); }
  catch(e) { return fallback; }
}

function validateEntry(e) {
  // Validate entry structure from import
  if (!e || typeof e !== 'object' || Array.isArray(e)) return null;
  // Block prototype pollution keys
  var dangerousKeys = ['__proto__', 'constructor', 'prototype', '__defineGetter__', '__defineSetter__'];
  for (var dk of dangerousKeys) { if (dk in e) delete e[dk]; }
  // Required fields
  if (typeof e.id !== 'string' || typeof e.term !== 'string') return null;
  // Sanitize content fields (limit to 500KB each)
  if (e.content) e.content = sanitizeHtml(String(e.content).slice(0, 500000));
  if (e.definition) e.definition = sanitizeHtml(String(e.definition));
  // Ensure safe types
  e.id = safeId(e.id);
  e.term = String(e.term).slice(0, 200);
  e.category = String(e.category || 'Philosophie').slice(0, 200);
  e.letter = String(e.letter || e.term.charAt(0).toUpperCase()).slice(0, 1);
  e.tags = Array.isArray(e.tags) ? e.tags.map(function(t) { return String(t).slice(0, 100); }) : [];
  e.refs = Array.isArray(e.refs) ? e.refs.map(function(r) { return String(r).slice(0, 2000); }) : [];
  e.related = Array.isArray(e.related) ? e.related.map(function(r) { return safeId(String(r)); }) : [];
  return e;
}

// ===== GLOSSAIRE TRANSVERSAL =====
var glossaryTerms = null; // lazy-built

var PHILO_GLOSSARY = {
  'a priori': "Connaissance indépendante de l'expérience, antérieure à toute observation empirique.",
  'a posteriori': "Connaissance dérivée de l'expérience sensible et de l'observation.",
  'absolu': "Ce qui est sans condition, sans limite, indépendant de toute relation.",
  'abstraction': "Opération de l'esprit qui isole un élément d'un ensemble pour le considérer à part.",
  'accident': "Propriété non essentielle d'une chose, qui peut changer sans altérer sa nature.",
  'aliénation': "Processus par lequel un sujet devient étranger à lui-même ou à son essence.",
  'analogie': "Rapport de ressemblance entre des réalités fondamentalement différentes.",
  'antinomie': "Conflit entre deux propositions également démontrables et contradictoires.",
  'aporie': "Difficulté logique insoluble, impasse dans un raisonnement.",
  'argument': "Suite de propositions visant à établir la vérité ou la fausseté d'une thèse.",
  'ataraxie': "Absence de trouble de l'âme, tranquillité parfaite visée par les stoïciens et épicuriens.",
  'autonomie': "Capacité d'un sujet à se donner sa propre loi morale.",
  'axiome': "Proposition admise sans démonstration comme fondement d'un système.",
  'catégorie': "Concept fondamental servant à classer les modes d'être ou de penser.",
  'causalité': "Relation nécessaire entre une cause et son effet.",
  'concept': "Représentation mentale abstraite et générale d'un objet de pensée.",
  'conscience': "Capacité de se représenter soi-même et le monde, savoir intérieur immédiat.",
  'contingence': "Caractère de ce qui pourrait ne pas être ou être autrement.",
  'contradiction': "Opposition entre deux propositions dont l'une est la négation de l'autre.",
  'déduction': "Raisonnement allant du général au particulier, du principe à la conséquence.",
  'déterminisme': "Doctrine selon laquelle tout événement est l'effet nécessaire de causes antérieures.",
  'dialectique': "Méthode de raisonnement procédant par oppositions et dépassements successifs.",
  'dualisme': "Doctrine posant deux principes irréductibles (matière/esprit, bien/mal).",
  'empirisme': "Doctrine fondant toute connaissance sur l'expérience sensible.",
  'entéléchie': "Réalisation complète de la puissance d'un être, son accomplissement.",
  'épistémologie': "Étude critique des sciences, de leurs méthodes et de leurs fondements.",
  'essence': "Ce qui fait qu'une chose est ce qu'elle est, sa nature fondamentale.",
  'éthique': "Réflexion philosophique sur la morale, les valeurs et la conduite humaine.",
  'eudémonisme': "Doctrine morale fondant le bien sur la recherche du bonheur.",
  'existence': "Le fait d'être, la réalité concrète d'un être par opposition à son essence.",
  'finalité': "Caractère de ce qui tend vers un but, une fin.",
  'herméneutique': "Art et science de l'interprétation des textes et des signes.",
  'heuristique': "Méthode de découverte et d'invention procédant par essais et hypothèses.",
  'hypothèse': "Proposition admise provisoirement comme point de départ d'un raisonnement.",
  'idéalisme': "Doctrine ramenant l'être à la pensée ou à l'esprit.",
  'immanence': "Caractère de ce qui est contenu dans la nature d'un être sans le dépasser.",
  'impératif': "Commandement moral. Chez Kant : catégorique (inconditionnel) ou hypothétique.",
  'induction': "Raisonnement allant du particulier au général, des faits à la loi.",
  'matérialisme': "Doctrine considérant la matière comme seule réalité fondamentale.",
  'métaphysique': "Étude de l'être en tant qu'être, au-delà de la physique.",
  'monisme': "Doctrine ne reconnaissant qu'un seul principe fondamental de la réalité.",
  'nihilisme': "Doctrine niant toute valeur, tout fondement, toute vérité absolue.",
  'noumène': "Chez Kant : la chose en soi, inaccessible à la connaissance sensible.",
  'ontologie': "Étude de l'être en général et de ses propriétés fondamentales.",
  'paradigme': "Modèle théorique dominant organisant la vision du monde d'une époque.",
  'phénoménologie': "Étude des phénomènes tels qu'ils apparaissent à la conscience.",
  'phénomène': "Ce qui apparaît à la conscience, l'objet tel qu'il se manifeste.",
  'positivisme': "Doctrine limitant la connaissance aux faits observables et aux lois scientifiques.",
  'pragmatisme': "Doctrine jugeant la vérité des idées à leurs conséquences pratiques.",
  'praxis': "Action humaine transformatrice, par opposition à la théorie pure.",
  'rationalisme': "Doctrine fondant la connaissance sur la raison plutôt que sur l'expérience.",
  'relativisme': "Doctrine selon laquelle toute connaissance ou valeur est relative à un contexte.",
  'scepticisme': "Attitude philosophique de doute systématique envers toute certitude.",
  'solipsisme': "Thèse selon laquelle seul le sujet pensant peut être assuré d'exister.",
  'sophisme': "Raisonnement qui a l'apparence de la validité mais qui est fallacieux.",
  'substance': "Ce qui existe par soi-même et sert de support aux propriétés.",
  'syllogisme': "Raisonnement déductif en trois propositions : majeure, mineure, conclusion.",
  'synthèse': "Opération unissant des éléments divers en un tout cohérent.",
  'téléologie': "Étude des fins et des causes finales dans la nature ou l'histoire.",
  'transcendance': "Caractère de ce qui dépasse un domaine donné, qui est au-delà.",
  'universaux': "Concepts généraux (genres, espèces) et la question de leur réalité.",
  'utilitarisme': "Doctrine morale fondant le bien sur l'utilité et le bonheur du plus grand nombre."
};

function buildGlossary() {
  if (glossaryTerms) return glossaryTerms;
  var allEntries = getAllEntries();
  var termCounts = {};
  
  // Build combined text once (performance: avoid re-scanning per term)
  var combinedTexts = allEntries.map(function(e) {
    return ((e.content || '').replace(/<[^>]+>/g, '') + ' ' + (e.definition || '')).toLowerCase();
  });
  var fullText = combinedTexts.join(' ');
  
  // Count term occurrences
  Object.keys(PHILO_GLOSSARY).forEach(function(term) {
    var escaped = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    try {
      var re = new RegExp('\\b' + escaped + '\\b', 'gi');
      var matches = fullText.match(re);
      var count = matches ? matches.length : 0;
      if (count >= 2) termCounts[term] = count;
    } catch(e) { /* skip invalid regex */ }
  });
  
  // Sort by frequency
  glossaryTerms = Object.keys(termCounts).sort(function(a, b) {
    return termCounts[b] - termCounts[a];
  }).map(function(term) {
    return { term: term, def: PHILO_GLOSSARY[term], count: termCounts[term] };
  });
  
  return glossaryTerms;
}

function showGlossary() {
  var terms = buildGlossary();
  
  var overlay = document.createElement('div');
  overlay.className = 'stats-overlay';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  
  // Group by first letter
  var grouped = {};
  terms.forEach(function(t) {
    var letter = t.term[0].toUpperCase();
    if (!grouped[letter]) grouped[letter] = [];
    grouped[letter].push(t);
  });
  
  var html = '';
  Object.keys(grouped).sort().forEach(function(letter) {
    html += '<div class="glossary-letter">' + letter + '</div>';
    grouped[letter].forEach(function(t) {
      html += '<div class="glossary-item">' +
        '<div class="glossary-term">' + escapeHtml(t.term) +
        '<span class="glossary-count">' + t.count + '×</span></div>' +
        '<div class="glossary-def">' + escapeHtml(t.def) + '</div></div>';
    });
  });
  
  overlay.innerHTML = '<div class="stats-panel" style="max-width:520px;max-height:80vh;overflow-y:auto;">' +
    '<h3>Glossaire philosophique</h3>' +
    '<div style="font-family:var(--mono);font-size:0.5rem;letter-spacing:0.06em;text-transform:uppercase;color:var(--muted-light);margin-bottom:1rem;">' + terms.length + ' termes détectés dans vos articles</div>' +
    '<input type="text" class="glossary-search" id="glossaryFilter" placeholder="Filtrer les termes…" oninput="filterGlossary(this.value)">' +
    '<div id="glossaryContent">' + html + '</div>' +
    '<div style="text-align:center;margin-top:1rem;"><button class="stats-close" onclick="this.closest(\'.stats-overlay\').remove()">Fermer</button></div>' +
  '</div>';
  document.body.appendChild(overlay);
}

function filterGlossary(query) {
  var q = query.toLowerCase().trim();
  document.querySelectorAll('.glossary-item').forEach(function(el) {
    var term = el.querySelector('.glossary-term').textContent.toLowerCase();
    var def = el.querySelector('.glossary-def').textContent.toLowerCase();
    el.style.display = (!q || term.includes(q) || def.includes(q)) ? '' : 'none';
  });
  document.querySelectorAll('.glossary-letter').forEach(function(el) {
    var next = el.nextElementSibling;
    var hasVisible = false;
    while (next && !next.classList.contains('glossary-letter')) {
      if (next.style.display !== 'none') hasVisible = true;
      next = next.nextElementSibling;
    }
    el.style.display = hasVisible ? '' : 'none';
  });
}

// ===== TTS (Text-to-Speech) =====
var ttsUtterance = null;
var ttsPaused = false;
var ttsRate = 1.0;
var ttsActive = false;

function getTTSVoice() {
  if (!('speechSynthesis' in window)) return null;
  var voices = speechSynthesis.getVoices();
  // Prefer French voices
  var fr = voices.filter(function(v) { return v.lang && v.lang.startsWith('fr'); });
  if (fr.length > 0) return fr[0];
  return voices[0] || null;
}

function startTTS() {
  if (!('speechSynthesis' in window)) {
    alert('La synthèse vocale n\'est pas supportée par votre navigateur.');
    return;
  }
  
  if (ttsActive && !ttsPaused) {
    pauseTTS();
    return;
  }
  if (ttsPaused) {
    resumeTTS();
    return;
  }
  
  // Get article text
  var bodyEl = document.querySelector('.article-body');
  if (!bodyEl) return;
  var text = bodyEl.innerText || bodyEl.textContent || '';
  if (!text.trim()) return;
  
  speechSynthesis.cancel();
  ttsUtterance = new SpeechSynthesisUtterance(text);
  ttsUtterance.lang = 'fr-FR';
  ttsUtterance.rate = ttsRate;
  var voice = getTTSVoice();
  if (voice) ttsUtterance.voice = voice;
  
  ttsUtterance.onend = function() { stopTTS(); };
  ttsUtterance.onerror = function() { stopTTS(); };
  
  speechSynthesis.speak(ttsUtterance);
  ttsActive = true;
  ttsPaused = false;
  updateTTSUI();
}

function pauseTTS() {
  speechSynthesis.pause();
  ttsPaused = true;
  updateTTSUI();
}

function resumeTTS() {
  speechSynthesis.resume();
  ttsPaused = false;
  updateTTSUI();
}

function stopTTS() {
  speechSynthesis.cancel();
  ttsActive = false;
  ttsPaused = false;
  ttsUtterance = null;
  updateTTSUI();
}

function setTTSRate(rate) {
  ttsRate = parseFloat(rate);
  var label = document.getElementById('ttsRateLabel');
  if (label) label.textContent = ttsRate.toFixed(1) + '×';
  // If playing, restart with new rate
  if (ttsActive) {
    stopTTS();
    setTimeout(startTTS, 100);
  }
}

function updateTTSUI() {
  var bar = document.getElementById('ttsBar');
  if (!bar) return;
  var playBtn = bar.querySelector('.tts-play');
  var stopBtn = bar.querySelector('.tts-stop');
  if (playBtn) {
    if (ttsActive && !ttsPaused) {
      playBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
      playBtn.title = 'Pause';
    } else {
      playBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
      playBtn.title = 'Lire';
    }
  }
  if (stopBtn) stopBtn.style.opacity = ttsActive ? '1' : '0.3';
}

function buildTTSBar() {
  if (!('speechSynthesis' in window)) return '';
  return '<div class="tts-bar" id="ttsBar">' +
    '<button class="tts-btn tts-play" onclick="startTTS()" title="Lire">' +
      '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>' +
    '</button>' +
    '<button class="tts-btn tts-stop" onclick="stopTTS()" title="Arrêter" style="opacity:0.3;">' +
      '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>' +
    '</button>' +
    '<div class="tts-speed">' +
      '<input type="range" min="0.5" max="2" step="0.1" value="' + ttsRate + '" oninput="setTTSRate(this.value)" class="tts-range">' +
      '<span class="tts-rate-label" id="ttsRateLabel">' + ttsRate.toFixed(1) + '×</span>' +
    '</div>' +
    '<span class="tts-label">Lecture audio</span>' +
  '</div>';
}

// ===== READING STREAK =====
function getReadingStreak() {
  // Build set of days with reading activity
  var days = new Set();
  readHistory.forEach(function(h) {
    var d = new Date(h.time);
    days.add(d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'));
  });
  
  // Count consecutive days ending today
  var streak = 0;
  var d = new Date();
  for (var i = 0; i < 365; i++) {
    var key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    if (days.has(key)) {
      streak++;
      d.setDate(d.getDate() - 1);
    } else {
      // Allow 1 day gap for today if nothing read yet
      if (i === 0) { d.setDate(d.getDate() - 1); continue; }
      break;
    }
  }
  return streak;
}

function getActivityMap() {
  // Last 28 days activity heatmap
  var map = [];
  var now = new Date();
  for (var i = 27; i >= 0; i--) {
    var d = new Date(now);
    d.setDate(d.getDate() - i);
    var key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    var count = 0;
    readHistory.forEach(function(h) {
      var hd = new Date(h.time);
      var hk = hd.getFullYear() + '-' + String(hd.getMonth()+1).padStart(2,'0') + '-' + String(hd.getDate()).padStart(2,'0');
      if (hk === key) count++;
    });
    map.push({ day: d.getDate(), dow: d.getDay(), count: count, label: d.toLocaleDateString('fr-FR', {weekday:'short'}) });
  }
  return map;
}

function getSmartSuggestions(allEntries) {
  // Suggest based on: unread from read categories, related to recently read
  var suggestions = [];
  var recentCats = new Set();
  var recentTags = new Set();
  
  readHistory.slice(0, 10).forEach(function(h) {
    var e = allEntries.find(function(a) { return a.id === h.id; });
    if (e) {
      e.category.split(' · ').forEach(function(c) { recentCats.add(c); });
      e.tags.slice(0, 3).forEach(function(t) { recentTags.add(t.toLowerCase()); });
    }
  });
  
  // Score each unread article
  var scored = allEntries.filter(function(e) { return !readArticles.has(e.id); }).map(function(e) {
    var score = 0;
    e.category.split(' · ').forEach(function(c) { if (recentCats.has(c)) score += 3; });
    e.tags.forEach(function(t) { if (recentTags.has(t.toLowerCase())) score += 2; });
    // Boost if related to recently read
    var autoRel = detectRelated(e);
    readHistory.slice(0, 5).forEach(function(h) {
      if (autoRel.indexOf(h.id) >= 0) score += 5;
    });
    return { entry: e, score: score };
  }).filter(function(s) { return s.score > 0; });
  
  scored.sort(function(a, b) { return b.score - a.score; });
  return scored.slice(0, 4).map(function(s) { return s.entry; });
}


// ===== ANDROID WIDGET BRIDGE =====
function updateAndroidWidget() {
  if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform && Capacitor.isNativePlatform()) {
    var aotd = getArticleOfDay();
    if (aotd) {
      try {
        Capacitor.Plugins?.Preferences?.set({ key: 'aotd_title', value: aotd.term });
        var excerpt = (aotd.definition || '').replace(/<[^>]+>/g, '').slice(0, 200);
        Capacitor.Plugins?.Preferences?.set({ key: 'aotd_excerpt', value: excerpt });
      } catch(e) {}
    }
  }
}

// ===== MINI CONNECTION GRAPH =====
function buildMiniGraph(entry) {
  var allEntries = getAllEntries();
  var relatedIds = (entry.related || []).slice();
  var autoRelated = detectRelated(entry);
  autoRelated.forEach(function(rid) { if (relatedIds.indexOf(rid) < 0) relatedIds.push(rid); });
  relatedIds = relatedIds.slice(0, 8);
  
  var nodes = relatedIds.map(function(rid) { return allEntries.find(function(e) { return e.id === rid; }); }).filter(Boolean);
  if (nodes.length < 2) return '';
  
  var w = 460, h = 220;
  var cx = w / 2, cy = h / 2;
  var rx = w * 0.38, ry = h * 0.36;
  
  var svg = '<div class="mini-graph-wrap">' +
    '<div class="mini-graph-title">Réseau de connexions</div>' +
    '<svg class="mini-graph-svg" viewBox="0 0 ' + w + ' ' + h + '">';
  
  var nodePositions = [];
  nodes.forEach(function(n, i) {
    var angle = (2 * Math.PI * i / nodes.length) - Math.PI / 2;
    nodePositions.push({
      x: cx + rx * Math.cos(angle),
      y: cy + ry * Math.sin(angle),
      entry: n
    });
  });
  
  // Edges center → nodes
  nodePositions.forEach(function(np) {
    svg += '<line class="mini-graph-edge" x1="' + cx + '" y1="' + cy + '" x2="' + np.x + '" y2="' + np.y + '"/>';
  });
  
  // Cross-edges between related nodes
  for (var i = 0; i < nodes.length; i++) {
    for (var j = i + 1; j < nodes.length; j++) {
      var niContent = normalizeText((nodes[i].content || '') + ' ' + nodes[i].tags.join(' '));
      var njTerm = normalizeText(nodes[j].term);
      if (njTerm.length > 3 && niContent.indexOf(njTerm) >= 0) {
        svg += '<line class="mini-graph-edge" x1="' + nodePositions[i].x + '" y1="' + nodePositions[i].y + 
          '" x2="' + nodePositions[j].x + '" y2="' + nodePositions[j].y + '" style="opacity:0.15"/>';
      }
    }
  }
  
  // Outer nodes
  nodePositions.forEach(function(np) {
    var termShort = np.entry.term.length > 16 ? np.entry.term.slice(0, 14) + '\u2026' : np.entry.term;
    svg += '<g class="mini-graph-node" onclick="navigateTo(\'' + safeId(np.entry.id) + '\')">' +
      '<circle cx="' + np.x + '" cy="' + np.y + '" r="5" fill="var(--border)" stroke="var(--muted-light)" stroke-width="1"/>' +
      '<text class="mini-graph-label" x="' + np.x + '" y="' + (np.y < cy ? np.y - 10 : np.y + 16) + 
      '" text-anchor="middle">' + escapeHtml(termShort) + '</text></g>';
  });
  
  // Center node
  var centerShort = entry.term.length > 18 ? entry.term.slice(0, 16) + '\u2026' : entry.term;
  svg += '<circle cx="' + cx + '" cy="' + cy + '" r="8" fill="var(--accent)" stroke="var(--paper)" stroke-width="2"/>' +
    '<text class="mini-graph-label-center" x="' + cx + '" y="' + (cy - 14) + '" text-anchor="middle">' + escapeHtml(centerShort) + '</text>';
  
  svg += '</svg></div>';
  return svg;
}

// ===== WYSIWYG EDITOR =====
var editorMode = 'wysiwyg';

function htmlToWikitext(html) {
  var text = html;
  text = text.replace(/<div><br\s*\/?><\/div>/gi, '\n');
  text = text.replace(/<div>/gi, '\n').replace(/<\/div>/gi, '');
  text = text.replace(/<br\s*\/?>/gi, '\n');
  text = text.replace(/<h3[^>]*>(.*?)<\/h3>/gi, '\n== $1 ==\n');
  text = text.replace(/<h4[^>]*>(.*?)<\/h4>/gi, '\n=== $1 ===\n');
  text = text.replace(/<b>(.*?)<\/b>/gi, "\'\'\'$1\'\'\'");
  text = text.replace(/<strong>(.*?)<\/strong>/gi, "\'\'\'$1\'\'\'");
  text = text.replace(/<i>(.*?)<\/i>/gi, "\'\'$1\'\'");
  text = text.replace(/<em>(.*?)<\/em>/gi, "\'\'$1\'\'");
  text = text.replace(/<blockquote[^>]*>([\s\S]*?)<\/blockquote>/gi, function(m, c) {
    return c.replace(/<[^>]+>/g, '').split('\n').map(function(l) { var t = l.trim(); return t ? ': ' + t : ''; }).filter(Boolean).join('\n');
  });
  text = text.replace(/<li[^>]*>(.*?)<\/li>/gi, '* $1');
  text = text.replace(/<\/?[ou]l[^>]*>/gi, '');
  text = text.replace(/<\/?p[^>]*>/gi, '\n');
  text = text.replace(/<[^>]+>/g, '');
  text = text.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&nbsp;/g, ' ');
  text = text.replace(/\n{3,}/g, '\n\n').trim();
  return text;
}

function wikitextToHtml(wikitext) {
  if (!wikitext || !wikitext.trim()) return '';
  var parsed = parseMediaWiki(wikitext);
  return parsed.html;
}

function switchEditorMode(mode) {
  var wysiwygArea = document.getElementById('wysiwygArea');
  var textArea = document.getElementById('editorContent');
  if (!wysiwygArea || !textArea) return;
  
  document.querySelectorAll('.editor-mode-btn').forEach(function(b) { b.classList.remove('active'); });
  var activeBtn = document.querySelector('.editor-mode-btn[data-mode="' + mode + '"]');
  if (activeBtn) activeBtn.classList.add('active');
  
  if (mode === 'wysiwyg') {
    var wiki = textArea.value;
    if (wiki) wysiwygArea.innerHTML = wikitextToHtml(wiki);
    wysiwygArea.style.display = '';
    textArea.style.display = 'none';
    editorMode = 'wysiwyg';
  } else {
    if (editorMode === 'wysiwyg') {
      textArea.value = htmlToWikitext(wysiwygArea.innerHTML);
    }
    wysiwygArea.style.display = 'none';
    textArea.style.display = '';
    editorMode = 'wikitext';
  }
}

function wysiwygExec(cmd, value) {
  document.execCommand(cmd, false, value || null);
  var area = document.getElementById('wysiwygArea');
  if (area) area.focus();
}

function wysiwygInsertHeading(level) {
  document.execCommand('formatBlock', false, level === 2 ? 'h3' : 'h4');
  var area = document.getElementById('wysiwygArea');
  if (area) area.focus();
}

function wysiwygInsertQuote() {
  document.execCommand('formatBlock', false, 'blockquote');
  var area = document.getElementById('wysiwygArea');
  if (area) area.focus();
}

function getEditorWikitext() {
  if (editorMode === 'wysiwyg') {
    var area = document.getElementById('wysiwygArea');
    return area ? htmlToWikitext(area.innerHTML) : document.getElementById('editorContent').value;
  }
  return document.getElementById('editorContent').value;
}


// ===== ALPHA SLIDER (iPhone contacts style) =====
function initAlphaSlider(strip) {
  var tooltip = document.getElementById('alphaTooltip');
  var isSliding = false;
  var lastLetter = '';
  
  function getLetterAt(y) {
    var links = strip.querySelectorAll('a[data-letter]');
    for (var i = 0; i < links.length; i++) {
      var rect = links[i].getBoundingClientRect();
      if (y >= rect.top && y <= rect.bottom) return links[i].getAttribute('data-letter');
    }
    // If above/below, return nearest
    if (links.length > 0) {
      var first = links[0].getBoundingClientRect();
      if (y < first.top) return links[0].getAttribute('data-letter');
      var last = links[links.length - 1].getBoundingClientRect();
      if (y > last.bottom) return links[links.length - 1].getAttribute('data-letter');
    }
    return null;
  }
  
  function highlightLetter(letter) {
    strip.querySelectorAll('a').forEach(function(a) { a.classList.remove('alpha-active'); });
    var active = strip.querySelector('a[data-letter="' + letter + '"]');
    if (active) active.classList.add('alpha-active');
  }
  
  function showTooltip(letter, y) {
    if (!tooltip) return;
    tooltip.textContent = letter;
    tooltip.style.top = y + 'px';
    tooltip.classList.add('visible');
  }
  
  function hideTooltip() {
    if (tooltip) tooltip.classList.remove('visible');
    strip.querySelectorAll('a').forEach(function(a) { a.classList.remove('alpha-active'); });
  }
  
  function jumpTo(letter) {
    if (letter && letter !== lastLetter) {
      lastLetter = letter;
      mobileJumpToLetter(letter);
      highlightLetter(letter);
    }
  }
  
  strip.addEventListener('touchstart', function(e) {
    e.preventDefault();
    isSliding = true;
    var touch = e.touches[0];
    var letter = getLetterAt(touch.clientY);
    if (letter) {
      jumpTo(letter);
      showTooltip(letter, touch.clientY);
    }
  }, { passive: false });
  
  strip.addEventListener('touchmove', function(e) {
    if (!isSliding) return;
    e.preventDefault();
    var touch = e.touches[0];
    var letter = getLetterAt(touch.clientY);
    if (letter) {
      jumpTo(letter);
      showTooltip(letter, touch.clientY);
    }
  }, { passive: false });
  
  strip.addEventListener('touchend', function() {
    isSliding = false;
    lastLetter = '';
    hideTooltip();
  });
  
  // Click on individual letters
  strip.addEventListener('click', function(e) {
    var letter = e.target.getAttribute('data-letter');
    if (letter) mobileJumpToLetter(letter);
  });
}

// ===== CUSTOM TAGS =====
var customArticleTags = safeParse(lsGet('philo-custom-tags', '{}'), {});
var allCustomTagNames = safeParse(lsGet('philo-all-custom-tags', '[]'), []);

function getCustomTags(id) {
  return customArticleTags[id] || [];
}

function saveCustomTags() {
  var json = JSON.stringify(customArticleTags);
  PhiloDB.set('philo-custom-tags', json);
  try { localStorage.setItem('philo-custom-tags', json); } catch(e) {}
  var names = JSON.stringify(allCustomTagNames);
  PhiloDB.set('philo-all-custom-tags', names);
  try { localStorage.setItem('philo-all-custom-tags', names); } catch(e) {}
}

function addCustomTag(id, tagName) {
  tagName = tagName.trim().toLowerCase().replace(/[<>"'&\\]/g, '');
  if (!tagName || tagName.length > 30) return;
  if (!customArticleTags[id]) customArticleTags[id] = [];
  if (customArticleTags[id].indexOf(tagName) >= 0) return;
  customArticleTags[id].push(tagName);
  if (allCustomTagNames.indexOf(tagName) < 0) allCustomTagNames.push(tagName);
  saveCustomTags();
  showArticle(id);
}

function removeCustomTag(id, tagName) {
  if (!customArticleTags[id]) return;
  customArticleTags[id] = customArticleTags[id].filter(function(t) { return t !== tagName; });
  if (customArticleTags[id].length === 0) delete customArticleTags[id];
  saveCustomTags();
  showArticle(id);
}

function promptAddCustomTag(id) {
  // Show inline prompt with suggestions
  var existingHtml = allCustomTagNames.length > 0
    ? '<div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.5rem;">' +
      allCustomTagNames.slice(0, 15).map(function(t) {
        return '<span class="custom-tag" onclick="addCustomTag(\'' + safeId(id) + '\',\'' + escapeAttr(t) + '\')">' + escapeHtml(t) + '</span>';
      }).join('') + '</div>'
    : '';
  
  var name = prompt('Nouvelle étiquette :');
  if (name) addCustomTag(id, name);
}

function buildCustomTagsHtml(id) {
  var tags = getCustomTags(id);
  var html = '<div class="custom-tags-wrap">';
  tags.forEach(function(tag) {
    html += '<span class="custom-tag">' + escapeHtml(tag) +
      ' <span class="custom-tag-remove" onclick="event.stopPropagation();removeCustomTag(\'' + safeId(id) + '\',\'' + escapeAttr(tag) + '\')">&times;</span></span>';
  });
  html += '<button class="custom-tag-add" onclick="promptAddCustomTag(\'' + safeId(id) + '\')" title="Ajouter une étiquette">+</button>';
  html += '</div>';
  return html;
}

// ===== EPUB EXPORT =====
function generateEPUB() {
  var overlay = document.createElement('div');
  overlay.className = 'stats-overlay';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  
  var all = getAllEntries();
  var bkmk = all.filter(function(e) { return bookmarks.indexOf(e.id) >= 0; });
  
  overlay.innerHTML = '<div class="stats-panel" style="max-width:440px;">' +
    '<h3>Exporter en EPUB</h3>' +
    '<div style="margin:1rem 0;">' +
      '<label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;padding:0.5rem;border:1px solid var(--border-light);border-radius:8px;margin-bottom:0.4rem;" onclick="document.getElementById(\'epubScope\').value=\'all\'">' +
        '<input type="radio" name="epubScope" value="all" checked style="accent-color:var(--accent);"> ' +
        '<span style="font-size:0.85rem;">Tous les articles (' + all.length + ')</span></label>' +
      (bkmk.length > 0 ? '<label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;padding:0.5rem;border:1px solid var(--border-light);border-radius:8px;margin-bottom:0.4rem;" onclick="document.getElementById(\'epubScope\').value=\'bookmarks\'">' +
        '<input type="radio" name="epubScope" value="bookmarks" style="accent-color:var(--accent);"> ' +
        '<span style="font-size:0.85rem;">Favoris uniquement (' + bkmk.length + ')</span></label>' : '') +
    '</div>' +
    '<input type="hidden" id="epubScope" value="all">' +
    '<div style="text-align:center;">' +
      '<button class="stats-close" style="background:var(--accent);color:var(--paper);border-color:var(--accent);" ' +
        'onclick="doEpubExport(this)">Générer l\'EPUB</button> ' +
      '<button class="stats-close" onclick="this.closest(\'.stats-overlay\').remove()">Annuler</button>' +
    '</div>' +
    '<div id="epubStatus" style="text-align:center;margin-top:0.75rem;font-size:0.78rem;color:var(--muted);"></div>' +
  '</div>';
  document.body.appendChild(overlay);
}

function doEpubExport(btn) {
  var scope = 'all';
  var radios = document.querySelectorAll('input[name="epubScope"]');
  radios.forEach(function(r) { if (r.checked) scope = r.value; });
  
  var statusEl = document.getElementById('epubStatus');
  btn.disabled = true;
  statusEl.textContent = 'Génération en cours…';
  
  var all = getAllEntries();
  var entries = scope === 'bookmarks' 
    ? all.filter(function(e) { return bookmarks.indexOf(e.id) >= 0; })
    : all;
  
  if (entries.length === 0) {
    statusEl.textContent = 'Aucun article à exporter.';
    btn.disabled = false;
    return;
  }
  
  // Sort alphabetically
  entries.sort(function(a, b) { return a.term.localeCompare(b.term, 'fr'); });
  
  // Build EPUB structure
  var uuid = 'urn:uuid:' + (crypto.randomUUID ? crypto.randomUUID() : 
    ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, function(c) {
      return (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16);
    }));
  var now = new Date().toISOString().replace(/\.\d+Z$/, 'Z');
  
  // Container XML
  var container = '<?xml version="1.0" encoding="UTF-8"?>\n' +
    '<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">\n' +
    '  <rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles>\n' +
    '</container>';
  
  // CSS
  var css = 'body { font-family: Georgia, serif; line-height: 1.7; margin: 1em; color: #2c2416; }\n' +
    'h1 { font-size: 1.6em; color: #8b2500; margin-bottom: 0.5em; border-bottom: 1px solid #e8e0d0; padding-bottom: 0.3em; }\n' +
    'h2 { font-size: 1.3em; color: #5a3a1a; margin-top: 1.5em; }\n' +
    'h3 { font-size: 1.1em; color: #5a3a1a; margin-top: 1.2em; }\n' +
    'p { margin: 0.8em 0; text-align: justify; }\n' +
    'blockquote { margin: 1em 0; padding: 0.8em 1em; background: #faf6f0; border-left: 3px solid #d4a843; font-style: italic; }\n' +
    '.category { font-size: 0.85em; color: #8b6914; margin-bottom: 1em; }\n' +
    '.refs { margin-top: 2em; padding-top: 1em; border-top: 1px solid #e8e0d0; font-size: 0.85em; }\n' +
    '.toc-entry { margin: 0.3em 0; }\n' +
    '.toc-entry a { color: #8b2500; text-decoration: none; }\n';
  
  // Build TOC page
  var tocHtml = '<?xml version="1.0" encoding="UTF-8"?>\n' +
    '<!DOCTYPE html>\n<html xmlns="http://www.w3.org/1999/xhtml">\n<head><title>Table des matières</title>' +
    '<link rel="stylesheet" type="text/css" href="style.css"/></head>\n<body>\n' +
    '<h1>Table des matières</h1>\n';
  
  // Group by letter
  var letterGroups = {};
  entries.forEach(function(e) {
    var l = e.letter || e.term.charAt(0).toUpperCase();
    if (!letterGroups[l]) letterGroups[l] = [];
    letterGroups[l].push(e);
  });
  
  Object.keys(letterGroups).sort().forEach(function(l) {
    tocHtml += '<h2>' + l + '</h2>\n';
    letterGroups[l].forEach(function(e) {
      tocHtml += '<div class="toc-entry"><a href="art_' + e.id.replace(/[^a-zA-Z0-9-]/g,'') + '.xhtml">' + escapeHtml(e.term) + '</a></div>\n';
    });
  });
  tocHtml += '</body></html>';
  
  // Build article pages
  var articleFiles = [];
  entries.forEach(function(e, i) {
    var epubSafeId = e.id.replace(/[^a-zA-Z0-9-]/g,'');
    var fname = 'art_' + epubSafeId + '.xhtml';
    
    // Clean HTML for XHTML compliance
    var body = (e.content || e.definition || '').replace(/<br>/g, '<br/>').replace(/<hr>/g, '<hr/>');
    // Remove onclick handlers
    body = body.replace(/\s*onclick="[^"]*"/g, '');
    // Remove spans with class but keep text
    body = body.replace(/<span class="lettrine">([^<]*)<\/span>/g, '$1');
    body = body.replace(/<span class="auto-link[^"]*">([^<]*)<\/span>/g, '$1');
    body = body.replace(/<a class="auto-link"[^>]*>([^<]*)<\/a>/g, '$1');
    
    // Refs
    var refsHtml = '';
    if (e.refs && e.refs.length > 0) {
      refsHtml = '<div class="refs"><h3>Références</h3><ul>' +
        e.refs.map(function(r) { return '<li>' + escapeHtml(r) + '</li>'; }).join('') +
        '</ul></div>';
    }
    
    var html = '<?xml version="1.0" encoding="UTF-8"?>\n' +
      '<!DOCTYPE html>\n<html xmlns="http://www.w3.org/1999/xhtml">\n<head>' +
      '<title>' + escapeHtml(e.term) + '</title>' +
      '<link rel="stylesheet" type="text/css" href="style.css"/></head>\n<body>\n' +
      '<h1>' + escapeHtml(e.term) + '</h1>\n' +
      '<div class="category">' + escapeHtml(e.category) + '</div>\n' +
      body + '\n' + refsHtml +
      '</body></html>';
    
    articleFiles.push({ name: fname, content: html, id: epubSafeId, term: e.term });
  });
  
  // OPF manifest
  var opf = '<?xml version="1.0" encoding="UTF-8"?>\n' +
    '<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookId" version="3.0">\n' +
    '  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">\n' +
    '    <dc:identifier id="BookId">' + uuid + '</dc:identifier>\n' +
    '    <dc:title>Dictionnaire de Philosophie</dc:title>\n' +
    '    <dc:language>fr</dc:language>\n' +
    '    <dc:creator>Wikilivres</dc:creator>\n' +
    '    <meta property="dcterms:modified">' + now + '</meta>\n' +
    '  </metadata>\n' +
    '  <manifest>\n' +
    '    <item id="style" href="style.css" media-type="text/css"/>\n' +
    '    <item id="toc" href="toc.xhtml" media-type="application/xhtml+xml"/>\n' +
    '    <item id="nav" href="nav.xhtml" media-type="application/xhtml+xml" properties="nav"/>\n';
  
  articleFiles.forEach(function(f) {
    opf += '    <item id="' + f.id + '" href="' + f.name + '" media-type="application/xhtml+xml"/>\n';
  });
  
  opf += '  </manifest>\n  <spine>\n    <itemref idref="toc"/>\n';
  articleFiles.forEach(function(f) { opf += '    <itemref idref="' + f.id + '"/>\n'; });
  opf += '  </spine>\n</package>';
  
  // NAV document (EPUB 3)
  var nav = '<?xml version="1.0" encoding="UTF-8"?>\n' +
    '<!DOCTYPE html>\n<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">\n' +
    '<head><title>Navigation</title></head>\n<body>\n' +
    '<nav epub:type="toc" id="toc">\n<h1>Table des matières</h1>\n<ol>\n' +
    '<li><a href="toc.xhtml">Sommaire</a></li>\n';
  articleFiles.forEach(function(f) {
    nav += '<li><a href="' + f.name + '">' + escapeHtml(f.term) + '</a></li>\n';
  });
  nav += '</ol>\n</nav>\n</body></html>';
  
  // Build ZIP (minimal EPUB = ZIP with specific structure)
  // buildEpubZip is async — use .catch to surface errors
  buildEpubZip(container, opf, css, tocHtml, nav, articleFiles, statusEl, btn)
    .catch(function(err) {
      statusEl.textContent = 'Erreur : ' + (err.message || err);
      btn.disabled = false;
    });
}

async function buildEpubZip(container, opf, css, tocHtml, nav, articleFiles, statusEl, btn) {
  // We need to build a ZIP file manually or use JSZip
  // Try to load JSZip dynamically
  if (typeof JSZip === 'undefined') {
    statusEl.textContent = 'Chargement de JSZip…';
    try {
      await new Promise(function(resolve, reject) {
        var s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        s.crossOrigin = 'anonymous';
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    } catch(e) {
      // Fallback: generate without JSZip (plain HTML)
      statusEl.textContent = 'JSZip indisponible. Export HTML à la place…';
      exportAsHTML(articleFiles, statusEl, btn);
      return;
    }
  }
  
  var zip = new JSZip();
  
  // mimetype must be first and uncompressed
  zip.file('mimetype', 'application/epub+zip', { compression: 'STORE' });
  zip.file('META-INF/container.xml', container);
  zip.file('OEBPS/content.opf', opf);
  zip.file('OEBPS/style.css', css);
  zip.file('OEBPS/toc.xhtml', tocHtml);
  zip.file('OEBPS/nav.xhtml', nav);
  
  articleFiles.forEach(function(f) {
    zip.file('OEBPS/' + f.name, f.content);
  });
  
  statusEl.textContent = 'Compression…';
  
  var blob = await zip.generateAsync({ type: 'blob', mimeType: 'application/epub+zip' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'dictionnaire-philosophie.epub';
  a.click();
  URL.revokeObjectURL(url);
  
  statusEl.textContent = '✓ EPUB téléchargé (' + articleFiles.length + ' articles)';
  btn.disabled = false;
}

function exportAsHTML(articleFiles, statusEl, btn) {
  var html = '<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8">' +
    '<title>Dictionnaire de Philosophie</title>' +
    '<style>body{font-family:Georgia,serif;max-width:700px;margin:0 auto;padding:2rem;color:#2c2416;line-height:1.7;}' +
    'h1{color:#8b2500;border-bottom:2px solid #d4a843;padding-bottom:0.3em;}' +
    'h2{color:#5a3a1a;margin-top:2em;border-bottom:1px solid #e8e0d0;padding-bottom:0.2em;}' +
    'blockquote{border-left:3px solid #d4a843;padding:0.5em 1em;background:#faf6f0;}</style></head><body>';
  html += '<h1>Dictionnaire de Philosophie</h1>';
  articleFiles.forEach(function(f) {
    html += '<h2 id="' + escapeAttr(f.id) + '">' + escapeHtml(f.term) + '</h2>';
    html += f.content.replace(/<\?xml[^?]*\?>/, '').replace(/<(!DOCTYPE|html|head|title|link|body|\/?html|\/?head|\/?body)[^>]*>/gi, '');
  });
  html += '</body></html>';
  
  var blob = new Blob([html], { type: 'text/html' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'dictionnaire-philosophie.html';
  a.click();
  URL.revokeObjectURL(url);
  
  statusEl.textContent = '✓ HTML téléchargé (EPUB indisponible hors ligne)';
  btn.disabled = false;
}

// ===== CHECK FOR WIKI UPDATES =====
var updateCheckRunning = false;
var pendingUpdatesCount = parseInt(lsGet("philo-pending-updates", "0")) || 0;

async function silentUpdateCheck() {
  if (updateCheckRunning) return;
  if (userEntries.length === 0) return;
  
  // Only check once per 24h
  var lastCheck = lsGet('philo-last-update-check', '');
  if (lastCheck) {
    var elapsed = Date.now() - new Date(lastCheck).getTime();
    if (elapsed < 24 * 3600 * 1000) return;
  }
  
  updateCheckRunning = true;
  console.log('[UpdateCheck] Starting silent check...');
  
  var wikiEntries = userEntries.filter(function(e) {
    return e._userEntry && (e._wikiTitle || e._wikiSource);
  });
  if (wikiEntries.length === 0) { updateCheckRunning = false; return; }
  
  var titleMap = {};
  wikiEntries.forEach(function(e) {
    titleMap[e._wikiTitle || ('Dictionnaire de philosophie/' + e.term)] = e;
  });
  
  var titles = Object.keys(titleMap);
  var outdatedCount = 0;
  var batchSize = 50;
  
  try {
    for (var b = 0; b < titles.length; b += batchSize) {
      var batch = titles.slice(b, b + batchSize);
      var data = await jsonp(
        'https://fr.wikibooks.org/w/api.php?action=query'
        + '&titles=' + encodeURIComponent(batch.join('|'))
        + '&prop=revisions&rvprop=ids'
        + '&format=json&formatversion=2'
      );
      
      if (data.query && data.query.pages) {
        data.query.pages.forEach(function(page) {
          if (page.missing || !page.revisions || !page.revisions[0]) return;
          var rev = page.revisions[0];
          var entry = titleMap[page.title];
          if (!entry) {
            Object.keys(titleMap).forEach(function(k) {
              if (k.toLowerCase() === page.title.toLowerCase()) entry = titleMap[k];
            });
          }
          if (!entry) return;
          if (entry._wikiRevId && rev.revid && rev.revid !== entry._wikiRevId) {
            outdatedCount++;
          } else if (!entry._wikiRevId) {
            var age = entry._importDate ? (Date.now() - new Date(entry._importDate).getTime()) : Infinity;
            if (age > 30 * 86400000) outdatedCount++;
          }
        });
      }
      await new Promise(function(r) { setTimeout(r, 100); });
    }
  } catch(e) {
    console.log('[UpdateCheck] Error:', e.message);
  }
  
  // Store result
  pendingUpdatesCount = outdatedCount;
  PhiloDB.set('philo-pending-updates', String(outdatedCount));
  try { localStorage.setItem('philo-pending-updates', String(outdatedCount)); } catch(e) {}
  PhiloDB.set('philo-last-update-check', new Date().toISOString());
  try { localStorage.setItem('philo-last-update-check', new Date().toISOString()); } catch(e) {}
  
  updateCheckRunning = false;
  console.log('[UpdateCheck] Done. ' + outdatedCount + ' updates available.');
  
  // Refresh welcome page if currently shown
  if (!currentArticle && outdatedCount > 0) {
    showWelcome();
  }
  
  // Android notification
  if (outdatedCount > 0) {
    sendUpdateNotification(outdatedCount);
  }
}

function sendUpdateNotification(count) {
  // Browser Notification API
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification('Dictionnaire de Philosophie', {
      body: count + ' article' + (count > 1 ? 's ont' : ' a') + ' été mis à jour sur Wikilivres.',
      icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">φ</text></svg>',
      tag: 'philo-updates'
    });
  } else if ('Notification' in window && Notification.permission !== 'denied') {
    // Request permission for next time
    Notification.requestPermission();
  }
  
  // Capacitor Local Notifications (Android)
  if (typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform && Capacitor.isNativePlatform()) {
    try {
      if (Capacitor.Plugins && Capacitor.Plugins.LocalNotifications) {
        Capacitor.Plugins.LocalNotifications.schedule({
          notifications: [{
            title: 'Mises à jour disponibles',
            body: count + ' article' + (count > 1 ? 's ont' : ' a') + ' été modifié' + (count > 1 ? 's' : '') + ' sur Wikilivres.',
            id: 1001,
            schedule: { at: new Date(Date.now() + 1000) },
            sound: null,
            smallIcon: 'ic_launcher',
            actionTypeId: 'OPEN_APP'
          }]
        });
      }
    } catch(e) { console.log('[Widget] Notification error:', e); }
  }
}

async function checkForUpdates() {
  if (updateCheckRunning) return;
  updateCheckRunning = true;
  
  var overlay = document.createElement('div');
  overlay.className = 'stats-overlay';
  overlay.id = 'updateOverlay';
  overlay.onclick = function(e) { if (e.target === overlay && !updateCheckRunning) overlay.remove(); };
  overlay.innerHTML = '<div class="stats-panel" style="max-width:460px;">' +
    '<h3>Vérification des mises à jour</h3>' +
    '<div id="updateStatus" style="text-align:center;padding:1rem 0;font-size:0.85rem;color:var(--muted);">⏳ Analyse des articles importés…</div>' +
    '<div class="reading-progress-bar" style="margin:0.5rem 0 1rem;"><div class="reading-progress-fill" id="updateProgressFill" style="width:0%;transition:width 0.2s;"></div></div>' +
    '<div id="updateResults"></div>' +
    '<div style="text-align:center;" id="updateActions"></div>' +
  '</div>';
  document.body.appendChild(overlay);
  
  var statusEl = document.getElementById('updateStatus');
  var fillEl = document.getElementById('updateProgressFill');
  var resultsEl = document.getElementById('updateResults');
  var actionsEl = document.getElementById('updateActions');
  
  // Collect wiki-sourced entries with their titles
  var wikiEntries = userEntries.filter(function(e) {
    return e._userEntry && (e._wikiTitle || e._wikiSource);
  });
  
  if (wikiEntries.length === 0) {
    statusEl.textContent = 'Aucun article importé depuis Wikilivres.';
    actionsEl.innerHTML = '<button class="stats-close" onclick="this.closest(\'.stats-overlay\').remove()">Fermer</button>';
    updateCheckRunning = false;
    return;
  }
  
  // Build title map: wikiTitle → entry
  // For entries without _wikiTitle, reconstruct it
  var titleMap = {};
  wikiEntries.forEach(function(e) {
    var title = e._wikiTitle || ('Dictionnaire de philosophie/' + e.term);
    titleMap[title] = e;
  });
  
  var titles = Object.keys(titleMap);
  var outdated = [];
  var checked = 0;
  var batchSize = 50;
  
  // Query API in batches of 50 (titles only, no content — fast)
  for (var b = 0; b < titles.length; b += batchSize) {
    var batch = titles.slice(b, b + batchSize);
    var pct = Math.round(((b + batch.length) / titles.length) * 100);
    statusEl.textContent = 'Vérification… ' + Math.min(b + batchSize, titles.length) + '/' + titles.length;
    fillEl.style.width = pct + '%';
    
    try {
      var data = await jsonp(
        'https://fr.wikibooks.org/w/api.php?action=query'
        + '&titles=' + encodeURIComponent(batch.join('|'))
        + '&prop=revisions&rvprop=ids|timestamp'
        + '&format=json&formatversion=2'
      );
      
      if (data.query && data.query.pages) {
        data.query.pages.forEach(function(page) {
          if (page.missing || !page.revisions || page.revisions.length === 0) return;
          var rev = page.revisions[0];
          var entry = titleMap[page.title];
          if (!entry) {
            // Try normalized title matching
            Object.keys(titleMap).forEach(function(k) {
              if (k.toLowerCase() === page.title.toLowerCase()) entry = titleMap[k];
            });
          }
          if (!entry) return;
          checked++;
          
          // Compare revision IDs
          if (entry._wikiRevId && rev.revid && rev.revid !== entry._wikiRevId) {
            outdated.push({
              entry: entry,
              title: page.title,
              oldRevId: entry._wikiRevId,
              newRevId: rev.revid,
              newTimestamp: rev.timestamp
            });
          } else if (!entry._wikiRevId) {
            // No stored revId → might be outdated, flag if imported long ago
            var importAge = entry._importDate ? (Date.now() - new Date(entry._importDate).getTime()) : Infinity;
            if (importAge > 30 * 86400000) { // > 30 days
              outdated.push({
                entry: entry,
                title: page.title,
                oldRevId: null,
                newRevId: rev.revid,
                newTimestamp: rev.timestamp,
                uncertain: true
              });
            }
          }
        });
      }
    } catch (e) {
      console.log('Update check batch failed:', e.message);
    }
    
    await new Promise(function(r) { setTimeout(r, 100); });
  }
  
  fillEl.style.width = '100%';
  updateCheckRunning = false;
  
  if (outdated.length === 0) {
    statusEl.innerHTML = '✓ Tous les articles sont à jour (' + checked + ' vérifiés)';
    pendingUpdatesCount = 0;
    PhiloDB.set('philo-pending-updates', '0');
    try { localStorage.setItem('philo-pending-updates', '0'); } catch(e) {}
    actionsEl.innerHTML = '<button class="stats-close" onclick="this.closest(\'.stats-overlay\').remove()">Fermer</button>';
    // Store check date
    PhiloDB.set('philo-last-update-check', new Date().toISOString());
    try { localStorage.setItem('philo-last-update-check', new Date().toISOString()); } catch(e) {}
    return;
  }
  
  // Show outdated articles
  var certain = outdated.filter(function(o) { return !o.uncertain; });
  var uncertain = outdated.filter(function(o) { return o.uncertain; });
  
  statusEl.innerHTML = '<strong>' + certain.length + ' article' + (certain.length > 1 ? 's' : '') + 
    ' modifié' + (certain.length > 1 ? 's' : '') + ' sur Wikilivres</strong>' +
    (uncertain.length > 0 ? '<br><span style="font-size:0.75rem;color:var(--muted-light);">+ ' + uncertain.length + ' sans version connue (importés il y a plus de 30 jours)</span>' : '');
  
  resultsEl.innerHTML = '<div style="max-height:200px;overflow-y:auto;margin:0.75rem 0;">' +
    outdated.map(function(o) {
      var dateStr = o.newTimestamp ? new Date(o.newTimestamp).toLocaleDateString('fr-FR') : '?';
      return '<div style="display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0.5rem;border-bottom:1px solid var(--border-light);">' +
        '<input type="checkbox" checked data-update-id="' + o.entry.id + '" data-update-title="' + o.title + '" style="accent-color:var(--accent);">' +
        '<span style="flex:1;font-size:0.82rem;color:var(--ink);">' + escapeHtml(o.entry.term) + '</span>' +
        '<span style="font-family:var(--mono);font-size:0.45rem;color:var(--muted-light);">' + dateStr + '</span>' +
        (o.uncertain ? '<span style="font-family:var(--mono);font-size:0.4rem;color:var(--gold);">?</span>' : '') +
      '</div>';
    }).join('') + '</div>';
  
  actionsEl.innerHTML = '<button class="stats-close" style="background:var(--accent);color:var(--paper);border-color:var(--accent);margin-right:0.5rem;" ' +
    'onclick="updateSelectedArticles()">Mettre à jour (' + outdated.length + ')</button>' +
    '<button class="stats-close" onclick="this.closest(\'.stats-overlay\').remove()">Annuler</button>';
}

async function updateSelectedArticles() {
  var checkboxes = document.querySelectorAll('[data-update-id]:checked');
  if (checkboxes.length === 0) return;
  
  var statusEl = document.getElementById('updateStatus');
  var fillEl = document.getElementById('updateProgressFill');
  var resultsEl = document.getElementById('updateResults');
  var actionsEl = document.getElementById('updateActions');
  
  actionsEl.innerHTML = '';
  fillEl.style.width = '0%';
  
  var toUpdate = [];
  checkboxes.forEach(function(cb) {
    toUpdate.push({ id: cb.getAttribute('data-update-id'), title: cb.getAttribute('data-update-title') });
  });
  
  var updated = 0;
  var failed = 0;
  
  for (var i = 0; i < toUpdate.length; i++) {
    var item = toUpdate[i];
    var pct = Math.round(((i + 1) / toUpdate.length) * 100);
    statusEl.textContent = 'Mise à jour ' + (i + 1) + '/' + toUpdate.length + '…';
    fillEl.style.width = pct + '%';
    
    try {
      var data = await jsonp(
        'https://fr.wikibooks.org/w/api.php?action=query'
        + '&titles=' + encodeURIComponent(item.title)
        + '&prop=revisions&rvprop=content|ids|timestamp&rvslots=main'
        + '&format=json&formatversion=2'
      );
      
      var page = data.query && data.query.pages && data.query.pages[0];
      if (page && !page.missing && page.revisions && page.revisions.length > 0) {
        var rev = page.revisions[0];
        var wikitext = cleanWikitext(rev.slots && rev.slots.main && rev.slots.main.content || '');
        if (wikitext.length > 50) {
          var parsed = parseMediaWiki(wikitext);
          var defMatch = parsed.html.match(/<p>([\s\S]*?)<\/p>/);
          var definition = defMatch ? defMatch[1].replace(/<[^>]+>/g, '').substring(0, 300) : '';
          
          // Find and update the entry
          var entryIdx = userEntries.findIndex(function(e) { return e.id === item.id; });
          if (entryIdx >= 0) {
            userEntries[entryIdx].content = parsed.html;
            userEntries[entryIdx].definition = definition;
            userEntries[entryIdx].refs = parsed.refs;
            userEntries[entryIdx].tags = guessTags(wikitext).split(', ').filter(Boolean);
            userEntries[entryIdx].category = guessCategory(wikitext, userEntries[entryIdx].term);
            userEntries[entryIdx]._wikiSource = wikitext;
            userEntries[entryIdx]._wikiRevId = rev.revid || null;
            userEntries[entryIdx]._wikiTimestamp = rev.timestamp || null;
            userEntries[entryIdx]._wikiTitle = item.title;
            userEntries[entryIdx]._importDate = new Date().toISOString();
            updated++;
          }
        }
      }
    } catch (e) {
      failed++;
    }
    
    await new Promise(function(r) { setTimeout(r, 150); });
  }
  
  // Save
  saveUserEntries();
  PhiloDB.set('philo-last-update-check', new Date().toISOString());
  try { localStorage.setItem('philo-last-update-check', new Date().toISOString()); } catch(e) {}
  
  fillEl.style.width = '100%';
  pendingUpdatesCount = 0;
  PhiloDB.set('philo-pending-updates', '0');
  try { localStorage.setItem('philo-pending-updates', '0'); } catch(e) {}
  statusEl.innerHTML = '✓ ' + updated + ' article' + (updated > 1 ? 's' : '') + ' mis à jour' +
    (failed > 0 ? ' (' + failed + ' échec' + (failed > 1 ? 's' : '') + ')' : '');
  resultsEl.innerHTML = '';
  actionsEl.innerHTML = '<button class="stats-close" onclick="this.closest(\'.stats-overlay\').remove();showWelcome();">Fermer</button>';
}

// ===== START =====
init();
</script>
</body>
</html>
